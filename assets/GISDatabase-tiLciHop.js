import{l as E,e as O,j as g,i as N}from"./MapViewer-k49t5Gix.js";const v="vcap2-protected-areas",T=1,l="areas",d="index";let p=null;function m(){return p?Promise.resolve(p):new Promise((t,e)=>{const a=indexedDB.open(v,T);a.onupgradeneeded=n=>{const s=n.target.result;s.objectStoreNames.contains(l)||s.createObjectStore(l,{keyPath:"id"}),s.objectStoreNames.contains(d)||s.createObjectStore(d,{keyPath:"id"})},a.onsuccess=()=>{p=a.result,t(p)},a.onerror=()=>e(a.error)})}function k(){return`pa_${Date.now()}_${Math.random().toString(36).slice(2,9)}`}function w(t){return{id:t.id,name:t.name,type:t.type,status:t.status,island:t.island,province:t.province,areaHa:t.areaHa,createdAt:t.createdAt,updatedAt:t.updatedAt}}async function F(){const t=await m();return new Promise((e,a)=>{const s=t.transaction(d,"readonly").objectStore(d).getAll();s.onsuccess=()=>{const c=s.result;c.sort((o,r)=>new Date(r.updatedAt).getTime()-new Date(o.updatedAt).getTime()),e(c)},s.onerror=()=>a(s.error)})}async function b(t){const e=await m();return new Promise((a,n)=>{const c=e.transaction(l,"readonly").objectStore(l).get(t);c.onsuccess=()=>a(c.result??null),c.onerror=()=>n(c.error)})}async function L(t){const e=k(),a=new Date().toISOString(),n={id:e,name:t.name,type:t.type,status:t.status,description:t.description,island:t.island,province:t.province,areaHa:t.areaHa,designatedDate:t.designatedDate,managementAuthority:t.managementAuthority,boundary:t.boundary,attachments:[],createdAt:a,updatedAt:a},s=await m();return await new Promise((c,o)=>{const r=s.transaction([l,d],"readwrite");r.objectStore(l).put(n),r.objectStore(d).put(w(n)),r.oncomplete=()=>c(),r.onerror=()=>o(r.error)}),n}async function Y(t,e){const a=await b(t);if(!a)return null;Object.assign(a,e),a.updatedAt=new Date().toISOString();const n=await m();return await new Promise((s,c)=>{const o=n.transaction([l,d],"readwrite");o.objectStore(l).put(a),o.objectStore(d).put(w(a)),o.oncomplete=()=>s(),o.onerror=()=>c(o.error)}),a}async function z(t){const e=await m();return await new Promise((n,s)=>{const o=e.transaction(d,"readonly").objectStore(d).get(t);o.onsuccess=()=>n(o.result!=null),o.onerror=()=>s(o.error)})?(await new Promise((n,s)=>{const c=e.transaction([l,d],"readwrite");c.objectStore(l).delete(t),c.objectStore(d).delete(t),c.oncomplete=()=>n(),c.onerror=()=>s(c.error)}),!0):!1}async function K(t,e){const a=await b(t);if(!a)return null;const n=await new Promise(o=>{const r=new FileReader;r.onload=()=>o(r.result),r.readAsDataURL(e)}),s={id:`att_${Date.now()}_${Math.random().toString(36).slice(2,7)}`,name:e.name,mimeType:e.type,sizeBytes:e.size,data:n};a.attachments.push(s),a.updatedAt=new Date().toISOString();const c=await m();return await new Promise((o,r)=>{const i=c.transaction([l,d],"readwrite");i.objectStore(l).put(a),i.objectStore(d).put(w(a)),i.oncomplete=()=>o(),i.onerror=()=>r(i.error)}),a}async function W(t,e){const a=await b(t);if(!a)return null;a.attachments=a.attachments.filter(s=>s.id!==e),a.updatedAt=new Date().toISOString();const n=await m();return await new Promise((s,c)=>{const o=n.transaction([l,d],"readwrite");o.objectStore(l).put(a),o.objectStore(d).put(w(a)),o.oncomplete=()=>s(),o.onerror=()=>c(o.error)}),a}async function R(){const t=await m();return new Promise((e,a)=>{const s=t.transaction(l,"readonly").objectStore(l).getAll();s.onsuccess=()=>e(s.result),s.onerror=()=>a(s.error)})}async function B(t){let e=0,a=0;const n=await m();for(const s of t){if(await new Promise((o,r)=>{const u=n.transaction(d,"readonly").objectStore(d).get(s.id);u.onsuccess=()=>o(u.result!=null),u.onerror=()=>r(u.error)})){a++;continue}await new Promise((o,r)=>{const i=n.transaction([l,d],"readwrite");i.objectStore(l).put(s),i.objectStore(d).put(w(s)),i.oncomplete=()=>o(),i.onerror=()=>r(i.error)}),e++}return{imported:e,skipped:a}}async function A(t,e){const a=await m(),n=await new Promise((s,c)=>{const r=a.transaction(l,"readonly").objectStore(l).get(t);r.onsuccess=()=>s(r.result??null),r.onerror=()=>c(r.error)});n&&(n.githubSha=e,await new Promise((s,c)=>{const o=a.transaction([l,d],"readwrite");o.objectStore(l).put(n),o.objectStore(d).put(w(n)),o.oncomplete=()=>s(),o.onerror=()=>c(o.error)}))}function V(t){const e=document.createElement("a");e.href=t.data,e.download=t.name,e.click()}function X(t){return t==null?"N/A":t>=100?`${t.toLocaleString()} ha`:`${t.toFixed(1)} ha`}const x="vcap2_github_sync",$="vcap2_github_pa_sync",D="gis-datasets",I="protected-areas",H="https://api.github.com";function Q(){return{owner:"welinrj",repo:"merremia-vanuatu-dashboard",token:"",branch:"main"}}function j(){try{const t=localStorage.getItem(x);return t?JSON.parse(t):{lastSync:null,syncing:!1}}catch{return{lastSync:null,syncing:!1}}}function y(t){try{localStorage.setItem(x,JSON.stringify(t))}catch{}}async function S(t,e,a={}){const n=`${H}/repos/${e.owner}/${e.repo}/contents/${t}${e.branch?`?ref=${e.branch}`:""}`,s={Accept:"application/vnd.github.v3+json","Content-Type":"application/json",...a.headers??{}};return e.token&&(s.Authorization=`Bearer ${e.token}`),fetch(n,{...a,headers:s})}async function J(t){const e=await S(D,t);if(e.status===404)return[];if(!e.ok)throw new Error(`GitHub API error ${e.status}: ${await e.text()}`);const a=await e.json();return Array.isArray(a)?a.filter(n=>n.name.endsWith(".json")).map(n=>({name:n.name,sha:n.sha,download_url:n.download_url})):[]}async function q(t){const e=await fetch(t);if(!e.ok)throw new Error(`Failed to download dataset: ${e.status}`);return e.json()}async function C(t,e,a){const n=`${D}/${t.id}.json`,s=btoa(unescape(encodeURIComponent(JSON.stringify(t,null,2)))),c={message:`Sync dataset: ${t.metadata.name}`,content:s,branch:e.branch||"main"},o=await S(n,e,{method:"PUT",body:JSON.stringify(c)});if(!o.ok){const i=await o.text();throw new Error(`Failed to push dataset "${t.metadata.name}": ${o.status} ${i}`)}return(await o.json()).content.sha}async function Z(t){const e={pushed:0,pulled:0,errors:[]};y({lastSync:j().lastSync,syncing:!0});try{const a=await E(),n=new Set(a.map(r=>r.id)),s=await J(t),c=new Map(s.map(r=>[r.name.replace(".json",""),r])),o=await O();for(const r of o){const i=c.get(r.id);if(i)(!r.githubSha||r.githubSha!==i.sha)&&await g(r.id,i.sha);else try{const u=await C(r,t);await g(r.id,u),e.pushed++}catch(u){e.errors.push(u instanceof Error?u.message:`Push failed for ${r.id}`)}}for(const[r,i]of c)if(!n.has(r))try{const u=await q(i.download_url);u.githubSha=i.sha;const{imported:h}=await N([u]);h>0&&e.pulled++}catch(u){e.errors.push(u instanceof Error?u.message:`Pull failed for ${r}`)}y({lastSync:new Date().toISOString(),syncing:!1})}catch(a){y({lastSync:j().lastSync,syncing:!1}),e.errors.push(a instanceof Error?a.message:"Sync failed")}return e}function P(){try{const t=localStorage.getItem($);return t?JSON.parse(t):{lastSync:null,syncing:!1}}catch{return{lastSync:null,syncing:!1}}}function f(t){try{localStorage.setItem($,JSON.stringify(t))}catch{}}async function M(t){const e=await S(I,t);if(e.status===404)return[];if(!e.ok)throw new Error(`GitHub API error ${e.status}: ${await e.text()}`);const a=await e.json();return Array.isArray(a)?a.filter(n=>n.name.endsWith(".json")).map(n=>({name:n.name,sha:n.sha,download_url:n.download_url})):[]}async function U(t,e,a){const n=`${I}/${t.id}.json`,s=btoa(unescape(encodeURIComponent(JSON.stringify(t,null,2)))),c={message:`Sync protected area: ${t.name}`,content:s,branch:e.branch||"main"},o=await S(n,e,{method:"PUT",body:JSON.stringify(c)});if(!o.ok){const i=await o.text();throw new Error(`Failed to push area "${t.name}": ${o.status} ${i}`)}return(await o.json()).content.sha}async function tt(t){const e={pushed:0,pulled:0,errors:[]};f({lastSync:P().lastSync,syncing:!0});try{const a=await F(),n=new Set(a.map(r=>r.id)),s=await M(t),c=new Map(s.map(r=>[r.name.replace(".json",""),r])),o=await R();for(const r of o){const i=c.get(r.id);if(i)(!r.githubSha||r.githubSha!==i.sha)&&await A(r.id,i.sha);else try{const u=await U(r,t);await A(r.id,u),e.pushed++}catch(u){e.errors.push(u instanceof Error?u.message:`Push failed for ${r.id}`)}}for(const[r,i]of c)if(!n.has(r))try{const u=await fetch(i.download_url);if(!u.ok)throw new Error(`Failed to download area: ${u.status}`);const h=await u.json();h.githubSha=i.sha;const{imported:_}=await B([h]);_>0&&e.pulled++}catch(u){e.errors.push(u instanceof Error?u.message:`Pull failed for ${r}`)}f({lastSync:new Date().toISOString(),syncing:!1})}catch(a){f({lastSync:P().lastSync,syncing:!1}),e.errors.push(a instanceof Error?a.message:"Sync failed")}return e}export{Q as a,P as b,b as c,L as d,tt as e,X as f,j as g,z as h,V as i,K as j,F as l,W as r,Z as s,Y as u};
