import{r as l,j as t}from"./app-BACuaSRr.js";import{l as Q,b as q,f as m,M as K,m as Y,i as _,e as W,g as U,d as X}from"./MapViewer-CosjcAVy.js";import{g as Z,a as N,s as v,d as tt}from"./GISDatabase-DHMrp1px.js";import{D as et}from"./DatasetUpload-CVjx_Wee.js";/* empty css                   */const it=({onNavigate:w})=>{const[O,b]=l.useState("browse"),[c,R]=l.useState([]),[$,E]=l.useState(!0),[x,F]=l.useState(null),[u,G]=l.useState(null),[S,j]=l.useState(null),[r,f]=l.useState(null),[D,d]=l.useState(""),g=l.useRef(null),[k,C]=l.useState(!1),[L,p]=l.useState(""),[I,y]=l.useState(null);l.useEffect(()=>{const e=Z();y(e.lastSync)},[]);const h=l.useCallback(async()=>{const e=await Q();R(e);const s=await q();s&&(F(s.used),G(s.quota))},[]);l.useEffect(()=>{let e=!1;async function s(){await Y();try{const a=N();if(a.token){const n=await v(a);!e&&(n.pulled>0||n.pushed>0)&&y(new Date().toISOString())}}catch{}e||(await h(),E(!1))}return s(),()=>{e=!0}},[h]);const B=c.reduce((e,s)=>e+s.featureCount,0),A=c.reduce((e,s)=>e+s.sizeBytes,0);async function z(e){if(S===e){j(null),f(null);return}j(e);const s=await U(e);f(s)}function J(){const e=N();e.token&&v(e).then(s=>{(s.pushed>0||s.pulled>0)&&y(new Date().toISOString())}).catch(()=>{})}async function T(e){const s=c.find(n=>n.id===e);if(!window.confirm(`Delete "${s?.metadata.name}"? This cannot be undone.`))return;await X(e);const a=N();a.token&&tt(e,a).catch(()=>{}),S===e&&(j(null),f(null)),await h()}async function M(){const e=await W(),s=JSON.stringify(e,null,2),a=new Blob([s],{type:"application/json"}),n=URL.createObjectURL(a),i=document.createElement("a");i.href=n,i.download=`vcap2-gis-backup-${new Date().toISOString().slice(0,10)}.json`,i.click(),URL.revokeObjectURL(n)}async function P(e){const s=e.target.files?.[0];if(s){d("Importing...");try{const a=await s.text(),n=JSON.parse(a);let i;if(Array.isArray(n))i=n;else if(n.type==="FeatureCollection"||n.type==="Feature"||n.coordinates){d('This is a GIS file — use the "Upload Dataset" button to add it to the database.');return}else{d("Invalid backup file format.");return}const o=await _(i);await h(),d(`Imported ${o.imported} dataset${o.imported!==1?"s":""}`+(o.skipped>0?`, ${o.skipped} already existed`:""))}catch{d("Failed to import — invalid file format.")}g.current&&(g.current.value="")}}async function H(e){const s=await U(e);if(!s)return;const a=JSON.stringify(s.data,null,2),n=new Blob([a],{type:"application/geo+json"}),i=URL.createObjectURL(n),o=document.createElement("a");o.href=i,o.download=`${s.metadata.name.replace(/\s+/g,"_")}.geojson`,o.click(),URL.revokeObjectURL(i)}async function V(){const e=N();if(!e.token){p("No GitHub token configured — cannot sync");return}C(!0),p("Syncing with GitHub...");try{const s=await v(e);await h();const a=[];s.pushed>0&&a.push(`${s.pushed} pushed`),s.pulled>0&&a.push(`${s.pulled} pulled`),s.errors.length>0&&a.push(`${s.errors.length} error${s.errors.length!==1?"s":""}: ${s.errors.join("; ")}`),a.length===0&&a.push("Already in sync"),p(a.join(", ")),y(new Date().toISOString())}catch(s){p(s instanceof Error?s.message:"Sync failed")}finally{C(!1)}}return $?t.jsx("div",{className:"data-portal",children:t.jsx("div",{className:"portal-toolbar",children:t.jsxs("div",{className:"portal-toolbar-left",children:[t.jsx("h2",{children:"GIS Database"}),t.jsx("span",{className:"dataset-count",children:"Loading..."})]})})}):O==="upload"?t.jsx("div",{className:"data-portal",children:t.jsx(et,{onUploaded:async()=>{J(),await h(),b("browse"),d("Dataset uploaded and stored to database.")},onCancel:()=>b("browse")})}):t.jsxs("div",{className:"data-portal",children:[t.jsxs("div",{className:"portal-toolbar",children:[t.jsxs("div",{className:"portal-toolbar-left",children:[t.jsx("h2",{children:"GIS Database"}),t.jsxs("span",{className:"dataset-count",children:[c.length," dataset",c.length!==1?"s":""," stored"]})]}),t.jsxs("div",{className:"portal-toolbar-right",children:[t.jsx("input",{ref:g,type:"file",accept:".json",onChange:P,hidden:!0}),t.jsx("button",{className:"btn btn-secondary",onClick:()=>g.current?.click(),children:"Restore Backup"}),t.jsx("button",{className:"btn btn-secondary",onClick:M,disabled:c.length===0,children:"Export Backup"}),t.jsx("button",{className:"btn btn-primary",onClick:()=>b("upload"),children:"Upload Dataset"})]})]}),D&&t.jsxs("div",{className:"db-import-status",role:"status",children:[D,t.jsx("button",{className:"db-dismiss",onClick:()=>d(""),"aria-label":"Dismiss",children:"×"})]}),t.jsxs("div",{className:"db-stats-grid",children:[t.jsxs("div",{className:"db-stat-card",children:[t.jsx("span",{className:"db-stat-value",children:c.length}),t.jsx("span",{className:"db-stat-label",children:"Datasets"})]}),t.jsxs("div",{className:"db-stat-card",children:[t.jsx("span",{className:"db-stat-value",children:B.toLocaleString()}),t.jsx("span",{className:"db-stat-label",children:"Total Features"})]}),t.jsxs("div",{className:"db-stat-card",children:[t.jsx("span",{className:"db-stat-value",children:m(A)}),t.jsx("span",{className:"db-stat-label",children:"Data Size"})]}),t.jsxs("div",{className:"db-stat-card",children:[t.jsx("span",{className:"db-stat-value",children:u?m(u-(x??0)):"N/A"}),t.jsx("span",{className:"db-stat-label",children:"Storage Available"})]})]}),x!=null&&u!=null&&u>0&&t.jsxs("div",{className:"db-storage-bar-container",children:[t.jsx("div",{className:"db-storage-bar",children:t.jsx("div",{className:"db-storage-bar-fill",style:{width:`${Math.min(x/u*100,100)}%`}})}),t.jsxs("span",{className:"db-storage-text",children:[m(x)," of ",m(u)," used"]})]}),t.jsxs("div",{className:"db-sync-section",children:[t.jsxs("div",{className:"db-sync-row",children:[t.jsxs("div",{className:"db-sync-info",children:[t.jsx("strong",{children:"GitHub Sync"}),I&&t.jsxs("span",{className:"db-sync-last",children:["Last sync: ",new Date(I).toLocaleString()]})]}),t.jsx("div",{className:"db-sync-actions",children:t.jsx("button",{className:"btn btn-sm btn-primary",onClick:V,disabled:k,children:k?"Syncing...":"Sync Now"})})]}),L&&t.jsxs("div",{className:"db-sync-status",role:"status",children:[L,t.jsx("button",{className:"db-dismiss",onClick:()=>p(""),"aria-label":"Dismiss",children:"×"})]})]}),c.length===0?t.jsxs("div",{className:"portal-empty",children:[t.jsx("p",{children:"No datasets in the database yet."}),t.jsxs("p",{style:{fontSize:"0.85rem",marginTop:"0.5rem"},children:["Click ",t.jsx("strong",{children:"Upload Dataset"})," to add GIS files (GeoJSON, CSV, KML), or use ",t.jsx("strong",{children:"Restore Backup"})," to import a previous export."]}),t.jsxs("div",{style:{display:"flex",gap:"0.5rem",justifyContent:"center",marginTop:"1rem"},children:[t.jsx("button",{className:"btn btn-primary",onClick:()=>b("upload"),children:"Upload Your First Dataset"}),w&&t.jsx("button",{className:"btn btn-secondary",onClick:()=>w("data-portal"),children:"Go to Data Portal"})]})]}):t.jsx("div",{className:"table-container",children:t.jsxs("table",{className:"data-table",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"Name"}),t.jsx("th",{children:"Format"}),t.jsx("th",{children:"Features"}),t.jsx("th",{children:"Size"}),t.jsx("th",{children:"Status"}),t.jsx("th",{children:"Stored"}),t.jsx("th",{children:"Actions"})]})}),t.jsx("tbody",{children:c.map(e=>t.jsxs("tr",{className:S===e.id?"db-row-selected":"",children:[t.jsxs("td",{children:[t.jsx("button",{className:"link-button",onClick:()=>z(e.id),children:e.metadata.name}),e.metadata.description&&t.jsx("span",{className:"dataset-description",children:e.metadata.description})]}),t.jsx("td",{children:t.jsx("span",{className:"badge badge-format",children:e.format.toUpperCase()})}),t.jsx("td",{children:e.featureCount.toLocaleString()}),t.jsx("td",{children:m(e.sizeBytes)}),t.jsx("td",{children:t.jsx("span",{className:`badge badge-${e.metadata.status}`,children:e.metadata.status})}),t.jsx("td",{children:new Date(e.createdAt).toLocaleDateString()}),t.jsx("td",{children:t.jsxs("div",{className:"action-buttons",children:[t.jsx("button",{className:"btn btn-sm",onClick:()=>H(e.id),title:"Download as GeoJSON",children:"Download"}),t.jsx("button",{className:"btn btn-sm btn-danger",onClick:()=>T(e.id),title:"Delete from database",children:"Delete"})]})})]},e.id))})]})}),r&&t.jsxs("div",{className:"db-preview",children:[t.jsxs("div",{className:"db-preview-header",children:[t.jsxs("h3",{children:["Preview: ",r.metadata.name]}),t.jsx("button",{className:"btn btn-sm",onClick:()=>{j(null),f(null)},children:"Close"})]}),t.jsxs("div",{className:"db-preview-meta",children:[t.jsxs("span",{children:[r.featureCount," features"]}),t.jsx("span",{children:r.format.toUpperCase()}),t.jsx("span",{children:m(r.sizeBytes)}),r.bbox&&t.jsxs("span",{children:["Bbox: [",r.bbox.map(e=>e.toFixed(2)).join(", "),"]"]})]}),t.jsx(K,{data:r.data,height:"350px"})]})]})};export{it as default};
