import{l as O,e as N,j as y,i as R}from"./MapViewer-CosjcAVy.js";const T="vcap2-protected-areas",F=1,l="areas",d="index";let S=null;function h(){return S?Promise.resolve(S):new Promise((t,e)=>{const a=indexedDB.open(T,F);a.onupgradeneeded=n=>{const s=n.target.result;s.objectStoreNames.contains(l)||s.createObjectStore(l,{keyPath:"id"}),s.objectStoreNames.contains(d)||s.createObjectStore(d,{keyPath:"id"})},a.onsuccess=()=>{S=a.result,t(S)},a.onerror=()=>e(a.error)})}function v(){return`pa_${Date.now()}_${Math.random().toString(36).slice(2,9)}`}function m(t){return{id:t.id,name:t.name,type:t.type,status:t.status,island:t.island,province:t.province,areaHa:t.areaHa,createdAt:t.createdAt,updatedAt:t.updatedAt}}async function H(){const t=await h();return new Promise((e,a)=>{const s=t.transaction(d,"readonly").objectStore(d).getAll();s.onsuccess=()=>{const c=s.result;c.sort((o,r)=>new Date(r.updatedAt).getTime()-new Date(o.updatedAt).getTime()),e(c)},s.onerror=()=>a(s.error)})}async function A(t){const e=await h();return new Promise((a,n)=>{const c=e.transaction(l,"readonly").objectStore(l).get(t);c.onsuccess=()=>a(c.result??null),c.onerror=()=>n(c.error)})}async function U(t){const e=v(),a=new Date().toISOString(),n={id:e,name:t.name,type:t.type,status:t.status,description:t.description,island:t.island,province:t.province,areaHa:t.areaHa,designatedDate:t.designatedDate,managementAuthority:t.managementAuthority,boundary:t.boundary,attachments:[],createdAt:a,updatedAt:a},s=await h();return await new Promise((c,o)=>{const r=s.transaction([l,d],"readwrite");r.objectStore(l).put(n),r.objectStore(d).put(m(n)),r.oncomplete=()=>c(),r.onerror=()=>o(r.error)}),n}async function Y(t,e){const a=await A(t);if(!a)return null;Object.assign(a,e),a.updatedAt=new Date().toISOString();const n=await h();return await new Promise((s,c)=>{const o=n.transaction([l,d],"readwrite");o.objectStore(l).put(a),o.objectStore(d).put(m(a)),o.oncomplete=()=>s(),o.onerror=()=>c(o.error)}),a}async function z(t){const e=await h();return await new Promise((n,s)=>{const o=e.transaction(d,"readonly").objectStore(d).get(t);o.onsuccess=()=>n(o.result!=null),o.onerror=()=>s(o.error)})?(await new Promise((n,s)=>{const c=e.transaction([l,d],"readwrite");c.objectStore(l).delete(t),c.objectStore(d).delete(t),c.oncomplete=()=>n(),c.onerror=()=>s(c.error)}),!0):!1}async function K(t,e){const a=await A(t);if(!a)return null;const n=await new Promise(o=>{const r=new FileReader;r.onload=()=>o(r.result),r.readAsDataURL(e)}),s={id:`att_${Date.now()}_${Math.random().toString(36).slice(2,7)}`,name:e.name,mimeType:e.type,sizeBytes:e.size,data:n};a.attachments.push(s),a.updatedAt=new Date().toISOString();const c=await h();return await new Promise((o,r)=>{const u=c.transaction([l,d],"readwrite");u.objectStore(l).put(a),u.objectStore(d).put(m(a)),u.oncomplete=()=>o(),u.onerror=()=>r(u.error)}),a}async function W(t,e){const a=await A(t);if(!a)return null;a.attachments=a.attachments.filter(s=>s.id!==e),a.updatedAt=new Date().toISOString();const n=await h();return await new Promise((s,c)=>{const o=n.transaction([l,d],"readwrite");o.objectStore(l).put(a),o.objectStore(d).put(m(a)),o.oncomplete=()=>s(),o.onerror=()=>c(o.error)}),a}async function J(){const t=await h();return new Promise((e,a)=>{const s=t.transaction(l,"readonly").objectStore(l).getAll();s.onsuccess=()=>e(s.result),s.onerror=()=>a(s.error)})}async function B(t){let e=0,a=0;const n=await h();for(const s of t){if(await new Promise((o,r)=>{const i=n.transaction(d,"readonly").objectStore(d).get(s.id);i.onsuccess=()=>o(i.result!=null),i.onerror=()=>r(i.error)})){a++;continue}await new Promise((o,r)=>{const u=n.transaction([l,d],"readwrite");u.objectStore(l).put(s),u.objectStore(d).put(m(s)),u.oncomplete=()=>o(),u.onerror=()=>r(u.error)}),e++}return{imported:e,skipped:a}}async function f(t,e){const a=await h(),n=await new Promise((s,c)=>{const r=a.transaction(l,"readonly").objectStore(l).get(t);r.onsuccess=()=>s(r.result??null),r.onerror=()=>c(r.error)});n&&(n.githubSha=e,await new Promise((s,c)=>{const o=a.transaction([l,d],"readwrite");o.objectStore(l).put(n),o.objectStore(d).put(m(n)),o.oncomplete=()=>s(),o.onerror=()=>c(o.error)}))}function V(t){const e=document.createElement("a");e.href=t.data,e.download=t.name,e.click()}function X(t){return t==null?"N/A":t>=100?`${t.toLocaleString()} ha`:`${t.toFixed(1)} ha`}const I="vcap2_github_sync",_="vcap2_github_pa_sync",$="gis-datasets",j="protected-areas",q="https://api.github.com";function Q(){return{owner:"welinrj",repo:"merremia-vanuatu-dashboard",token:"",branch:"main"}}function P(){try{const t=localStorage.getItem(I);return t?JSON.parse(t):{lastSync:null,syncing:!1}}catch{return{lastSync:null,syncing:!1}}}function b(t){try{localStorage.setItem(I,JSON.stringify(t))}catch{}}async function w(t,e,a={}){const n=`${q}/repos/${e.owner}/${e.repo}/contents/${t}${e.branch?`?ref=${e.branch}`:""}`,s={Accept:"application/vnd.github.v3+json","Content-Type":"application/json",...a.headers??{}};return e.token&&(s.Authorization=`Bearer ${e.token}`),fetch(n,{...a,headers:s})}async function G(t){const e=await w($,t);if(e.status===404)return[];if(!e.ok)throw new Error(`GitHub API error ${e.status}: ${await e.text()}`);const a=await e.json();return Array.isArray(a)?a.filter(n=>n.name.endsWith(".json")).map(n=>({name:n.name,sha:n.sha,download_url:n.download_url})):[]}async function L(t){const e=await fetch(t);if(!e.ok)throw new Error(`Failed to download dataset: ${e.status}`);return e.json()}async function E(t,e,a){const n=`${$}/${t.id}.json`,s=btoa(unescape(encodeURIComponent(JSON.stringify(t,null,2)))),c={message:`Sync dataset: ${t.metadata.name}`,content:s,branch:e.branch||"main"};a&&(c.sha=a);const o=await w(n,e,{method:"PUT",body:JSON.stringify(c)});if(!o.ok){const u=await o.text();throw new Error(`Failed to push dataset "${t.metadata.name}": ${o.status} ${u}`)}return(await o.json()).content.sha}async function Z(t){const e={pushed:0,pulled:0,errors:[]};b({lastSync:P().lastSync,syncing:!0});try{const a=await O(),n=new Set(a.map(r=>r.id)),s=await G(t),c=new Map(s.map(r=>[r.name.replace(".json",""),r])),o=await N();for(const r of o){const u=c.get(r.id);if(u){if(!r.githubSha||r.githubSha!==u.sha)if(t.token&&r.githubSha&&r.githubSha!==u.sha)await y(r.id,u.sha);else if(t.token&&!r.githubSha)try{const i=await E(r,t,u.sha);await y(r.id,i),e.pushed++}catch(i){e.errors.push(i instanceof Error?i.message:`Push failed for ${r.id}`)}else await y(r.id,u.sha)}else{if(!t.token)continue;try{const i=await E(r,t);await y(r.id,i),e.pushed++}catch(i){e.errors.push(i instanceof Error?i.message:`Push failed for ${r.id}`)}}}for(const[r,u]of c)if(!n.has(r))try{const i=await L(u.download_url);i.githubSha=u.sha;const{imported:p}=await R([i]);p>0&&e.pulled++}catch(i){e.errors.push(i instanceof Error?i.message:`Pull failed for ${r}`)}b({lastSync:new Date().toISOString(),syncing:!1})}catch(a){b({lastSync:P().lastSync,syncing:!1}),e.errors.push(a instanceof Error?a.message:"Sync failed")}return e}function D(){try{const t=localStorage.getItem(_);return t?JSON.parse(t):{lastSync:null,syncing:!1}}catch{return{lastSync:null,syncing:!1}}}function g(t){try{localStorage.setItem(_,JSON.stringify(t))}catch{}}async function C(t){const e=await w(j,t);if(e.status===404)return[];if(!e.ok)throw new Error(`GitHub API error ${e.status}: ${await e.text()}`);const a=await e.json();return Array.isArray(a)?a.filter(n=>n.name.endsWith(".json")).map(n=>({name:n.name,sha:n.sha,download_url:n.download_url})):[]}async function x(t,e,a){const n=`${j}/${t.id}.json`,s=btoa(unescape(encodeURIComponent(JSON.stringify(t,null,2)))),c={message:`Sync protected area: ${t.name}`,content:s,branch:e.branch||"main"};a&&(c.sha=a);const o=await w(n,e,{method:"PUT",body:JSON.stringify(c)});if(!o.ok){const u=await o.text();throw new Error(`Failed to push area "${t.name}": ${o.status} ${u}`)}return(await o.json()).content.sha}async function tt(t){const e={pushed:0,pulled:0,errors:[]};g({lastSync:D().lastSync,syncing:!0});try{const a=await H(),n=new Set(a.map(r=>r.id)),s=await C(t),c=new Map(s.map(r=>[r.name.replace(".json",""),r])),o=await J();for(const r of o){const u=c.get(r.id);if(u){if(!r.githubSha||r.githubSha!==u.sha)if(t.token&&r.githubSha&&r.githubSha!==u.sha)await f(r.id,u.sha);else if(t.token&&!r.githubSha)try{const i=await x(r,t,u.sha);await f(r.id,i),e.pushed++}catch(i){e.errors.push(i instanceof Error?i.message:`Push failed for ${r.id}`)}else await f(r.id,u.sha)}else{if(!t.token)continue;try{const i=await x(r,t);await f(r.id,i),e.pushed++}catch(i){e.errors.push(i instanceof Error?i.message:`Push failed for ${r.id}`)}}}for(const[r,u]of c)if(!n.has(r))try{const i=await fetch(u.download_url);if(!i.ok)throw new Error(`Failed to download area: ${i.status}`);const p=await i.json();p.githubSha=u.sha;const{imported:k}=await B([p]);k>0&&e.pulled++}catch(i){e.errors.push(i instanceof Error?i.message:`Pull failed for ${r}`)}g({lastSync:new Date().toISOString(),syncing:!1})}catch(a){g({lastSync:D().lastSync,syncing:!1}),e.errors.push(a instanceof Error?a.message:"Sync failed")}return e}async function et(t,e){const a=`${j}/${t}.json`,n=await w(a,e);if(n.status===404)return;if(!n.ok)throw new Error(`GitHub API error: ${n.status}`);const s=await n.json(),c=await w(a,e,{method:"DELETE",body:JSON.stringify({message:`Delete protected area: ${t}`,sha:s.sha,branch:e.branch||"main"})});if(!c.ok&&c.status!==404)throw new Error(`Failed to delete remote area: ${c.status}`)}async function at(t,e){const a=`${$}/${t}.json`,n=await w(a,e);if(n.status===404)return;if(!n.ok)throw new Error(`GitHub API error: ${n.status}`);const s=await n.json(),c=await w(a,e,{method:"DELETE",body:JSON.stringify({message:`Delete dataset: ${t}`,sha:s.sha,branch:e.branch||"main"})});if(!c.ok&&c.status!==404)throw new Error(`Failed to delete remote dataset: ${c.status}`)}export{Q as a,D as b,A as c,at as d,U as e,X as f,P as g,tt as h,z as i,V as j,K as k,H as l,et as m,W as r,Z as s,Y as u};
