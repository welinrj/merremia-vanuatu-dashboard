import{r as a,j as e}from"./app-xDPf3AKk.js";import{l as P,b as V,m as H,f as m,M as Q,i as q,e as K,g as L,d as Y}from"./MapViewer-k49t5Gix.js";import{g as _,s as W,a as X}from"./GISDatabase-tiLciHop.js";import{D as Z}from"./DatasetUpload-BIi8islD.js";/* empty css                   */const le=({onNavigate:N})=>{const[U,p]=a.useState("browse"),[r,I]=a.useState([]),[R,O]=a.useState(!0),[b,$]=a.useState(null),[u,E]=a.useState(null),[y,x]=a.useState(null),[i,j]=a.useState(null),[S,d]=a.useState(""),f=a.useRef(null),[v,w]=a.useState(!1),[D,g]=a.useState(""),[k,C]=a.useState(null);a.useEffect(()=>{const t=_();C(t.lastSync)},[]);const h=a.useCallback(async()=>{const t=await P();I(t);const s=await V();s&&($(s.used),E(s.quota))},[]);a.useEffect(()=>{let t=!1;return H().then(()=>h()).finally(()=>{t||O(!1)}),()=>{t=!0}},[h]);const F=r.reduce((t,s)=>t+s.featureCount,0),B=r.reduce((t,s)=>t+s.sizeBytes,0);async function G(t){if(y===t){x(null),j(null);return}x(t);const s=await L(t);j(s)}async function A(t){const s=r.find(n=>n.id===t);window.confirm(`Delete "${s?.metadata.name}"? This cannot be undone.`)&&(await Y(t),y===t&&(x(null),j(null)),await h())}async function z(){const t=await K(),s=JSON.stringify(t,null,2),n=new Blob([s],{type:"application/json"}),l=URL.createObjectURL(n),c=document.createElement("a");c.href=l,c.download=`vcap2-gis-backup-${new Date().toISOString().slice(0,10)}.json`,c.click(),URL.revokeObjectURL(l)}async function J(t){const s=t.target.files?.[0];if(s){d("Importing...");try{const n=await s.text(),l=JSON.parse(n);let c;if(Array.isArray(l))c=l;else if(l.type==="FeatureCollection"||l.type==="Feature"||l.coordinates){d('This is a GIS file — use the "Upload Dataset" button to add it to the database.');return}else{d("Invalid backup file format.");return}const o=await q(c);await h(),d(`Imported ${o.imported} dataset${o.imported!==1?"s":""}`+(o.skipped>0?`, ${o.skipped} already existed`:""))}catch{d("Failed to import — invalid file format.")}f.current&&(f.current.value="")}}async function T(t){const s=await L(t);if(!s)return;const n=JSON.stringify(s.data,null,2),l=new Blob([n],{type:"application/geo+json"}),c=URL.createObjectURL(l),o=document.createElement("a");o.href=c,o.download=`${s.metadata.name.replace(/\s+/g,"_")}.geojson`,o.click(),URL.revokeObjectURL(c)}async function M(){const t=X();w(!0),g("Syncing with GitHub...");try{const s=await W(t);await h();const n=[];s.pushed>0&&n.push(`${s.pushed} pushed`),s.pulled>0&&n.push(`${s.pulled} pulled`),s.errors.length>0&&n.push(`${s.errors.length} error${s.errors.length!==1?"s":""}`),n.length===0&&n.push("Already in sync"),g(n.join(", ")),C(new Date().toISOString())}catch(s){g(s instanceof Error?s.message:"Sync failed")}finally{w(!1)}}return R?e.jsx("div",{className:"data-portal",children:e.jsx("div",{className:"portal-toolbar",children:e.jsxs("div",{className:"portal-toolbar-left",children:[e.jsx("h2",{children:"GIS Database"}),e.jsx("span",{className:"dataset-count",children:"Loading..."})]})})}):U==="upload"?e.jsx("div",{className:"data-portal",children:e.jsx(Z,{onUploaded:async()=>{await h(),p("browse"),d("Dataset uploaded and stored to database.")},onCancel:()=>p("browse")})}):e.jsxs("div",{className:"data-portal",children:[e.jsxs("div",{className:"portal-toolbar",children:[e.jsxs("div",{className:"portal-toolbar-left",children:[e.jsx("h2",{children:"GIS Database"}),e.jsxs("span",{className:"dataset-count",children:[r.length," dataset",r.length!==1?"s":""," stored"]})]}),e.jsxs("div",{className:"portal-toolbar-right",children:[e.jsx("input",{ref:f,type:"file",accept:".json",onChange:J,hidden:!0}),e.jsx("button",{className:"btn btn-secondary",onClick:()=>f.current?.click(),children:"Restore Backup"}),e.jsx("button",{className:"btn btn-secondary",onClick:z,disabled:r.length===0,children:"Export Backup"}),e.jsx("button",{className:"btn btn-primary",onClick:()=>p("upload"),children:"Upload Dataset"})]})]}),S&&e.jsxs("div",{className:"db-import-status",role:"status",children:[S,e.jsx("button",{className:"db-dismiss",onClick:()=>d(""),"aria-label":"Dismiss",children:"×"})]}),e.jsxs("div",{className:"db-stats-grid",children:[e.jsxs("div",{className:"db-stat-card",children:[e.jsx("span",{className:"db-stat-value",children:r.length}),e.jsx("span",{className:"db-stat-label",children:"Datasets"})]}),e.jsxs("div",{className:"db-stat-card",children:[e.jsx("span",{className:"db-stat-value",children:F.toLocaleString()}),e.jsx("span",{className:"db-stat-label",children:"Total Features"})]}),e.jsxs("div",{className:"db-stat-card",children:[e.jsx("span",{className:"db-stat-value",children:m(B)}),e.jsx("span",{className:"db-stat-label",children:"Data Size"})]}),e.jsxs("div",{className:"db-stat-card",children:[e.jsx("span",{className:"db-stat-value",children:u?m(u-(b??0)):"N/A"}),e.jsx("span",{className:"db-stat-label",children:"Storage Available"})]})]}),b!=null&&u!=null&&u>0&&e.jsxs("div",{className:"db-storage-bar-container",children:[e.jsx("div",{className:"db-storage-bar",children:e.jsx("div",{className:"db-storage-bar-fill",style:{width:`${Math.min(b/u*100,100)}%`}})}),e.jsxs("span",{className:"db-storage-text",children:[m(b)," of ",m(u)," used"]})]}),e.jsxs("div",{className:"db-sync-section",children:[e.jsxs("div",{className:"db-sync-row",children:[e.jsxs("div",{className:"db-sync-info",children:[e.jsx("strong",{children:"GitHub Sync"}),k&&e.jsxs("span",{className:"db-sync-last",children:["Last sync: ",new Date(k).toLocaleString()]})]}),e.jsx("div",{className:"db-sync-actions",children:e.jsx("button",{className:"btn btn-sm btn-primary",onClick:M,disabled:v,children:v?"Syncing...":"Sync Now"})})]}),D&&e.jsxs("div",{className:"db-sync-status",role:"status",children:[D,e.jsx("button",{className:"db-dismiss",onClick:()=>g(""),"aria-label":"Dismiss",children:"×"})]})]}),r.length===0?e.jsxs("div",{className:"portal-empty",children:[e.jsx("p",{children:"No datasets in the database yet."}),e.jsxs("p",{style:{fontSize:"0.85rem",marginTop:"0.5rem"},children:["Click ",e.jsx("strong",{children:"Upload Dataset"})," to add GIS files (GeoJSON, CSV, KML), or use ",e.jsx("strong",{children:"Restore Backup"})," to import a previous export."]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem",justifyContent:"center",marginTop:"1rem"},children:[e.jsx("button",{className:"btn btn-primary",onClick:()=>p("upload"),children:"Upload Your First Dataset"}),N&&e.jsx("button",{className:"btn btn-secondary",onClick:()=>N("data-portal"),children:"Go to Data Portal"})]})]}):e.jsx("div",{className:"table-container",children:e.jsxs("table",{className:"data-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Format"}),e.jsx("th",{children:"Features"}),e.jsx("th",{children:"Size"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Stored"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:r.map(t=>e.jsxs("tr",{className:y===t.id?"db-row-selected":"",children:[e.jsxs("td",{children:[e.jsx("button",{className:"link-button",onClick:()=>G(t.id),children:t.metadata.name}),t.metadata.description&&e.jsx("span",{className:"dataset-description",children:t.metadata.description})]}),e.jsx("td",{children:e.jsx("span",{className:"badge badge-format",children:t.format.toUpperCase()})}),e.jsx("td",{children:t.featureCount.toLocaleString()}),e.jsx("td",{children:m(t.sizeBytes)}),e.jsx("td",{children:e.jsx("span",{className:`badge badge-${t.metadata.status}`,children:t.metadata.status})}),e.jsx("td",{children:new Date(t.createdAt).toLocaleDateString()}),e.jsx("td",{children:e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{className:"btn btn-sm",onClick:()=>T(t.id),title:"Download as GeoJSON",children:"Download"}),e.jsx("button",{className:"btn btn-sm btn-danger",onClick:()=>A(t.id),title:"Delete from database",children:"Delete"})]})})]},t.id))})]})}),i&&e.jsxs("div",{className:"db-preview",children:[e.jsxs("div",{className:"db-preview-header",children:[e.jsxs("h3",{children:["Preview: ",i.metadata.name]}),e.jsx("button",{className:"btn btn-sm",onClick:()=>{x(null),j(null)},children:"Close"})]}),e.jsxs("div",{className:"db-preview-meta",children:[e.jsxs("span",{children:[i.featureCount," features"]}),e.jsx("span",{children:i.format.toUpperCase()}),e.jsx("span",{children:m(i.sizeBytes)}),i.bbox&&e.jsxs("span",{children:["Bbox: [",i.bbox.map(t=>t.toFixed(2)).join(", "),"]"]})]}),e.jsx(Q,{data:i.data,height:"350px"})]})]})};export{le as default};
