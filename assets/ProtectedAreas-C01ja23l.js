import{r as l,j as e}from"./app-BACuaSRr.js";import{b as z,l as V,f as R,c as $,u as J,e as q,a as B,h as H,i as _,j as K,k as W,r as Y,m as Q}from"./GISDatabase-DHMrp1px.js";import{M as X,h as Z}from"./MapViewer-CosjcAVy.js";/* empty css                   */const G={proposed:"Proposed",designated:"Designated",active:"Active",inactive:"Inactive"},O={cca:"CCA",mpa:"MPA"},ee=["Malampa","Penama","Sanma","Shefa","Tafea","Torba"],ce=()=>{const[t,c]=l.useState("dashboard"),[i,h]=l.useState([]),[o,d]=l.useState(null),[g,p]=l.useState(!0),[j,y]=l.useState(""),[r,x]=l.useState(""),[w,A]=l.useState(!1),[P,u]=l.useState(""),[D,v]=l.useState(null);l.useEffect(()=>{const a=z();v(a.lastSync)},[]);const b=l.useCallback(async()=>{const a=await V();h(a)},[]);l.useEffect(()=>{let a=!1;async function n(){try{const s=B();if(s.token){const m=await H(s);!a&&(m.pulled>0||m.pushed>0)&&v(new Date().toISOString())}}catch{}a||(await b(),p(!1))}return n(),()=>{a=!0}},[b]);function k(){const a=B();a.token&&H(a).then(n=>{(n.pushed>0||n.pulled>0)&&v(new Date().toISOString())}).catch(()=>{})}async function T(a){const n=await $(a);n&&(d(n),c("detail"))}async function I(a){const n=await $(a);n&&(d(n),c("edit"))}async function S(a){const n=i.find(m=>m.id===a);if(!window.confirm(`Delete "${n?.name}"? This cannot be undone.`))return;await _(a);const s=B();s.token&&Q(a,s).catch(()=>{}),o?.id===a&&(d(null),c("dashboard")),await b()}async function C(){const a=B();if(!a.token){u("No GitHub token configured — cannot sync");return}A(!0),u("Syncing with GitHub...");try{const n=await H(a);await b();const s=[];n.pushed>0&&s.push(`${n.pushed} pushed`),n.pulled>0&&s.push(`${n.pulled} pulled`),n.errors.length>0&&s.push(`${n.errors.length} error${n.errors.length!==1?"s":""}: ${n.errors.join("; ")}`),s.length===0&&s.push("Already in sync"),u(s.join(", ")),v(new Date().toISOString())}catch(n){u(n instanceof Error?n.message:"Sync failed")}finally{A(!1)}}const N=i.filter(a=>!(j&&a.type!==j||r&&a.status!==r)),F=i.filter(a=>a.type==="cca").length,f=i.filter(a=>a.type==="mpa").length,M=i.filter(a=>a.status==="active"||a.status==="designated").length,E=i.reduce((a,n)=>a+(n.areaHa??0),0);return g?e.jsx("div",{className:"data-portal",children:e.jsx("div",{className:"portal-toolbar",children:e.jsxs("div",{className:"portal-toolbar-left",children:[e.jsx("h2",{children:"CCAs & MPAs"}),e.jsx("span",{className:"dataset-count",children:"Loading..."})]})})}):t==="dashboard"?e.jsxs("div",{className:"data-portal",children:[e.jsxs("div",{className:"portal-toolbar",children:[e.jsxs("div",{className:"portal-toolbar-left",children:[e.jsx("h2",{children:"CCAs & MPAs"}),e.jsxs("span",{className:"dataset-count",children:[i.length," protected area",i.length!==1?"s":""]})]}),e.jsx("div",{className:"portal-toolbar-right",children:e.jsx("button",{className:"btn btn-primary",onClick:()=>{d(null),c("create")},children:"Add Protected Area"})})]}),e.jsxs("div",{className:"db-stats-grid",children:[e.jsxs("div",{className:"db-stat-card",children:[e.jsx("span",{className:"db-stat-value",children:F}),e.jsx("span",{className:"db-stat-label",children:"Community Conservation Areas"})]}),e.jsxs("div",{className:"db-stat-card",children:[e.jsx("span",{className:"db-stat-value",children:f}),e.jsx("span",{className:"db-stat-label",children:"Marine Protected Areas"})]}),e.jsxs("div",{className:"db-stat-card",children:[e.jsx("span",{className:"db-stat-value",children:M}),e.jsx("span",{className:"db-stat-label",children:"Active / Designated"})]}),e.jsxs("div",{className:"db-stat-card",children:[e.jsx("span",{className:"db-stat-value",children:R(E)}),e.jsx("span",{className:"db-stat-label",children:"Total Area"})]})]}),e.jsxs("div",{className:"db-sync-section",children:[e.jsxs("div",{className:"db-sync-row",children:[e.jsxs("div",{className:"db-sync-info",children:[e.jsx("strong",{children:"GitHub Sync"}),D&&e.jsxs("span",{className:"db-sync-last",children:["Last sync: ",new Date(D).toLocaleString()]})]}),e.jsx("div",{className:"db-sync-actions",children:e.jsx("button",{className:"btn btn-sm btn-primary",onClick:C,disabled:w,children:w?"Syncing...":"Sync Now"})})]}),P&&e.jsxs("div",{className:"db-sync-status",role:"status",children:[P,e.jsx("button",{className:"db-dismiss",onClick:()=>u(""),"aria-label":"Dismiss",children:"×"})]})]}),i.length>0&&e.jsxs("div",{className:"pa-filters",children:[e.jsxs("div",{className:"pa-filter-group",children:[e.jsx("label",{htmlFor:"filter-type",children:"Type"}),e.jsxs("select",{id:"filter-type",value:j,onChange:a=>y(a.target.value),children:[e.jsx("option",{value:"",children:"All"}),e.jsx("option",{value:"cca",children:"CCA"}),e.jsx("option",{value:"mpa",children:"MPA"})]})]}),e.jsxs("div",{className:"pa-filter-group",children:[e.jsx("label",{htmlFor:"filter-status",children:"Status"}),e.jsxs("select",{id:"filter-status",value:r,onChange:a=>x(a.target.value),children:[e.jsx("option",{value:"",children:"All"}),e.jsx("option",{value:"proposed",children:"Proposed"}),e.jsx("option",{value:"designated",children:"Designated"}),e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"inactive",children:"Inactive"})]})]}),e.jsxs("span",{className:"pa-filter-count",children:["Showing ",N.length," of ",i.length]})]}),N.length===0?e.jsx("div",{className:"portal-empty",children:i.length===0?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"No protected areas registered yet."}),e.jsxs("p",{style:{fontSize:"0.85rem",marginTop:"0.5rem"},children:["Click ",e.jsx("strong",{children:"Add Protected Area"})," to register a CCA or MPA."]})]}):e.jsx("p",{children:"No protected areas match the current filters."})}):e.jsx("div",{className:"table-container",children:e.jsxs("table",{className:"data-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Island"}),e.jsx("th",{children:"Province"}),e.jsx("th",{children:"Area"}),e.jsx("th",{children:"Updated"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:N.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("button",{className:"link-button",onClick:()=>T(a.id),children:a.name})}),e.jsx("td",{children:e.jsx("span",{className:`badge badge-pa-type badge-pa-${a.type}`,children:O[a.type]})}),e.jsx("td",{children:e.jsx("span",{className:`badge badge-${a.status}`,children:G[a.status]})}),e.jsx("td",{children:a.island||"—"}),e.jsx("td",{children:a.province||"—"}),e.jsx("td",{children:R(a.areaHa)}),e.jsx("td",{children:new Date(a.updatedAt).toLocaleDateString()}),e.jsx("td",{children:e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{className:"btn btn-sm",onClick:()=>I(a.id),children:"Edit"}),e.jsx("button",{className:"btn btn-sm btn-danger",onClick:()=>S(a.id),children:"Delete"})]})})]},a.id))})]})})]}):t==="detail"&&o?e.jsx(ae,{area:o,onBack:()=>{d(null),c("dashboard")},onEdit:()=>c("edit"),onDelete:()=>S(o.id),onRefresh:async()=>{const a=await $(o.id);a&&d(a)}}):t==="create"||t==="edit"?e.jsx(se,{existing:t==="edit"?o:null,onSave:async a=>{t==="edit"&&o?await J(o.id,a):await q(a),k(),await b(),d(null),c("dashboard")},onCancel:()=>c(o?"detail":"dashboard")}):null},ae=({area:t,onBack:c,onEdit:i,onDelete:h,onRefresh:o})=>{const d=l.useRef(null),[g,p]=l.useState(!1);async function j(r){const x=r.target.files?.[0];x&&(p(!0),await W(t.id,x),await o(),p(!1),d.current&&(d.current.value=""))}async function y(r){window.confirm("Remove this attachment?")&&(await Y(t.id,r),await o())}return e.jsxs("div",{className:"data-portal",children:[e.jsxs("div",{className:"detail-header",children:[e.jsx("button",{className:"btn btn-secondary",onClick:c,children:"← Back to List"}),e.jsxs("div",{className:"detail-actions",children:[e.jsx("button",{className:"btn btn-secondary",onClick:i,children:"Edit"}),e.jsx("button",{className:"btn btn-danger",onClick:h,children:"Delete"})]})]}),e.jsxs("div",{className:"detail-meta-card",children:[e.jsxs("div",{className:"detail-title-row",children:[e.jsx("h2",{children:t.name}),e.jsx("span",{className:`badge badge-pa-type badge-pa-${t.type}`,children:O[t.type]}),e.jsx("span",{className:`badge badge-${t.status}`,children:G[t.status]})]}),t.description&&e.jsx("p",{className:"detail-description",children:t.description}),e.jsxs("div",{className:"detail-stats",children:[e.jsxs("div",{className:"detail-stat",children:[e.jsx("span",{className:"detail-stat-label",children:"Island"}),e.jsx("span",{className:"detail-stat-value",children:t.island||"—"})]}),e.jsxs("div",{className:"detail-stat",children:[e.jsx("span",{className:"detail-stat-label",children:"Province"}),e.jsx("span",{className:"detail-stat-value",children:t.province||"—"})]}),e.jsxs("div",{className:"detail-stat",children:[e.jsx("span",{className:"detail-stat-label",children:"Area"}),e.jsx("span",{className:"detail-stat-value",children:R(t.areaHa)})]}),e.jsxs("div",{className:"detail-stat",children:[e.jsx("span",{className:"detail-stat-label",children:"Designated"}),e.jsx("span",{className:"detail-stat-value",children:t.designatedDate||"—"})]}),e.jsxs("div",{className:"detail-stat",children:[e.jsx("span",{className:"detail-stat-label",children:"Management"}),e.jsx("span",{className:"detail-stat-value",children:t.managementAuthority||"—"})]}),e.jsxs("div",{className:"detail-stat",children:[e.jsx("span",{className:"detail-stat-label",children:"Created"}),e.jsx("span",{className:"detail-stat-value",children:new Date(t.createdAt).toLocaleDateString()})]})]})]}),t.boundary&&t.boundary.features.length>0&&e.jsxs("div",{className:"detail-map",children:[e.jsx("h3",{children:"Boundary Map"}),e.jsx(X,{data:t.boundary,height:"400px"})]}),e.jsxs("div",{className:"pa-attachments-card",children:[e.jsxs("div",{className:"pa-attachments-header",children:[e.jsxs("h3",{children:["Attachments (",t.attachments.length,")"]}),e.jsxs("div",{children:[e.jsx("input",{ref:d,type:"file",accept:".pdf,.doc,.docx,.png,.jpg,.jpeg,.geojson,.json,.csv,.kml,.zip",onChange:j,hidden:!0}),e.jsx("button",{className:"btn btn-sm btn-primary",onClick:()=>d.current?.click(),disabled:g,children:g?"Uploading...":"Upload File"})]})]}),t.attachments.length===0?e.jsx("p",{className:"pa-attachments-empty",children:"No attachments yet."}):e.jsxs("table",{className:"data-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"File Name"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Size"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:t.attachments.map(r=>e.jsxs("tr",{children:[e.jsx("td",{children:r.name}),e.jsx("td",{children:r.mimeType||"—"}),e.jsx("td",{children:te(r.sizeBytes)}),e.jsx("td",{children:e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{className:"btn btn-sm",onClick:()=>K(r),children:"Download"}),e.jsx("button",{className:"btn btn-sm btn-danger",onClick:()=>y(r.id),children:"Remove"})]})})]},r.id))})]})]})]})};function te(t){if(t===0)return"0 B";const c=1024,i=["B","KB","MB","GB"],h=Math.floor(Math.log(t)/Math.log(c));return`${parseFloat((t/Math.pow(c,h)).toFixed(1))} ${i[h]}`}const se=({existing:t,onSave:c,onCancel:i})=>{const[h,o]=l.useState(t?.name??""),[d,g]=l.useState(t?.type??"cca"),[p,j]=l.useState(t?.status??"proposed"),[y,r]=l.useState(t?.description??""),[x,w]=l.useState(t?.island??""),[A,P]=l.useState(t?.province??""),[u,D]=l.useState(t?.areaHa?.toString()??""),[v,b]=l.useState(t?.designatedDate??""),[k,T]=l.useState(t?.managementAuthority??""),[I,S]=l.useState(t?.boundary??null),[C,N]=l.useState(""),[F,f]=l.useState(""),[M,E]=l.useState(!1);function a(s){const m=s.target.files?.[0];if(!m)return;const L=new FileReader;L.onload=()=>{try{const U=Z(L.result);S(U),N(m.name),f("")}catch{f("Invalid GeoJSON boundary file."),S(null),N("")}},L.readAsText(m)}async function n(s){if(s.preventDefault(),!h.trim()){f("Name is required.");return}E(!0),f("");try{await c({name:h.trim(),type:d,status:p,description:y.trim(),island:x.trim(),province:A,areaHa:u?parseFloat(u):null,designatedDate:v,managementAuthority:k.trim(),boundary:I})}catch{f("Failed to save. Please try again."),E(!1)}}return e.jsx("div",{className:"data-portal",children:e.jsxs("div",{className:"upload-panel",style:{maxWidth:"720px"},children:[e.jsx("h3",{children:t?"Edit Protected Area":"Add Protected Area"}),F&&e.jsx("div",{className:"form-error",children:F}),e.jsxs("form",{onSubmit:n,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"pa-name",children:"Name *"}),e.jsx("input",{id:"pa-name",type:"text",value:h,onChange:s=>o(s.target.value),placeholder:"e.g. Nguna-Pele Marine Protected Area",required:!0})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"pa-type",children:"Type"}),e.jsxs("select",{id:"pa-type",value:d,onChange:s=>g(s.target.value),children:[e.jsx("option",{value:"cca",children:"CCA — Community Conservation Area"}),e.jsx("option",{value:"mpa",children:"MPA — Marine Protected Area"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"pa-status",children:"Status"}),e.jsxs("select",{id:"pa-status",value:p,onChange:s=>j(s.target.value),children:[e.jsx("option",{value:"proposed",children:"Proposed"}),e.jsx("option",{value:"designated",children:"Designated"}),e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"inactive",children:"Inactive"})]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"pa-desc",children:"Description"}),e.jsx("textarea",{id:"pa-desc",value:y,onChange:s=>r(s.target.value),rows:3,placeholder:"Brief description of the protected area"})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"pa-island",children:"Island"}),e.jsx("input",{id:"pa-island",type:"text",value:x,onChange:s=>w(s.target.value),placeholder:"e.g. Efate"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"pa-province",children:"Province"}),e.jsxs("select",{id:"pa-province",value:A,onChange:s=>P(s.target.value),children:[e.jsx("option",{value:"",children:"Select province"}),ee.map(s=>e.jsx("option",{value:s,children:s},s))]})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"pa-area",children:"Area (hectares)"}),e.jsx("input",{id:"pa-area",type:"number",step:"0.1",min:"0",value:u,onChange:s=>D(s.target.value),placeholder:"e.g. 1250"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"pa-date",children:"Designated Date"}),e.jsx("input",{id:"pa-date",type:"date",value:v,onChange:s=>b(s.target.value)})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"pa-mgmt",children:"Management Authority"}),e.jsx("input",{id:"pa-mgmt",type:"text",value:k,onChange:s=>T(s.target.value),placeholder:"e.g. DEPC / Community Council"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"pa-boundary",children:"Boundary (GeoJSON)"}),e.jsx("input",{id:"pa-boundary",type:"file",accept:".geojson,.json",onChange:a}),C&&e.jsxs("span",{className:"pa-boundary-file",children:["Loaded: ",C]}),t?.boundary&&!C&&e.jsxs("span",{className:"pa-boundary-file",children:["Existing boundary (",t.boundary.features.length," feature",t.boundary.features.length!==1?"s":"",")"]})]}),e.jsxs("div",{className:"form-actions",children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:i,children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:M,children:M?"Saving...":t?"Save Changes":"Create"})]})]})]})})};export{ce as default};
