<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#065f46">
  <meta name="description" content="Invasive vine species monitoring dashboard for Vanuatu — Vanuatu Spatial Solutions for DEPC & NBSAP">
  <title>Merremia Vanuatu Dashboard</title>
  <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="assets/favicon-180.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #ffffff;
      color: #1e293b;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* ── Header ── */
    header {
      background: linear-gradient(135deg, #052e23 0%, #064e3b 50%, #065f46 100%);
      padding: 1.5rem 2rem 1.25rem;
      border-bottom: 1px solid rgba(16,185,129,0.3);
      box-shadow: 0 4px 24px rgba(0,0,0,0.3);
    }
    header h1 { font-size: 1.4rem; font-weight: 800; color: #ecfdf5; letter-spacing: -0.02em; }
    header p { color: rgba(110,231,183,0.8); font-size: 0.82rem; margin-top: 0.2rem; font-weight: 500; }
    .header-row { display: flex; align-items: center; gap: 1.25rem; }
    .header-logo { height: 52px; width: auto; border-radius: 0.5rem; background: rgba(255,255,255,0.95); padding: 4px; flex-shrink: 0; box-shadow: 0 2px 12px rgba(0,0,0,0.2); }
    .logo-group { display: flex; align-items: center; gap: 0.75rem; flex-shrink: 0; }
    .logo-dept-name { font-size: 0.72rem; font-weight: 700; color: rgba(236,253,245,0.9); line-height: 1.3; letter-spacing: 0.04em; max-width: 200px; text-transform: uppercase; }

    /* ── Tab Navigation ── */
    .tab-nav {
      display: flex;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
      padding: 0 2rem;
      gap: 0;
      overflow-x: auto;
    }
    .tab-btn {
      padding: 0.9rem 1.5rem;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: #64748b;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s ease;
      white-space: nowrap;
      position: relative;
      letter-spacing: 0.01em;
    }
    .tab-btn:hover { color: #334155; background: rgba(0,0,0,0.02); }
    .tab-btn.active {
      color: #065f46;
      border-bottom-color: #10b981;
      background: linear-gradient(180deg, transparent 0%, rgba(16,185,129,0.06) 100%);
    }
    .tab-btn .tab-icon { margin-right: 0.5rem; }
    #tab-btn-live .tab-icon { color: #10b981; animation: pulse-dot 2s infinite; }
    @keyframes pulse-dot { 0%,100%{ opacity:1; } 50%{ opacity:0.4; } }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* ── Tab Page Styles ── */
    .tab-page {
      padding: 2rem;
      max-width: 1100px;
      margin: 0 auto;
    }
    .tab-page h2 {
      font-size: 1.5rem;
      color: #1e293b;
      margin-bottom: 0.5rem;
    }
    .tab-page .lead {
      font-size: 1rem;
      color: #64748b;
      margin-bottom: 2rem;
      line-height: 1.6;
    }
    .section-card {
      background: #ffffff;
      border-radius: 0.75rem;
      padding: 1.5rem;
      border: 1px solid #e2e8f0;
      margin-bottom: 1.25rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .section-card h3 {
      font-size: 1.05rem;
      color: #065f46;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .section-card h3 .step-num {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px; height: 28px;
      border-radius: 50%;
      background: #065f46;
      color: #ecfdf5;
      font-size: 0.8rem;
      font-weight: 700;
      flex-shrink: 0;
    }
    .section-card p, .section-card li {
      color: #475569;
      font-size: 0.9rem;
      line-height: 1.7;
    }
    .section-card ul { padding-left: 1.25rem; margin-top: 0.5rem; }
    .section-card li { margin-bottom: 0.35rem; }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.75rem;
      font-size: 0.85rem;
    }
    .data-table th {
      text-align: left;
      color: #64748b;
      padding: 0.6rem 0.75rem;
      border-bottom: 2px solid #e2e8f0;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .data-table td {
      padding: 0.6rem 0.75rem;
      border-bottom: 1px solid #f1f5f9;
      color: #334155;
    }
    .data-table tr:hover td { background: #f8fafc; }
    .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .credibility-badge {
      display: inline-block;
      padding: 0.15rem 0.6rem;
      border-radius: 9999px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    .cred-high { background: #d1fae5; color: #065f46; }
    .cred-med { background: #fef3c7; color: #92400e; }
    .data-link {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.35rem 0.75rem;
      border-radius: 0.4rem;
      font-size: 0.75rem;
      font-weight: 600;
      text-decoration: none;
      white-space: nowrap;
      transition: all 0.2s;
      cursor: pointer;
    }
    .data-link:hover { opacity: 0.85; transform: translateY(-1px); }
    .data-link-download { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
    .data-link-download:hover { background: #a7f3d0; box-shadow: 0 2px 8px rgba(16,185,129,0.2); }
    .data-link-request { background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }
    .data-link-request:hover { background: #fde68a; }
    .data-link-commercial { background: #e0e7ff; color: #3730a3; border: 1px solid #6366f1; }
    .data-link-commercial:hover { background: #c7d2fe; }
    .dl-icon { font-size: 0.85rem; }
    .intent-highlight {
      background: linear-gradient(135deg, #065f46, #064e3b);
      border: 1px solid #10b981;
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 1.25rem;
    }
    .intent-highlight h3 { color: #ecfdf5; margin-bottom: 0.5rem; font-size: 1.1rem; }
    .intent-highlight p { color: #d1fae5; line-height: 1.7; font-size: 0.95rem; }
    .objectives-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .objective-card {
      background: #f8fafc;
      border-radius: 0.5rem;
      padding: 1.25rem;
      border-left: 3px solid #10b981;
    }
    .objective-card h4 { color: #1e293b; font-size: 0.95rem; margin-bottom: 0.4rem; }
    .objective-card p { color: #64748b; font-size: 0.85rem; line-height: 1.6; }

    /* ── Analysis Bar ── */
    .analysis-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.75rem;
      padding: 1rem 2rem;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
    }
    .analysis-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: #64748b;
    }
    .status-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: #f59e0b;
      animation: pulse 1.5s ease-in-out infinite;
    }
    .status-dot.done { background: #10b981; animation: none; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
    .btn-download {
      display: inline-flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.75rem 1.75rem;
      background: linear-gradient(135deg, #065f46, #047857);
      color: #ecfdf5;
      border: 2px solid #10b981;
      border-radius: 0.6rem;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 0 12px rgba(16, 185, 129, 0.3);
    }
    .btn-download:hover { background: linear-gradient(135deg, #047857, #059669); box-shadow: 0 0 20px rgba(16, 185, 129, 0.5); transform: translateY(-1px); }
    .btn-download:disabled { opacity: 0.4; cursor: not-allowed; box-shadow: none; transform: none; }
    .btn-download svg { width: 20px; height: 20px; }

    /* ── Dashboard Cards & Panels ── */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1rem;
      padding: 1.5rem 2rem;
    }
    .card {
      background: #ffffff;
      border-radius: 0.75rem;
      padding: 1.25rem;
      border: 1px solid #e2e8f0;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: linear-gradient(90deg, #10b981, #34d399);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .card:hover { border-color: rgba(16,185,129,0.3); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.08); }
    .card:hover::before { opacity: 1; }
    .card h3 {
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #64748b;
      margin-bottom: 0.5rem;
      font-weight: 700;
    }
    .card .value {
      font-size: 2rem;
      font-weight: 800;
      background: linear-gradient(135deg, #065f46, #10b981);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .card .sub { font-size: 0.78rem; color: #64748b; margin-top: 0.25rem; font-weight: 500; }
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      padding: 0 2rem 1.5rem;
    }
    @media (max-width: 768px) {
      .main-grid { grid-template-columns: 1fr; }
      .tab-nav { padding: 0 0.5rem; }
      .tab-btn { padding: 0.75rem 0.75rem; font-size: 0.8rem; }
      .tab-page { padding: 1rem; }
      .grid { padding: 1rem; }
      .main-grid { padding: 0 1rem 1rem; }
      .analysis-bar { padding: 0.75rem 1rem; }
      #map { height: 250px; }
    }
    .panel {
      background: #ffffff;
      border-radius: 0.75rem;
      padding: 1.25rem;
      border: 1px solid #e2e8f0;
      transition: border-color 0.3s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .panel:hover { border-color: #cbd5e1; }
    .panel h2 {
      font-size: 0.9rem;
      font-weight: 700;
      color: #475569;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid #e2e8f0;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    #map { height: 320px; border-radius: 0.5rem; }
    .map-wrap { position: relative; }
    .basemap-toggle { position: absolute; top: 10px; left: 10px; z-index: 1000; display: flex; border-radius: 0.4rem; overflow: hidden; border: 1px solid #cbd5e1; }
    .basemap-btn { padding: 0.3rem 0.7rem; font-size: 0.75rem; background: #ffffff; color: #64748b; border: none; cursor: pointer; }
    .basemap-btn:hover { background: #f1f5f9; }
    .basemap-btn.active { background: #065f46; color: #ecfdf5; }
    canvas { width: 100% !important; max-height: 300px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th { text-align: left; color: #64748b; padding: 0.5rem; border-bottom: 1px solid #e2e8f0; }
    td { padding: 0.5rem; border-bottom: 1px solid #f1f5f9; color: #334155; }
    .badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    .badge-high { background: #fee2e2; color: #991b1b; }
    .badge-moderate { background: #fef3c7; color: #92400e; }
    .badge-low { background: #d1fae5; color: #065f46; }

    /* ── Analysis Panel ── */
    .analysis-panel {
      background: #ffffff;
      border-radius: 0.75rem;
      padding: 1.25rem;
      border: 1px solid #e2e8f0;
      grid-column: 1 / -1;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .analysis-panel h2 {
      font-size: 0.9rem;
      font-weight: 700;
      color: #475569;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid #e2e8f0;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .findings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
    }
    .finding {
      background: #f8fafc;
      border-radius: 0.6rem;
      padding: 1.1rem;
      border-left: 3px solid #10b981;
      transition: transform 0.2s ease;
    }
    .finding:hover { transform: translateX(4px); }
    .finding.warn { border-left-color: #f59e0b; }
    .finding.critical { border-left-color: #ef4444; }
    .finding h4 { font-size: 0.7rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 0.35rem; font-weight: 700; }
    .finding .result { font-size: 1.1rem; font-weight: 700; color: #1e293b; }
    .finding .detail { font-size: 0.75rem; color: #64748b; margin-top: 0.3rem; font-weight: 500; }

    footer {
      background: #f8fafc;
      padding: 2.5rem 2rem 1.5rem;
      color: #64748b;
      font-size: 0.78rem;
      border-top: 1px solid #e2e8f0;
    }
    .footer-inner { max-width: 900px; margin: 0 auto; }
    .footer-header { display: flex; align-items: center; gap: 1.5rem; justify-content: center; margin-bottom: 1.5rem; }
    .footer-header img { height: 80px; opacity: 0.6; flex-shrink: 0; }
    .footer-dept { text-align: left; }
    .footer-dept h3 { color: #1e293b; font-size: 0.85rem; font-weight: 700; margin: 0 0 0.25rem; letter-spacing: 0.02em; }
    .footer-dept p { color: #64748b; font-size: 0.72rem; line-height: 1.5; margin: 0; }
    .footer-divider { border: none; border-top: 1px solid #e2e8f0; margin: 0 0 1.25rem; }
    .footer-contacts { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.25rem; }
    .footer-contact-col h4 { color: #334155; font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.08em; margin: 0 0 0.4rem; font-weight: 700; }
    .footer-contact-col p { color: #64748b; line-height: 1.7; font-size: 0.74rem; margin: 0; }
    .footer-contact-col a { color: #065f46; text-decoration: none; transition: color 0.2s; }
    .footer-contact-col a:hover { color: #10b981; }
    .footer-bottom { text-align: center; padding-top: 1rem; border-top: 1px solid #e2e8f0; color: #94a3b8; font-size: 0.68rem; }
    .footer-bottom strong { color: #64748b; }
    @media (max-width: 600px) {
      .footer-header { flex-direction: column; text-align: center; }
      .footer-dept { text-align: center; }
      .footer-contacts { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- ═══ HEADER & ATTRIBUTION ═══ -->
  <header>
    <div class="header-row">
      <div class="logo-group">
        <img src="assets/depc-logo.png" alt="DEPC — Department of Environmental Protection and Conservation" class="header-logo">
        <span class="logo-dept-name">DEPARTMENT OF ENVIRONMENTAL PROTECTION AND CONSERVATION</span>
      </div>
      <div>
        <h1>Merremia Vanuatu Dashboard</h1>
        <p>Invasive vine species monitoring across Vanuatu islands</p>
      </div>
    </div>
  </header>

  <!-- ═══ TAB NAVIGATION ═══ -->
  <nav class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('dashboard')" id="tab-btn-dashboard">
      <span class="tab-icon">&#9632;</span>Dashboard
    </button>
    <button class="tab-btn" onclick="switchTab('methodology')" id="tab-btn-methodology">
      <span class="tab-icon">&#9881;</span>Methodology
    </button>
    <button class="tab-btn" onclick="switchTab('data')" id="tab-btn-data">
      <span class="tab-icon">&#9776;</span>Data &amp; Training Sources
    </button>
    <button class="tab-btn" onclick="switchTab('intent')" id="tab-btn-intent">
      <span class="tab-icon">&#9733;</span>Dashboard Intent
    </button>
    <button class="tab-btn" onclick="switchTab('live')" id="tab-btn-live">
      <span class="tab-icon">&#9679;</span>Live Data
    </button>
  </nav>

  <!-- ═══ TAB 1: DASHBOARD (default) ═══ -->
  <div class="tab-content active" id="tab-dashboard">

    <div class="analysis-bar">
      <div class="analysis-status">
        <span class="status-dot" id="analysis-dot"></span>
        <span id="analysis-text">Background analysis running...</span>
      </div>
      <button class="btn-download" id="btn-download" disabled onclick="downloadReport()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>
        Download Report
      </button>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Species Tracked</h3>
        <div class="value">7</div>
        <div class="sub">Merremia spp. identified</div>
      </div>
      <div class="card">
        <h3>Survey Sites</h3>
        <div class="value">34</div>
        <div class="sub">Across 6 islands</div>
      </div>
      <div class="card">
        <h3>Area Affected</h3>
        <div class="value">2,140 <span style="font-size:1rem">ha</span></div>
        <div class="sub">+12% from last survey</div>
      </div>
      <div class="card">
        <h3>Last Updated</h3>
        <div class="value" style="font-size:1.3rem" id="last-updated"></div>
        <div class="sub">Quarterly survey cycle</div>
      </div>
    </div>

    <div class="main-grid">
      <div class="panel">
        <h2>Distribution Map</h2>
        <div class="map-wrap">
          <div class="basemap-toggle">
            <button class="basemap-btn active" id="bm-dark" onclick="switchBasemap('dark')">Dark</button>
            <button class="basemap-btn" id="bm-streets" onclick="switchBasemap('streets')">Streets</button>
            <button class="basemap-btn" id="bm-satellite" onclick="switchBasemap('satellite')">Satellite</button>
          </div>
          <div id="map"></div>
        </div>
      </div>
      <div class="panel">
        <h2>Coverage by Island</h2>
        <canvas id="chart-islands"></canvas>
      </div>
      <div class="panel">
        <h2>Spread Over Time</h2>
        <canvas id="chart-trend"></canvas>
      </div>
      <div class="panel">
        <h2>Species Observations</h2>
        <table>
          <thead><tr><th>Species</th><th>Count</th><th>Threat</th></tr></thead>
          <tbody>
            <tr><td><em>M. peltata</em></td><td>482</td><td><span class="badge badge-high">High</span></td></tr>
            <tr><td><em>M. vitifolia</em></td><td>215</td><td><span class="badge badge-moderate">Moderate</span></td></tr>
            <tr><td><em>M. tridentata</em></td><td>167</td><td><span class="badge badge-moderate">Moderate</span></td></tr>
            <tr><td><em>M. gemella</em></td><td>98</td><td><span class="badge badge-low">Low</span></td></tr>
            <tr><td><em>M. umbellata</em></td><td>73</td><td><span class="badge badge-low">Low</span></td></tr>
            <tr><td><em>M. tuberosa</em></td><td>41</td><td><span class="badge badge-low">Low</span></td></tr>
            <tr><td><em>M. dissecta</em></td><td>29</td><td><span class="badge badge-low">Low</span></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="main-grid">
      <div class="analysis-panel" id="analysis-panel" style="display:none">
        <h2>Analysis Findings</h2>
        <div class="findings-grid" id="findings-grid"></div>
      </div>
    </div>

  </div>

  <!-- ═══ TAB 2: METHODOLOGY ═══ -->
  <div class="tab-content" id="tab-methodology">
    <div class="tab-page">
      <h2>Detection Methodology</h2>
      <p class="lead">This section outlines the end-to-end process used to detect and monitor Merremia vine species across the Vanuatu archipelago, from satellite image acquisition through to the dashboard you see here.</p>

      <div class="section-card">
        <h3><span class="step-num">1</span> Satellite Image Acquisition</h3>
        <p>High-resolution multispectral imagery is sourced from the European Space Agency's Sentinel-2 constellation (10 m spatial resolution, 5-day revisit cycle). Additional very-high-resolution validation imagery (sub-metre) is obtained from Planet Labs SkySat tasking when available. Cloud-free composites are generated for each quarterly survey window using median pixel compositing across available scenes.</p>
        <ul>
          <li>Sentinel-2 Level-2A (surface reflectance) bands: B2, B3, B4, B5, B6, B7, B8, B8A, B11, B12</li>
          <li>Cloud masking via ESA Scene Classification Layer (SCL) and Fmask algorithm</li>
          <li>Temporal composites generated per quarter (Jan–Mar, Apr–Jun, Jul–Sep, Oct–Dec)</li>
        </ul>
      </div>

      <div class="section-card">
        <h3><span class="step-num">2</span> Spectral Index Computation</h3>
        <p>Multiple vegetation and canopy indices are computed from the multispectral composites to enhance Merremia detection. The vine's rapid canopy-smothering growth habit produces a distinct spectral signature — high NDVI combined with low canopy texture and reduced red-edge variability compared to native forest.</p>
        <ul>
          <li><strong>NDVI</strong> (Normalized Difference Vegetation Index) — overall greenness</li>
          <li><strong>EVI</strong> (Enhanced Vegetation Index) — canopy density in high-biomass areas</li>
          <li><strong>NDMI</strong> (Normalized Difference Moisture Index) — leaf water content differences</li>
          <li><strong>Red-Edge Position (REP)</strong> — distinguishes vine canopy from native broadleaf forest</li>
          <li><strong>GLCM Texture Metrics</strong> — homogeneity and contrast computed from NIR band to detect the smooth, uniform canopy blanket characteristic of Merremia overgrowth</li>
        </ul>
      </div>

      <div class="section-card">
        <h3><span class="step-num">3</span> Machine Learning Classification</h3>
        <p>A Random Forest classifier (500 trees, max depth 20) is trained on labelled ground-truth polygons to distinguish Merremia-affected canopy from native vegetation, agricultural land, bare soil, and water. The model uses all spectral bands plus derived indices and texture features as input variables.</p>
        <ul>
          <li>Training/validation split: 70/30 stratified by island and species</li>
          <li>Feature importance ranking used to prune redundant inputs</li>
          <li>Cross-validation (5-fold) overall accuracy: 89.3% (M. peltata: 93.1%)</li>
          <li>Post-classification morphological filtering to remove isolated pixels (&lt;0.5 ha)</li>
        </ul>
      </div>

      <div class="section-card">
        <h3><span class="step-num">4</span> Field Validation &amp; Ground-Truthing</h3>
        <p>Quarterly field surveys are conducted by DEPC rangers and trained community observers across 34 monitoring sites on 6 islands. GPS-tagged photographs and species identification are recorded using the KoBoToolbox mobile platform, then uploaded for comparison against classification outputs.</p>
        <ul>
          <li>Stratified random sampling: 15 points per threat zone (High, Moderate, Low)</li>
          <li>Species-level identification confirmed by University of the South Pacific (USP) botanists</li>
          <li>Producer's accuracy (commission error): 87.6%</li>
          <li>User's accuracy (omission error): 91.2%</li>
        </ul>
      </div>

      <div class="section-card">
        <h3><span class="step-num">5</span> Change Detection &amp; Trend Analysis</h3>
        <p>Quarterly classification maps are compared using post-classification change detection. Net area change, expansion direction, and growth rate are computed per island. A linear regression model is fitted to the time-series data to project future spread and estimate time-to-threshold for management triggers.</p>
        <ul>
          <li>Change maps produced for each consecutive quarter pair</li>
          <li>Expansion vectors computed using centroid shift analysis</li>
          <li>Growth rate modelled via ordinary least squares regression on cumulative area</li>
          <li>Threshold alerts set at 3,000 ha national total</li>
        </ul>
      </div>

      <div class="section-card">
        <h3><span class="step-num">6</span> Dashboard Reporting</h3>
        <p>Classification outputs, field validation data, and trend analyses are aggregated and pushed to this web dashboard. A background Web Worker runs automated risk scoring, projection modelling, and priority ranking each time the page loads. PDF reports can be generated on-demand for offline use by DEPC officers and NBSAP reporting.</p>
      </div>
    </div>
  </div>

  <!-- ═══ TAB 3: DATA & TRAINING SOURCES ═══ -->
  <div class="tab-content" id="tab-data">
    <div class="tab-page">
      <h2>Data &amp; Training Sources</h2>
      <p class="lead">Transparency is critical for decision-making. This section details every dataset used in the detection pipeline, including training data for the classification model, and provides an honest assessment of each dataset's credibility and limitations.</p>

      <div class="section-card">
        <h3>Satellite Imagery</h3>
        <div class="table-scroll"><table class="data-table">
          <thead>
            <tr><th>Dataset</th><th>Provider</th><th>Resolution</th><th>Coverage</th><th>Credibility</th><th>Download</th></tr>
          </thead>
          <tbody>
            <tr>
              <td>Sentinel-2 Level-2A</td>
              <td>ESA / Copernicus</td>
              <td>10 m multispectral</td>
              <td>2020 Q1 – present, quarterly composites</td>
              <td><span class="credibility-badge cred-high">High</span></td>
              <td><a href="https://browser.dataspace.copernicus.eu/" target="_blank" rel="noopener" class="data-link data-link-download"><span class="dl-icon">&#11015;</span> Download Tiles</a></td>
            </tr>
            <tr>
              <td>Planet SkySat</td>
              <td>Planet Labs</td>
              <td>0.5 m RGB + NIR</td>
              <td>Efate &amp; Santo validation sites (2023–2025)</td>
              <td><span class="credibility-badge cred-high">High</span></td>
              <td><a href="https://www.planet.com/explorer/" target="_blank" rel="noopener" class="data-link data-link-commercial"><span class="dl-icon">&#128274;</span> Commercial Access</a></td>
            </tr>
            <tr>
              <td>Landsat 8/9 OLI</td>
              <td>USGS / NASA</td>
              <td>30 m multispectral</td>
              <td>Historical baseline (2015–2019)</td>
              <td><span class="credibility-badge cred-high">High</span></td>
              <td><a href="https://earthexplorer.usgs.gov/" target="_blank" rel="noopener" class="data-link data-link-download"><span class="dl-icon">&#11015;</span> Download Scenes</a></td>
            </tr>
          </tbody>
        </table></div>
        <p style="margin-top:0.75rem;">Sentinel-2 and Landsat are open-access, peer-reviewed, and operationally validated datasets maintained by government space agencies. Planet SkySat is a commercial source used only for targeted validation.</p>
      </div>

      <div class="section-card">
        <h3>Training &amp; Ground-Truth Data</h3>
        <div class="table-scroll"><table class="data-table">
          <thead>
            <tr><th>Dataset</th><th>Source</th><th>Samples</th><th>Period</th><th>Credibility</th><th>Download</th></tr>
          </thead>
          <tbody>
            <tr>
              <td>Field survey polygons</td>
              <td>DEPC / Vanuatu Spatial Solutions</td>
              <td>1,247 labelled polygons</td>
              <td>2020–2025</td>
              <td><span class="credibility-badge cred-high">High</span></td>
              <td><a href="mailto:info@vanuatuspatialsolutions.com?subject=Request%20Access%3A%20Field%20Survey%20Polygons&body=I%20would%20like%20to%20request%20access%20to%20the%20Merremia%20field%20survey%20polygons%20dataset." class="data-link data-link-request"><span class="dl-icon">&#9993;</span> Request Access</a></td>
            </tr>
            <tr>
              <td>Community observer reports</td>
              <td>DEPC ranger network (KoBoToolbox)</td>
              <td>3,820 GPS-tagged records</td>
              <td>2021–2025</td>
              <td><span class="credibility-badge cred-med">Medium</span></td>
              <td><a href="mailto:info@vanuatuspatialsolutions.com?subject=Request%20Access%3A%20Community%20Observer%20Reports&body=I%20would%20like%20to%20request%20access%20to%20the%20DEPC%20community%20observer%20reports%20from%20KoBoToolbox." class="data-link data-link-request"><span class="dl-icon">&#9993;</span> Request Access</a></td>
            </tr>
            <tr>
              <td>USP herbarium records</td>
              <td>University of the South Pacific</td>
              <td>312 verified specimens</td>
              <td>2005–2025</td>
              <td><span class="credibility-badge cred-high">High</span></td>
              <td><a href="https://www.usp.ac.fj/" target="_blank" rel="noopener" class="data-link data-link-download"><span class="dl-icon">&#11015;</span> USP Herbarium</a></td>
            </tr>
            <tr>
              <td>iNaturalist observations</td>
              <td>iNaturalist (research grade)</td>
              <td>187 observations</td>
              <td>2018–2025</td>
              <td><span class="credibility-badge cred-med">Medium</span></td>
              <td><a href="https://www.inaturalist.org/observations/export?place_id=7070&taxon_id=55935&quality_grade=research" target="_blank" rel="noopener" class="data-link data-link-download"><span class="dl-icon">&#11015;</span> Export CSV</a></td>
            </tr>
            <tr>
              <td>GBIF occurrence data</td>
              <td>Global Biodiversity Information Facility</td>
              <td>94 occurrence records</td>
              <td>2000–2024</td>
              <td><span class="credibility-badge cred-med">Medium</span></td>
              <td><a href="https://www.gbif.org/occurrence/search?taxon_key=2928556&country=VU" target="_blank" rel="noopener" class="data-link data-link-download"><span class="dl-icon">&#11015;</span> Download CSV</a></td>
            </tr>
          </tbody>
        </table></div>
      </div>

      <div class="section-card">
        <h3>Ancillary &amp; Reference Data</h3>
        <div class="table-scroll"><table class="data-table">
          <thead>
            <tr><th>Dataset</th><th>Source</th><th>Use</th><th>Credibility</th><th>Download</th></tr>
          </thead>
          <tbody>
            <tr>
              <td>SRTM Digital Elevation Model</td>
              <td>NASA / USGS</td>
              <td>Terrain masking &amp; slope analysis</td>
              <td><span class="credibility-badge cred-high">High</span></td>
              <td><a href="https://earthexplorer.usgs.gov/" target="_blank" rel="noopener" class="data-link data-link-download"><span class="dl-icon">&#11015;</span> Download DEM</a></td>
            </tr>
            <tr>
              <td>OpenStreetMap land use</td>
              <td>OSM Contributors</td>
              <td>Agricultural / urban area exclusion</td>
              <td><span class="credibility-badge cred-med">Medium</span></td>
              <td><a href="https://download.geofabrik.de/australia-oceania/vanuatu-latest.osm.pbf" target="_blank" rel="noopener" class="data-link data-link-download"><span class="dl-icon">&#11015;</span> Download .pbf</a></td>
            </tr>
            <tr>
              <td>Vanuatu national forest inventory</td>
              <td>Department of Forests</td>
              <td>Native forest baseline extent</td>
              <td><span class="credibility-badge cred-high">High</span></td>
              <td><a href="mailto:info@vanuatuspatialsolutions.com?subject=Request%20Access%3A%20Forest%20Inventory&body=I%20would%20like%20to%20request%20access%20to%20the%20Vanuatu%20national%20forest%20inventory%20dataset." class="data-link data-link-request"><span class="dl-icon">&#9993;</span> Request Access</a></td>
            </tr>
            <tr>
              <td>Protected area boundaries</td>
              <td>WDPA / DEPC</td>
              <td>Conservation priority overlay</td>
              <td><span class="credibility-badge cred-high">High</span></td>
              <td><a href="https://www.protectedplanet.net/country/VUT" target="_blank" rel="noopener" class="data-link data-link-download"><span class="dl-icon">&#11015;</span> Download Shapefile</a></td>
            </tr>
          </tbody>
        </table></div>
      </div>

      <div class="section-card">
        <h3>Credibility Assessment Notes</h3>
        <ul>
          <li><span class="credibility-badge cred-high">High</span> — Peer-reviewed, operationally validated, or produced by authoritative government / academic institutions with established QA/QC procedures.</li>
          <li><span class="credibility-badge cred-med">Medium</span> — Citizen science or crowd-sourced data with some quality controls (e.g., iNaturalist research grade, KoBoToolbox with photo verification), but may contain spatial inaccuracies or identification errors. Used to supplement, not replace, primary training data.</li>
          <li>All training data undergoes manual review by Vanuatu Spatial Solutions analysts and USP botanists before inclusion in the classification model.</li>
          <li>Model accuracy metrics are recalculated each quarter as new ground-truth data is added.</li>
        </ul>
        <div style="margin-top:1rem;padding-top:0.75rem;border-top:1px solid #334155">
          <p style="font-size:0.78rem;color:#94a3b8;margin-bottom:0.5rem"><strong style="color:#cbd5e1">Access Key:</strong></p>
          <span class="data-link data-link-download" style="cursor:default;margin-right:0.5rem"><span class="dl-icon">&#11015;</span> Download</span> Direct download available &nbsp;&nbsp;
          <span class="data-link data-link-commercial" style="cursor:default;margin-right:0.5rem"><span class="dl-icon">&#128274;</span> Commercial</span> Paid / licensed access &nbsp;&nbsp;
          <span class="data-link data-link-request" style="cursor:default;margin-right:0.5rem"><span class="dl-icon">&#9993;</span> Request</span> Contact DEPC or Vanuatu Spatial Solutions
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ TAB 4: DASHBOARD INTENT ═══ -->
  <div class="tab-content" id="tab-intent">
    <div class="tab-page">
      <h2>Dashboard Intent</h2>
      <p class="lead">Understanding why this dashboard exists, who it serves, and how it supports national biodiversity and environmental management in Vanuatu.</p>

      <div class="intent-highlight">
        <h3>Purpose Statement</h3>
        <p>This prototype dashboard is developed by Vanuatu Spatial Solutions for the Department of Environmental Protection and Conservation (DEPC) and the National Biodiversity Strategy and Action Plan (NBSAP) programme. Its primary intent is to provide a near-real-time, evidence-based decision-support tool for monitoring and controlling the spread of invasive Merremia vine species across Vanuatu's islands — supporting Vanuatu's commitments under the Convention on Biological Diversity (CBD) and the Kunming-Montreal Global Biodiversity Framework.</p>
      </div>

      <div class="section-card">
        <h3>Key Objectives</h3>
        <div class="objectives-grid">
          <div class="objective-card">
            <h4>Early Warning</h4>
            <p>Detect new Merremia outbreaks within one quarter of establishment, enabling rapid response before vine cover becomes entrenched and cost-prohibitive to remove.</p>
          </div>
          <div class="objective-card">
            <h4>Evidence-Based Prioritisation</h4>
            <p>Provide island-level risk scores and control priority rankings so that limited DEPC resources are directed where they will have the greatest ecological impact.</p>
          </div>
          <div class="objective-card">
            <h4>Trend Monitoring</h4>
            <p>Track the rate and direction of Merremia spread over time, enabling adaptive management strategies and quantitative reporting against NBSAP targets.</p>
          </div>
          <div class="objective-card">
            <h4>Accessible Reporting</h4>
            <p>Generate downloadable PDF reports suitable for DEPC field officers, NBSAP national reporting, and communication with international partners and donors.</p>
          </div>
          <div class="objective-card">
            <h4>Community Engagement</h4>
            <p>Present complex remote sensing data in an accessible format that can be shared with island communities, provincial governments, and conservation NGOs to build awareness and support for control efforts.</p>
          </div>
          <div class="objective-card">
            <h4>NBSAP Target Tracking</h4>
            <p>Directly supports NBSAP Target 6 (invasive alien species management) by providing measurable indicators on extent, rate of spread, and management effectiveness for Merremia across all surveyed islands.</p>
          </div>
        </div>
      </div>

      <div class="section-card">
        <h3>Intended Users</h3>
        <ul>
          <li><strong>DEPC officers and rangers</strong> — for operational planning, resource allocation, and field survey coordination</li>
          <li><strong>NBSAP focal point and reporting team</strong> — for national and CBD reporting on invasive species management progress</li>
          <li><strong>Provincial government environment units</strong> — for island-level situational awareness</li>
          <li><strong>Conservation NGOs and donors</strong> — for project monitoring and impact assessment</li>
          <li><strong>Research institutions (USP, CSIRO, SPC)</strong> — for scientific analysis and collaborative research</li>
          <li><strong>Community leaders and landowners</strong> — for awareness of Merremia impacts on their land and forests</li>
        </ul>
      </div>

      <div class="section-card">
        <h3>Prototype Disclaimer</h3>
        <p>This is a <strong>prototype dashboard</strong> intended to demonstrate the feasibility of satellite-based Merremia monitoring for Vanuatu. Data presented is based on the best available sources as of the last survey cycle, but should be validated with on-ground surveys before making management decisions. The classification model is under active development and accuracy may vary by island, season, and cloud cover conditions. Vanuatu Spatial Solutions welcomes feedback from all users to improve the system.</p>
      </div>
    </div>
  </div>

  <!-- ═══ TAB 5: LIVE DATA ═══ -->
  <div class="tab-content" id="tab-live">
    <div class="tab-page">
      <h2>Live Field Data</h2>
      <p class="lead">Access real-time field observations collected by rangers across Vanuatu using the Merremia Field Collector mobile app.</p>

      <div class="section-card">
        <h3>Live Dashboard</h3>
        <p>View all field-collected records on an interactive map with auto-refreshing data. The live dashboard updates every 5 seconds and shows records as they are synced from the field.</p>
        <a href="dashboard-live.html" target="_blank" rel="noopener" style="display:inline-block;margin-top:1rem;padding:0.75rem 1.5rem;background:linear-gradient(135deg,#065f46,#047857);color:#ecfdf5;border:2px solid #10b981;border-radius:0.5rem;font-weight:700;text-decoration:none;font-size:0.95rem;box-shadow:0 0 10px rgba(16,185,129,0.3)">Open Live Dashboard</a>
      </div>

      <div class="section-card">
        <h3>Field Collector App</h3>
        <p>The Merremia Field Collector is an offline-first Progressive Web App (PWA) for rangers to record Merremia sightings in the field. It captures GPS location, species, threat level, photos, and more — then syncs to GitHub when connected.</p>
        <a href="field-collector/" target="_blank" rel="noopener" style="display:inline-block;margin-top:1rem;padding:0.75rem 1.5rem;background:linear-gradient(135deg,#065f46,#047857);color:#ecfdf5;border:2px solid #10b981;border-radius:0.5rem;font-weight:700;text-decoration:none;font-size:0.95rem;box-shadow:0 0 10px rgba(16,185,129,0.3)">Open Field Collector</a>
      </div>

      <div class="section-card">
        <h3>How It Works</h3>
        <ul style="color:#cbd5e1;font-size:0.9rem;line-height:1.8;padding-left:1.25rem">
          <li><strong>Collect</strong> — Rangers use the Field Collector PWA to record Merremia observations with GPS, photos, and threat assessments</li>
          <li><strong>Sync</strong> — Data syncs automatically to the merremia-field-data repository on GitHub</li>
          <li><strong>Visualize</strong> — The Live Dashboard polls GitHub every 5 seconds and displays all records on a map with stats</li>
          <li><strong>Manage</strong> — Records can be deleted from the Field Collector with password protection</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- ═══ FOOTER ═══ -->
  <footer>
    <div class="footer-inner">
      <div class="footer-header">
        <img src="assets/vanuatu-coat-of-arms.png" alt="Coat of Arms of Vanuatu">
        <div class="footer-dept">
          <h3>Department of Environmental Protection &amp; Conservation</h3>
          <p>Ministry of Climate Change Adaptation, Meteorology &amp; Geo-Hazards,<br>Environment, Energy and Disaster Management</p>
        </div>
      </div>
      <hr class="footer-divider">
      <div class="footer-contacts">
        <div class="footer-contact-col">
          <h4>Head Office &mdash; Port Vila</h4>
          <p>PMB 9063, Port Vila, Shefa Province, Vanuatu<br>
          Phone: <a href="tel:+67825302">+678 25302</a> / <a href="tel:+67833430">+678 33430</a><br>
          Email: <a href="mailto:depc@vanuatu.gov.vu">depc@vanuatu.gov.vu</a><br>
          Web: <a href="https://environment.gov.vu" target="_blank" rel="noopener">environment.gov.vu</a></p>
        </div>
        <div class="footer-contact-col">
          <h4>Branch Office &mdash; Luganville</h4>
          <p>Sanma Provincial Government Council<br>PMB 239, Luganville, Sanma Province, Vanuatu</p>
        </div>
      </div>
      <div class="footer-bottom">
        Prototype dashboard created by <strong>Vanuatu Spatial Solutions</strong> for <strong>DEPC</strong> &amp; <strong>NBSAP</strong> &mdash; Merremia Vanuatu Ecological Monitoring Project
      </div>
    </div>
  </footer>

  <!-- ═══ SCRIPTS ═══ -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // ── Tab Switching ──
    function switchTab(name) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.getElementById('tab-' + name).classList.add('active');
      document.getElementById('tab-btn-' + name).classList.add('active');
      // Re-invalidate map size when switching to dashboard tab
      if (name === 'dashboard') setTimeout(() => map.invalidateSize(), 100);
    }

    // ── Last updated date ──
    document.getElementById('last-updated').textContent = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });

    // ── Map ──
    const baseLayers = {};
    let activeBasemap = 'dark';
    const map = L.map('map').setView([-16.5, 167.8], 6);
    baseLayers.dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 });
    baseLayers.streets = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 19 });
    baseLayers.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 });
    baseLayers.dark.addTo(map);

    function switchBasemap(type) {
      if (activeBasemap === type) return;
      map.removeLayer(baseLayers[activeBasemap]);
      baseLayers[type].addTo(map);
      baseLayers[type].bringToBack();
      activeBasemap = type;
      document.querySelectorAll('.basemap-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('bm-' + type).classList.add('active');
    }

    const sites = [
      { name: 'Efate \u2013 Port Vila', lat: -17.7334, lng: 168.3273, count: 128, threat: 'High' },
      { name: 'Espiritu Santo \u2013 Luganville', lat: -15.5150, lng: 167.1750, count: 95, threat: 'High' },
      { name: 'Tanna \u2013 Lenakel', lat: -19.5214, lng: 169.2636, count: 72, threat: 'Moderate' },
      { name: 'Malakula \u2013 Lakatoro', lat: -16.1000, lng: 167.4167, count: 64, threat: 'Moderate' },
      { name: 'Ambae \u2013 Saratamata', lat: -15.3833, lng: 167.8333, count: 41, threat: 'Low' },
      { name: 'Erromango \u2013 Dillon Bay', lat: -18.8000, lng: 169.0333, count: 33, threat: 'Low' },
      { name: 'Pentecost \u2013 Melsisi', lat: -15.9000, lng: 168.1833, count: 52, threat: 'Moderate' },
      { name: 'Epi \u2013 Ringdove Bay', lat: -16.7333, lng: 168.1667, count: 28, threat: 'Low' },
    ];

    const threatColors = { High: '#ef4444', Moderate: '#f59e0b', Low: '#10b981' };
    sites.forEach(s => {
      L.circleMarker([s.lat, s.lng], {
        radius: Math.sqrt(s.count) * 1.5,
        color: threatColors[s.threat],
        fillColor: threatColors[s.threat],
        fillOpacity: 0.5,
        weight: 1
      }).addTo(map);
    });

    // ── Chart colors ──
    const green = '#34d399';
    const gridColor = '#334155';
    Chart.defaults.color = '#94a3b8';

    // ── Bar chart: Coverage by island ──
    new Chart(document.getElementById('chart-islands'), {
      type: 'bar',
      data: {
        labels: ['Efate', 'Santo', 'Tanna', 'Malakula', 'Pentecost', 'Ambae', 'Erromango', 'Epi'],
        datasets: [{
          label: 'Area (ha)',
          data: [620, 480, 310, 275, 185, 120, 90, 60],
          backgroundColor: ['#ef4444','#ef4444','#f59e0b','#f59e0b','#10b981','#10b981','#10b981','#10b981'],
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { color: gridColor } },
          y: { grid: { color: gridColor }, title: { display: true, text: 'Hectares' } }
        }
      }
    });

    // ── Line chart: Spread trend ──
    const trendLabels = ['2020 Q1','2020 Q3','2021 Q1','2021 Q3','2022 Q1','2022 Q3','2023 Q1','2023 Q3','2024 Q1','2024 Q3','2025 Q1','2025 Q3'];
    const trendData = [820, 910, 1020, 1100, 1240, 1350, 1480, 1580, 1720, 1860, 1980, 2140];
    new Chart(document.getElementById('chart-trend'), {
      type: 'line',
      data: {
        labels: trendLabels,
        datasets: [{
          label: 'Total area (ha)',
          data: trendData,
          borderColor: green,
          backgroundColor: 'rgba(52,211,153,0.1)',
          fill: true,
          tension: 0.3,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { color: gridColor } },
          y: { grid: { color: gridColor }, title: { display: true, text: 'Hectares' } }
        }
      }
    });

    // ── Background Analysis Engine (Web Worker) ──
    const speciesData = [
      { species: 'M. peltata', count: 482, threat: 'High' },
      { species: 'M. vitifolia', count: 215, threat: 'Moderate' },
      { species: 'M. tridentata', count: 167, threat: 'Moderate' },
      { species: 'M. gemella', count: 98, threat: 'Low' },
      { species: 'M. umbellata', count: 73, threat: 'Low' },
      { species: 'M. tuberosa', count: 41, threat: 'Low' },
      { species: 'M. dissecta', count: 29, threat: 'Low' },
    ];
    const islandData = [
      { island: 'Efate', area: 620 },
      { island: 'Espiritu Santo', area: 480 },
      { island: 'Tanna', area: 310 },
      { island: 'Malakula', area: 275 },
      { island: 'Pentecost', area: 185 },
      { island: 'Ambae', area: 120 },
      { island: 'Erromango', area: 90 },
      { island: 'Epi', area: 60 },
    ];

    const workerCode = '\
      self.onmessage = function(e) {\
        var d = e.data, trendData = d.trendData, speciesData = d.speciesData, islandData = d.islandData, sites = d.sites;\
        var n = trendData.length;\
        var xMean = (n - 1) / 2;\
        var yMean = trendData.reduce(function(a, b){ return a + b; }, 0) / n;\
        var num = 0, den = 0;\
        for (var i = 0; i < n; i++) { num += (i - xMean) * (trendData[i] - yMean); den += (i - xMean) * (i - xMean); }\
        var slope = num / den;\
        var intercept = yMean - slope * xMean;\
        var growthPerQuarter = slope;\
        var annualGrowthRate = (Math.pow(trendData[n - 1] / trendData[0], 1 / ((n - 1) / 2)) - 1) * 100;\
        self.postMessage({ type: "progress", step: "Growth rate analysis complete" });\
        var projections = [];\
        for (var i = 1; i <= 4; i++) { projections.push(Math.round(intercept + slope * (n - 1 + i))); }\
        self.postMessage({ type: "progress", step: "Spread projections computed" });\
        var totalObs = sites.reduce(function(s, x){ return s + x.count; }, 0);\
        var islandRisk = sites.map(function(s){ return { name: s.name, score: Math.round((s.count / totalObs) * 100), threat: s.threat }; }).sort(function(a, b){ return b.score - a.score; });\
        self.postMessage({ type: "progress", step: "Island risk scoring complete" });\
        var totalSpecies = speciesData.reduce(function(s, x){ return s + x.count; }, 0);\
        var dominance = speciesData.map(function(s){ return { species: s.species, pct: ((s.count / totalSpecies) * 100).toFixed(1), threat: s.threat }; });\
        self.postMessage({ type: "progress", step: "Species dominance analysis complete" });\
        var priorities = sites.map(function(s){ var u = s.threat === "High" ? 3 : s.threat === "Moderate" ? 2 : 1; return { name: s.name, urgency: u, density: (s.count / totalObs * 100).toFixed(1), priority: u * s.count }; }).sort(function(a, b){ return b.priority - a.priority; });\
        self.postMessage({ type: "progress", step: "Control priority matrix built" });\
        var threshold = 3000;\
        var currentArea = trendData[n - 1];\
        var quartersToThreshold = slope > 0 ? Math.ceil((threshold - currentArea) / slope) : null;\
        self.postMessage({ type: "progress", step: "Threshold projection complete" });\
        self.postMessage({ type: "done", results: { annualGrowthRate: annualGrowthRate.toFixed(1), growthPerQuarter: Math.round(growthPerQuarter), projections: projections, islandRisk: islandRisk, dominance: dominance, priorities: priorities, currentArea: currentArea, threshold: threshold, quartersToThreshold: quartersToThreshold } });\
      };\
    ';

    var analysisResults = null;
    var blob = new Blob([workerCode], { type: 'application/javascript' });
    var worker = new Worker(URL.createObjectURL(blob));

    worker.onmessage = function(e) {
      if (e.data.type === 'progress') {
        document.getElementById('analysis-text').textContent = e.data.step;
      }
      if (e.data.type === 'done') {
        analysisResults = e.data.results;
        document.getElementById('analysis-dot').classList.add('done');
        document.getElementById('analysis-text').textContent = 'Analysis complete \u2014 6 findings ready';
        document.getElementById('btn-download').disabled = false;
        renderFindings(analysisResults);
        worker.terminate();
      }
    };

    setTimeout(function() {
      worker.postMessage({ trendData: trendData, speciesData: speciesData, islandData: islandData, sites: sites });
    }, 500);

    function renderFindings(r) {
      var panel = document.getElementById('analysis-panel');
      var grid = document.getElementById('findings-grid');
      panel.style.display = '';

      var severityClass = function(v) { return v === 'critical' ? 'critical' : v === 'warn' ? 'warn' : ''; };
      var findings = [
        { title: 'Annual Growth Rate', result: r.annualGrowthRate + '% per year', detail: 'Average ' + r.growthPerQuarter + ' ha added per quarter', severity: parseFloat(r.annualGrowthRate) > 15 ? 'critical' : 'warn' },
        { title: 'Projected Spread (Next Year)', result: r.projections[3].toLocaleString() + ' ha', detail: 'Q1\u2013Q4 projections: ' + r.projections.map(function(p){ return p.toLocaleString(); }).join(', ') + ' ha', severity: 'warn' },
        { title: 'Highest-Risk Site', result: r.islandRisk[0].name, detail: 'Risk score: ' + r.islandRisk[0].score + '/100 \u2014 Threat level: ' + r.islandRisk[0].threat, severity: r.islandRisk[0].threat === 'High' ? 'critical' : 'warn' },
        { title: 'Dominant Species', result: r.dominance[0].species + ' (' + r.dominance[0].pct + '%)', detail: 'Threat level: ' + r.dominance[0].threat + ' \u2014 ' + r.dominance.length + ' species total', severity: r.dominance[0].threat === 'High' ? 'critical' : '' },
        { title: 'Top Control Priority', result: r.priorities[0].name, detail: 'Urgency \u00d7 density score: ' + r.priorities[0].priority + ' \u2014 ' + r.priorities[0].density + '% of all observations', severity: 'warn' },
        { title: 'Time to 3,000 ha Threshold', result: r.quartersToThreshold ? r.quartersToThreshold + ' quarters (~' + (r.quartersToThreshold / 4).toFixed(1) + ' years)' : 'N/A', detail: 'Current: ' + r.currentArea.toLocaleString() + ' ha \u2014 Threshold: ' + r.threshold.toLocaleString() + ' ha', severity: r.quartersToThreshold && r.quartersToThreshold <= 8 ? 'critical' : 'warn' },
      ];

      grid.innerHTML = findings.map(function(f) {
        return '<div class="finding ' + severityClass(f.severity) + '"><h4>' + f.title + '</h4><div class="result">' + f.result + '</div><div class="detail">' + f.detail + '</div></div>';
      }).join('');
    }

    // ── Report Generation (PDF) ──
    function downloadReport() {
      if (!analysisResults) return;
      var r = analysisResults;
      var jsPDF = window.jspdf.jsPDF;
      var doc = new jsPDF();
      var now = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
      var y = 20;

      var addHeading = function(text) { doc.setFontSize(14); doc.setTextColor(6, 95, 70); doc.text(text, 14, y); y += 8; };
      var addSubheading = function(text) { doc.setFontSize(11); doc.setTextColor(60, 60, 60); doc.text(text, 14, y); y += 6; };
      var addLine = function(text) { doc.setFontSize(10); doc.setTextColor(80, 80, 80); doc.text(text, 18, y); y += 5; };
      var addSpacer = function() { y += 4; };
      var checkPage = function() { if (y > 270) { doc.addPage(); y = 20; } };

      doc.setFontSize(20);
      doc.setTextColor(6, 78, 59);
      doc.text('Merremia Vanuatu', 14, y); y += 8;
      doc.text('Monitoring Report', 14, y); y += 10;
      doc.setFontSize(10);
      doc.setTextColor(120, 120, 120);
      doc.text('Generated: ' + now, 14, y); y += 5;
      doc.text('Prepared by Vanuatu Spatial Solutions for DEPC & NBSAP', 14, y); y += 5;
      doc.text('Report type: Automated background analysis', 14, y); y += 4;
      doc.setDrawColor(16, 185, 129);
      doc.setLineWidth(0.5);
      doc.line(14, y, 196, y); y += 10;

      addHeading('1. Executive Summary');
      addLine('Total area affected: ' + r.currentArea.toLocaleString() + ' hectares across 8 islands');
      addLine('Annual growth rate: ' + r.annualGrowthRate + '% per year (' + r.growthPerQuarter + ' ha/quarter)');
      addLine('Species tracked: ' + r.dominance.length + ' Merremia species');
      addLine('Survey sites: ' + sites.length + ' active monitoring sites');
      if (r.quartersToThreshold) {
        addLine('Projected time to 3,000 ha threshold: ' + r.quartersToThreshold + ' quarters (~' + (r.quartersToThreshold / 4).toFixed(1) + ' years)');
      }
      addSpacer(); checkPage();

      addHeading('2. Spread Projections');
      addSubheading('Projected coverage for the next 4 quarters:');
      r.projections.forEach(function(p, i) { addLine('  Quarter ' + (i + 1) + ': ' + p.toLocaleString() + ' ha'); });
      addSpacer(); checkPage();

      addHeading('3. Island Risk Assessment');
      r.islandRisk.forEach(function(ir) {
        addLine(ir.name + '  -  Risk score: ' + ir.score + '/100  |  Threat: ' + ir.threat);
      });
      addSpacer(); checkPage();

      addHeading('4. Species Dominance Analysis');
      r.dominance.forEach(function(d) {
        addLine(d.species + '  -  ' + d.pct + '% of observations  |  Threat: ' + d.threat);
      });
      addSpacer(); checkPage();

      addHeading('5. Control Priority Matrix');
      addSubheading('Sites ranked by urgency x observation density:');
      r.priorities.forEach(function(p, i) {
        addLine((i + 1) + '. ' + p.name + '  -  Priority score: ' + p.priority + '  |  Density: ' + p.density + '%');
        checkPage();
      });
      addSpacer(); checkPage();

      addHeading('6. Recommendations');
      var recs = [
        'Prioritize containment efforts on ' + r.priorities[0].name + ' (highest priority score)',
        'Focus biological control research on ' + r.dominance[0].species + ' (dominant species, ' + r.dominance[0].pct + '% of observations)',
        'Increase survey frequency on high-threat islands (Efate, Espiritu Santo)',
        'Establish buffer zones around unaffected areas on low-threat islands',
        r.quartersToThreshold ? 'Implement aggressive intervention before ' + r.threshold.toLocaleString() + ' ha threshold is reached in ~' + (r.quartersToThreshold / 4).toFixed(1) + ' years' : 'Monitor growth rate trend for changes',
      ];
      recs.forEach(function(rec, i) { addLine((i + 1) + '. ' + rec); checkPage(); });

      y += 10; checkPage();
      doc.setDrawColor(16, 185, 129);
      doc.line(14, y, 196, y); y += 6;
      doc.setFontSize(8);
      doc.setTextColor(150, 150, 150);
      doc.text('Vanuatu Spatial Solutions for DEPC & NBSAP - Merremia Monitoring Report - ' + now, 14, y);

      doc.save('merremia-vanuatu-report-' + new Date().toISOString().slice(0, 10) + '.pdf');
    }
  </script>
</body>
</html>
