<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#065f46">
  <meta name="description" content="Real-time field data from Merremia monitoring across Vanuatu">
  <title>Merremia Live Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh}
    header{background:linear-gradient(135deg,#065f46,#064e3b);padding:1.25rem 2rem 1rem;border-bottom:2px solid #10b981}
    header h1{font-size:1.5rem;color:#ecfdf5}
    header p{color:#6ee7b7;font-size:0.875rem;margin-top:0.25rem}
    .attribution{margin-top:0.6rem;padding:0.5rem 0.85rem;background:rgba(0,0,0,0.25);border-radius:0.4rem;display:inline-block;font-size:0.78rem;color:#a7f3d0;border:1px solid rgba(167,243,208,0.2)}
    .attribution strong{color:#ecfdf5}
    .config-bar{display:flex;align-items:center;gap:0.75rem;padding:0.75rem 2rem;background:#1e293b;border-bottom:1px solid #334155;flex-wrap:wrap}
    .config-bar label{font-size:0.8rem;color:#94a3b8}
    .config-bar input{padding:0.4rem 0.6rem;background:#0f172a;border:1px solid #334155;border-radius:0.35rem;color:#e2e8f0;font-size:0.8rem}
    .config-bar button{padding:0.4rem 1rem;background:#065f46;color:#ecfdf5;border:1px solid #10b981;border-radius:0.35rem;font-size:0.8rem;font-weight:600;cursor:pointer}
    .config-bar button:hover{background:#047857}
    .status-msg{font-size:0.8rem;color:#94a3b8;margin-left:auto}
    .status-msg.ok{color:#34d399}
    .status-msg.err{color:#ef4444}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;padding:1.5rem 2rem}
    .card{background:#1e293b;border-radius:0.75rem;padding:1.25rem;border:1px solid #334155}
    .card h3{font-size:0.7rem;text-transform:uppercase;letter-spacing:0.05em;color:#94a3b8;margin-bottom:0.4rem}
    .card .value{font-size:1.8rem;font-weight:700;color:#34d399}
    .card .sub{font-size:0.78rem;color:#64748b;margin-top:0.2rem}
    .map-section{padding:0 2rem 1.5rem}
    .map-panel{background:#1e293b;border-radius:0.75rem;padding:1.25rem;border:1px solid #334155}
    .map-panel h2{font-size:1rem;color:#cbd5e1;margin-bottom:1rem;padding-bottom:0.5rem;border-bottom:1px solid #334155}
    #live-map{height:450px;border-radius:0.5rem}
    .records-section{padding:0 2rem 1.5rem}
    .records-panel{background:#1e293b;border-radius:0.75rem;padding:1.25rem;border:1px solid #334155}
    .records-panel h2{font-size:1rem;color:#cbd5e1;margin-bottom:1rem;padding-bottom:0.5rem;border-bottom:1px solid #334155}
    table{width:100%;border-collapse:collapse;font-size:0.82rem}
    th{text-align:left;color:#94a3b8;padding:0.5rem;border-bottom:1px solid #334155;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.05em}
    td{padding:0.5rem;border-bottom:1px solid #0f172a;color:#cbd5e1}
    .badge{display:inline-block;padding:0.1rem 0.45rem;border-radius:9999px;font-size:0.65rem;font-weight:600}
    .badge-high{background:#7f1d1d;color:#fca5a5}
    .badge-moderate{background:#78350f;color:#fcd34d}
    .badge-low{background:#064e3b;color:#6ee7b7}
    .empty{text-align:center;padding:3rem;color:#64748b;font-size:0.9rem}
    .filter-bar{display:flex;gap:0.75rem;flex-wrap:wrap;margin-bottom:1rem}
    .filter-bar select{padding:0.4rem 0.6rem;background:#0f172a;border:1px solid #334155;border-radius:0.35rem;color:#e2e8f0;font-size:0.8rem;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 0.5rem center;padding-right:1.5rem;min-width:140px}
    .filter-bar select:focus{outline:none;border-color:#10b981}
    .table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
    .download-section{padding:0 2rem 1.5rem}
    .download-panel{background:#1e293b;border-radius:0.75rem;padding:1.25rem;border:1px solid #334155}
    .download-panel h2{font-size:1rem;color:#cbd5e1;margin-bottom:0.5rem;padding-bottom:0.5rem;border-bottom:1px solid #334155}
    .download-panel p{font-size:0.82rem;color:#94a3b8;margin-bottom:1rem}
    .dl-btns{display:flex;gap:0.75rem;flex-wrap:wrap}
    .dl-btn{display:inline-flex;align-items:center;gap:0.4rem;padding:0.6rem 1.25rem;border-radius:0.5rem;font-size:0.85rem;font-weight:600;border:none;cursor:pointer;transition:all 0.2s}
    .dl-btn:hover{transform:translateY(-1px)}
    .dl-btn:disabled{opacity:0.4;cursor:not-allowed;transform:none}
    .dl-btn-json{background:#064e3b;color:#6ee7b7;border:1px solid #10b981}
    .dl-btn-json:hover:not(:disabled){background:#065f46;box-shadow:0 2px 8px rgba(16,185,129,0.3)}
    .dl-btn-csv{background:#1e3a5f;color:#93c5fd;border:1px solid #3b82f6}
    .dl-btn-csv:hover:not(:disabled){background:#1e40af;box-shadow:0 2px 8px rgba(59,130,246,0.3)}
    .dl-btn-geojson{background:#312e81;color:#a5b4fc;border:1px solid #6366f1}
    .dl-btn-geojson:hover:not(:disabled){background:#3730a3;box-shadow:0 2px 8px rgba(99,102,241,0.3)}
    .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center}
    .modal-overlay.active{display:flex}
    .modal-box{background:#1e293b;border:1px solid #334155;border-radius:0.75rem;padding:1.5rem;width:90%;max-width:360px;text-align:center}
    .modal-box h3{color:#ecfdf5;margin-bottom:0.5rem;font-size:1rem}
    .modal-box p{color:#94a3b8;font-size:0.82rem;margin-bottom:1rem}
    .modal-box input{width:100%;padding:0.6rem 0.75rem;background:#0f172a;border:1px solid #334155;border-radius:0.4rem;color:#e2e8f0;font-size:0.85rem;text-align:center;margin-bottom:0.75rem}
    .modal-box input:focus{outline:none;border-color:#10b981}
    .modal-box .modal-err{color:#ef4444;font-size:0.78rem;margin-bottom:0.5rem;display:none}
    .modal-actions{display:flex;gap:0.5rem;justify-content:center}
    .modal-actions button{padding:0.5rem 1.25rem;border-radius:0.4rem;font-size:0.82rem;font-weight:600;cursor:pointer;border:none}
    .modal-cancel{background:#334155;color:#94a3b8}
    .modal-cancel:hover{background:#475569}
    .modal-confirm{background:#065f46;color:#ecfdf5;border:1px solid #10b981}
    .modal-confirm:hover{background:#047857}
    @media(max-width:768px){
      .config-bar{padding:0.75rem 1rem}
      .config-bar input{width:100%!important}
      .grid{padding:1rem}
      .map-section,.records-section,.download-section{padding:0 1rem 1rem}
      #live-map{height:300px}
    }
    footer{text-align:center;padding:1.25rem;color:#475569;font-size:0.75rem;border-top:1px solid #1e293b}
    footer strong{color:#94a3b8}
  </style>
</head>
<body>
  <header>
    <h1>Merremia Live Dashboard</h1>
    <p>Real-time field data from Merremia monitoring across Vanuatu</p>
    <div class="attribution">
      Prototype dashboard created by <strong>Vanuatu Spatial Solutions</strong> for <strong>DEPC</strong> &amp; <strong>NBSAP</strong>
    </div>
  </header>

  <div class="config-bar">
    <input id="cfg-owner" type="hidden" value="welinrj">
    <input id="cfg-repo" type="hidden" value="merremia-field-data">
    <input id="cfg-token" type="hidden" value="">
    <button onclick="loadFieldData()">Load Data</button>
    <span class="status-msg" id="status-msg"></span>
  </div>

  <div class="grid" id="summary-cards">
    <div class="card"><h3>Field Records</h3><div class="value" id="v-records">--</div><div class="sub">observations collected</div></div>
    <div class="card"><h3>Total Count</h3><div class="value" id="v-count">--</div><div class="sub">individual sightings</div></div>
    <div class="card"><h3>Area Surveyed</h3><div class="value" id="v-area">--</div><div class="sub">hectares reported</div></div>
    <div class="card"><h3>Islands Covered</h3><div class="value" id="v-islands">--</div><div class="sub">with field data</div></div>
    <div class="card"><h3>Latest Record</h3><div class="value" id="v-latest" style="font-size:1.1rem">--</div><div class="sub" id="v-latest-sub">waiting for data</div></div>
  </div>

  <div class="map-section">
    <div class="map-panel">
      <h2>Field Observation Map</h2>
      <div id="live-map"></div>
    </div>
  </div>

  <div class="records-section">
    <div class="records-panel">
      <h2>Recent Records</h2>
      <div class="filter-bar" id="filter-bar" style="display:none">
        <select id="filter-threat" onchange="applyFilters()">
          <option value="">All Threats</option>
        </select>
        <select id="filter-species" onchange="applyFilters()">
          <option value="">All Species</option>
        </select>
        <select id="filter-island" onchange="applyFilters()">
          <option value="">All Islands</option>
        </select>
      </div>
      <div id="records-table">
        <div class="empty">Click "Load Data" to see field-collected records.</div>
      </div>
    </div>
  </div>

  <div class="download-section">
    <div class="download-panel">
      <h2>Download Live Dataset</h2>
      <p>Export the current field-collected data. Password required for access.</p>
      <div class="dl-btns">
        <button class="dl-btn dl-btn-json" id="btn-dl-json" disabled onclick="requestDownload('json')">&#11015; JSON</button>
        <button class="dl-btn dl-btn-csv" id="btn-dl-csv" disabled onclick="requestDownload('csv')">&#11015; CSV</button>
        <button class="dl-btn dl-btn-geojson" id="btn-dl-geojson" disabled onclick="requestDownload('geojson')">&#11015; GeoJSON</button>
      </div>
    </div>
  </div>

  <!-- Password Modal -->
  <div class="modal-overlay" id="dl-modal">
    <div class="modal-box">
      <h3>Enter Password</h3>
      <p>A password is required to download live datasets.</p>
      <input type="password" id="dl-password" placeholder="Enter password" onkeydown="if(event.key==='Enter')confirmDownload()">
      <div class="modal-err" id="dl-error">Incorrect password. Try again.</div>
      <div class="modal-actions">
        <button class="modal-cancel" onclick="closeDlModal()">Cancel</button>
        <button class="modal-confirm" onclick="confirmDownload()">Download</button>
      </div>
    </div>
  </div>

  <footer>
    Prototype dashboard created by <strong>Vanuatu Spatial Solutions</strong> for <strong>DEPC</strong> &amp; <strong>NBSAP</strong> &mdash; Live Field Data View
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="merremia-connector.js"></script>
  <script>
    var liveMap = L.map('live-map').setView([-16.5, 167.8], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors', maxZoom: 18
    }).addTo(liveMap);

    var markersLayer = L.layerGroup().addTo(liveMap);
    var threatColors = { High: '#ef4444', Moderate: '#f59e0b', Low: '#10b981' };

    // Load saved config
    try {
      var saved = JSON.parse(localStorage.getItem('merremia_live_cfg') || '{}');
      if (saved.owner) document.getElementById('cfg-owner').value = saved.owner;
      if (saved.repo) document.getElementById('cfg-repo').value = saved.repo;
      if (saved.token) document.getElementById('cfg-token').value = saved.token;
    } catch(e) {}

    var liveConnector = null;
    var REFRESH_INTERVAL = 5000; // 5 seconds — real-time feel
    var lastDataSha = null;

    async function loadFieldData() {
      var owner = document.getElementById('cfg-owner').value.trim();
      var repo = document.getElementById('cfg-repo').value.trim();
      var token = document.getElementById('cfg-token').value.trim();
      var status = document.getElementById('status-msg');

      if (!owner) { status.textContent = 'Enter a GitHub owner'; status.className = 'status-msg err'; return; }

      // Save config
      localStorage.setItem('merremia_live_cfg', JSON.stringify({ owner: owner, repo: repo, token: token }));

      status.textContent = 'Loading...';
      status.className = 'status-msg';

      // Stop any existing auto-refresh
      if (liveConnector) liveConnector.stopAutoRefresh();
      lastDataSha = null;

      liveConnector = new MerremiaConnector({ owner: owner, repo: repo, token: token, cacheTTL: 3000 });

      // Start auto-refreshing every 5 seconds for near-instant updates
      liveConnector.startAutoRefresh(REFRESH_INTERVAL, function(data) {
        if (!data || !data.records || data.records.length === 0) {
          status.textContent = 'No records found yet — checking every 5s...';
          status.className = 'status-msg err';
          return;
        }

        var now = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

        // Re-render when SHA changes (detects adds, deletes, and edits)
        var currentSha = liveConnector._lastSha || '';
        if (currentSha !== lastDataSha) {
          renderSummary(data);
          renderMap(data);
          renderTable(data.records);
          lastDataSha = currentSha;
        }
        enableDownloadButtons(data);
        status.textContent = data.records.length + ' records \u2014 live (' + now + ')';
        status.className = 'status-msg ok';
      });
    }

    function renderSummary(data) {
      var s = data.stats;
      document.getElementById('v-records').textContent = s.recordCount;
      document.getElementById('v-count').textContent = s.totalObservations.toLocaleString();
      document.getElementById('v-area').textContent = s.totalAreaHectares.toLocaleString();
      document.getElementById('v-islands').textContent = s.islandCount;
      if (data.lastUpdated) {
        var d = new Date(data.lastUpdated);
        document.getElementById('v-latest').textContent = d.toLocaleDateString('en-GB', { day:'numeric', month:'short' });
        var latest = data.records[0];
        if (latest) document.getElementById('v-latest-sub').textContent = (latest.species || []).join(', ') + ' at ' + (latest.island || '');
      }
    }

    function renderMap(data) {
      markersLayer.clearLayers();
      var features = data.geoJSON ? data.geoJSON.features : [];
      features.forEach(function(f) {
        var p = f.properties;
        var coords = f.geometry.coordinates;
        var color = threatColors[p.threatLevel === 'high' ? 'High' : p.threatLevel === 'moderate' ? 'Moderate' : 'Low'] || '#94a3b8';
        L.circleMarker([coords[1], coords[0]], {
          radius: Math.max(5, Math.sqrt(p.count || 1) * 2),
          color: color, fillColor: color, fillOpacity: 0.6, weight: 1
        }).addTo(markersLayer)
          .bindPopup('<strong>' + p.speciesLabel + '</strong><br>' + p.island + (p.siteName ? ' — ' + p.siteName : '') + '<br>Count: ' + (p.count || 1) + ' | Threat: ' + p.threatLevel + '<br><small>' + new Date(p.timestamp).toLocaleDateString('en-GB') + ' by ' + (p.observer || 'Unknown') + '</small>');
      });

      if (features.length > 0) {
        var bounds = L.latLngBounds(features.map(function(f) { return [f.geometry.coordinates[1], f.geometry.coordinates[0]]; }));
        liveMap.fitBounds(bounds, { padding: [30, 30] });
      }
    }

    var allRecords = [];

    function renderTable(records) {
      allRecords = records;
      populateFilters(records);
      document.getElementById('filter-bar').style.display = 'flex';
      applyFilters();
    }

    function populateFilters(records) {
      var threats = {}, species = {}, islands = {};
      records.forEach(function(r) {
        var t = r.threatLevel || 'low';
        threats[t.charAt(0).toUpperCase() + t.slice(1)] = true;
        var sp = Array.isArray(r.species) ? r.species : (r.species ? [r.species] : []);
        sp.forEach(function(s) { if (s) species[s] = true; });
        if (r.island) islands[r.island] = true;
      });

      fillSelect('filter-threat', 'All Threats', Object.keys(threats).sort());
      fillSelect('filter-species', 'All Species', Object.keys(species).sort());
      fillSelect('filter-island', 'All Islands', Object.keys(islands).sort());
    }

    function fillSelect(id, allLabel, values) {
      var el = document.getElementById(id);
      var current = el.value;
      el.innerHTML = '<option value="">' + allLabel + '</option>' + values.map(function(v) { return '<option value="' + v + '">' + v + '</option>'; }).join('');
      if (current && values.indexOf(current) >= 0) el.value = current;
    }

    function applyFilters() {
      var ft = document.getElementById('filter-threat').value.toLowerCase();
      var fs = document.getElementById('filter-species').value;
      var fi = document.getElementById('filter-island').value;

      var filtered = allRecords.filter(function(r) {
        if (ft && (r.threatLevel || 'low') !== ft) return false;
        if (fs) {
          var sp = Array.isArray(r.species) ? r.species : [r.species || ''];
          if (sp.indexOf(fs) < 0) return false;
        }
        if (fi && r.island !== fi) return false;
        return true;
      });

      var sorted = filtered.slice().sort(function(a, b) { return new Date(b.timestamp) - new Date(a.timestamp); });
      var rows = sorted.slice(0, 50).map(function(r) {
        var d = new Date(r.timestamp).toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric' });
        var threat = r.threatLevel || 'low';
        var badge = threat === 'high' ? 'badge-high' : threat === 'moderate' ? 'badge-moderate' : 'badge-low';
        var threatLabel = threat.charAt(0).toUpperCase() + threat.slice(1);
        var speciesLabel = Array.isArray(r.species) ? r.species.join(', ') : (r.species || '-');
        return '<tr><td>' + d + '</td><td>' + (r.island || '-') + '</td><td>' + (r.siteName || '-') + '</td><td><em>' + speciesLabel + '</em></td><td>' + (r.count || 1) + '</td><td><span class="badge ' + badge + '">' + threatLabel + '</span></td><td>' + (r.coverageArea || '-') + '</td><td>' + (r.observer || '-') + '</td></tr>';
      }).join('');

      var countNote = sorted.length > 50 ? '<p style="text-align:center;color:#64748b;font-size:0.75rem;margin-top:0.75rem">Showing 50 of ' + sorted.length + ' records</p>' : '';
      var filterNote = (ft || fs || fi) ? '<p style="text-align:center;color:#94a3b8;font-size:0.75rem;margin-top:0.5rem">Showing ' + sorted.length + ' of ' + allRecords.length + ' records</p>' : '';
      document.getElementById('records-table').innerHTML = '<div class="table-scroll"><table><thead><tr><th>Date</th><th>Island</th><th>Site</th><th>Species</th><th>Count</th><th>Threat</th><th>Area (ha)</th><th>Observer</th></tr></thead><tbody>' + rows + '</tbody></table></div>' + countNote + filterNote;
    }

    // ── Download functionality ──
    var DOWNLOAD_PASSWORD = 'M3r3mia@2025';
    var pendingFormat = null;
    var currentRecords = null;
    var currentGeoJSON = null;

    function enableDownloadButtons(data) {
      currentRecords = data.records;
      currentGeoJSON = data.geoJSON;
      document.getElementById('btn-dl-json').disabled = false;
      document.getElementById('btn-dl-csv').disabled = false;
      document.getElementById('btn-dl-geojson').disabled = false;
    }

    function requestDownload(format) {
      if (!currentRecords || currentRecords.length === 0) return;
      pendingFormat = format;
      document.getElementById('dl-password').value = '';
      document.getElementById('dl-error').style.display = 'none';
      document.getElementById('dl-modal').classList.add('active');
      document.getElementById('dl-password').focus();
    }

    function closeDlModal() {
      document.getElementById('dl-modal').classList.remove('active');
      pendingFormat = null;
    }

    function confirmDownload() {
      var pw = document.getElementById('dl-password').value;
      if (pw !== DOWNLOAD_PASSWORD) {
        document.getElementById('dl-error').style.display = 'block';
        document.getElementById('dl-password').value = '';
        document.getElementById('dl-password').focus();
        return;
      }
      document.getElementById('dl-error').style.display = 'none';
      var format = pendingFormat || 'json';
      closeDlModal();
      var blob, filename;
      var ts = new Date().toISOString().slice(0,10);

      if (format === 'json') {
        blob = new Blob([JSON.stringify(currentRecords, null, 2)], { type: 'application/json' });
        filename = 'merremia-field-data-' + ts + '.json';
      } else if (format === 'csv') {
        var csv = recordsToCSV(currentRecords);
        blob = new Blob([csv], { type: 'text/csv' });
        filename = 'merremia-field-data-' + ts + '.csv';
      } else if (format === 'geojson') {
        blob = new Blob([JSON.stringify(currentGeoJSON, null, 2)], { type: 'application/geo+json' });
        filename = 'merremia-field-data-' + ts + '.geojson';
      }

      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function recordsToCSV(records) {
      var headers = ['id','timestamp','island','siteName','species','count','threatLevel','coverageArea','observer','latitude','longitude','accuracy','notes'];
      var rows = records.map(function(r) {
        return [
          r.id || '',
          r.timestamp || '',
          r.island || '',
          r.siteName || '',
          Array.isArray(r.species) ? r.species.join('; ') : (r.species || ''),
          r.count || '',
          r.threatLevel || '',
          r.coverageArea || '',
          r.observer || '',
          r.gps && r.gps.lat ? r.gps.lat : '',
          r.gps && r.gps.lng ? r.gps.lng : '',
          r.gps && r.gps.accuracy ? r.gps.accuracy : '',
          (r.notes || '').replace(/"/g, '""')
        ].map(function(v) { return '"' + String(v) + '"'; }).join(',');
      });
      return headers.join(',') + '\n' + rows.join('\n');
    }

    // Close modal on overlay click
    document.getElementById('dl-modal').addEventListener('click', function(e) {
      if (e.target === this) closeDlModal();
    });

    // Auto-load if config exists
    if (document.getElementById('cfg-owner').value) {
      setTimeout(loadFieldData, 300);
    }
  </script>
</body>
</html>
