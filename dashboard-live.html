<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#065f46">
  <meta name="description" content="DEPC real-time environmental field data monitoring">
  <title>DEPC Live Dashboard</title>
  <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="assets/favicon-180.png">
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0a0f1e;color:#e2e8f0;min-height:100vh;-webkit-font-smoothing:antialiased}
    header{background:linear-gradient(135deg,#052e23 0%,#064e3b 50%,#065f46 100%);padding:1.5rem 2rem 1.25rem;border-bottom:1px solid rgba(16,185,129,0.3);box-shadow:0 4px 24px rgba(0,0,0,0.3)}
    header h1{font-size:1.4rem;font-weight:800;color:#ecfdf5;letter-spacing:-0.02em}
    header p{color:rgba(110,231,183,0.8);font-size:0.82rem;margin-top:0.2rem;font-weight:500}
    .header-row{display:flex;align-items:center;gap:1.25rem}
    .header-logo{height:50px;width:auto;border-radius:0.5rem;background:rgba(255,255,255,0.95);padding:4px;flex-shrink:0;box-shadow:0 2px 12px rgba(0,0,0,0.2)}
    .logo-group{display:flex;align-items:center;gap:0.75rem;flex-shrink:0}
    .logo-dept-name{font-size:0.72rem;font-weight:700;color:rgba(236,253,245,0.9);line-height:1.3;letter-spacing:0.04em;max-width:200px;text-transform:uppercase}
    .config-bar{display:flex;align-items:center;gap:0.75rem;padding:0.75rem 2rem;background:#111827;border-bottom:1px solid rgba(51,65,85,0.4);flex-wrap:wrap}
    .config-bar button{padding:0.4rem 1rem;background:#065f46;color:#ecfdf5;border:1px solid rgba(16,185,129,0.4);border-radius:0.4rem;font-size:0.78rem;font-weight:600;cursor:pointer;transition:all 0.2s}
    .config-bar button:hover{background:#047857;box-shadow:0 2px 8px rgba(16,185,129,0.2)}
    .status-msg{font-size:0.8rem;color:#94a3b8;margin-left:auto}
    .status-msg.ok{color:#34d399}
    .status-msg.err{color:#ef4444}
    .cat-tabs{display:flex;background:#111827;border-bottom:1px solid rgba(51,65,85,0.4);padding:0 2rem;overflow-x:auto;-webkit-overflow-scrolling:touch}
    .cat-tab{padding:0.75rem 1.25rem;background:none;border:none;border-bottom:2px solid transparent;color:#64748b;font-size:0.8rem;font-weight:600;cursor:pointer;white-space:nowrap;transition:all 0.25s ease;letter-spacing:0.01em}
    .cat-tab:hover{color:#cbd5e1;background:rgba(255,255,255,0.02)}
    .cat-tab.active{border-bottom-color:#10b981;color:#34d399;background:linear-gradient(180deg,transparent 0%,rgba(16,185,129,0.04) 100%)}
    .cat-tab.t-merremia.active{border-bottom-color:#10b981;color:#6ee7b7}
    .cat-tab.t-degraded.active{border-bottom-color:#ef4444;color:#fca5a5}
    .cat-tab.t-restoration.active{border-bottom-color:#3b82f6;color:#93c5fd}
    .cat-tab.t-threatened.active{border-bottom-color:#a855f7;color:#d8b4fe}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;padding:1.5rem 2rem}
    .card{background:linear-gradient(145deg,#151d2e,#1a2438);border-radius:0.75rem;padding:1.25rem;border:1px solid rgba(51,65,85,0.5);transition:all 0.3s ease;position:relative;overflow:hidden}
    .card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#10b981,#34d399);opacity:0;transition:opacity 0.3s ease}
    .card:hover{border-color:rgba(16,185,129,0.2);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.3)}
    .card:hover::before{opacity:1}
    .card h3{font-size:0.68rem;text-transform:uppercase;letter-spacing:0.08em;color:#64748b;margin-bottom:0.4rem;font-weight:700}
    .card .value{font-size:1.8rem;font-weight:800;background:linear-gradient(135deg,#34d399,#6ee7b7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .card .sub{font-size:0.76rem;color:#475569;margin-top:0.2rem;font-weight:500}
    .map-section{padding:0 2rem 1.5rem}
    .map-panel{background:linear-gradient(145deg,#151d2e,#1a2438);border-radius:0.75rem;padding:1.25rem;border:1px solid rgba(51,65,85,0.5)}
    .map-panel h2{font-size:0.9rem;font-weight:700;color:#94a3b8;margin-bottom:1rem;padding-bottom:0.75rem;border-bottom:1px solid rgba(51,65,85,0.4);text-transform:uppercase;letter-spacing:0.04em}
    #live-map{height:450px;border-radius:0.5rem}
    .map-wrap{position:relative}
    .basemap-toggle{position:absolute;top:10px;left:10px;z-index:2;display:flex;border-radius:0.4rem;overflow:hidden;border:1px solid #334155;box-shadow:0 2px 8px rgba(0,0,0,0.4)}
    .basemap-btn{padding:0.4rem 0.75rem;background:#1e293b;color:#94a3b8;border:none;font-size:0.7rem;font-weight:600;cursor:pointer;transition:all 0.2s;border-right:1px solid #334155}
    .basemap-btn:last-child{border-right:none}
    .basemap-btn.active{background:#065f46;color:#ecfdf5}
    .basemap-btn:hover:not(.active){background:#334155;color:#e2e8f0}
    .map-marker{width:22px;height:22px;border-radius:50%;border:2px solid rgba(255,255,255,0.9);cursor:pointer;box-shadow:0 0 8px rgba(0,0,0,0.5)}
    .maplibregl-popup-content{background:#1e293b;color:#e2e8f0;border:1px solid #334155;border-radius:0.5rem;padding:0.75rem;font-size:0.8rem;max-width:250px}
    .maplibregl-popup-content strong{color:#34d399}
    .maplibregl-popup-close-button{color:#94a3b8;font-size:1.2rem}
    .maplibregl-popup-tip{border-top-color:#1e293b}
    .popup-photos{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
    .popup-photos img{width:60px;height:45px;object-fit:cover;border-radius:3px;cursor:pointer;border:1px solid #334155}
    .popup-photos img:hover{border-color:#10b981}
    .photo-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:9999;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .photo-overlay img{max-width:90%;max-height:90%;border-radius:0.5rem}
    .records-section{padding:0 2rem 1.5rem}
    .records-panel{background:linear-gradient(145deg,#151d2e,#1a2438);border-radius:0.75rem;padding:1.25rem;border:1px solid rgba(51,65,85,0.5)}
    .records-panel h2{font-size:0.9rem;font-weight:700;color:#94a3b8;margin-bottom:1rem;padding-bottom:0.75rem;border-bottom:1px solid rgba(51,65,85,0.4);text-transform:uppercase;letter-spacing:0.04em}
    table{width:100%;border-collapse:collapse;font-size:0.8rem}
    th{text-align:left;color:#475569;padding:0.6rem 0.5rem;border-bottom:1px solid rgba(51,65,85,0.4);font-size:0.65rem;text-transform:uppercase;letter-spacing:0.08em;font-weight:700}
    td{padding:0.6rem 0.5rem;border-bottom:1px solid rgba(15,23,42,0.6);color:#94a3b8;transition:background 0.15s}
    tr:hover td{background:rgba(255,255,255,0.02)}
    .badge{display:inline-block;padding:0.1rem 0.45rem;border-radius:9999px;font-size:0.65rem;font-weight:600}
    .badge-high,.badge-severe,.badge-cr{background:#7f1d1d;color:#fca5a5}
    .badge-moderate,.badge-en{background:#78350f;color:#fcd34d}
    .badge-low,.badge-mild,.badge-vu{background:#064e3b;color:#6ee7b7}
    .badge-nt{background:#1e3a5f;color:#93c5fd}
    .badge-dd{background:#334155;color:#94a3b8}
    .badge-planning,.badge-early{background:#312e81;color:#a5b4fc}
    .badge-mid{background:#1e3a5f;color:#93c5fd}
    .badge-established,.badge-mature{background:#064e3b;color:#6ee7b7}
    .empty{text-align:center;padding:3rem;color:#64748b;font-size:0.9rem}
    .filter-bar{display:flex;gap:0.75rem;flex-wrap:wrap;margin-bottom:1rem}
    .filter-bar select{padding:0.4rem 0.6rem;background:#0f172a;border:1px solid #334155;border-radius:0.35rem;color:#e2e8f0;font-size:0.8rem;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 0.5rem center;padding-right:1.5rem;min-width:130px}
    .filter-bar select:focus{outline:none;border-color:#10b981}
    .table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
    .download-section{padding:0 2rem 1.5rem}
    .download-panel{background:linear-gradient(145deg,#151d2e,#1a2438);border-radius:0.75rem;padding:1.25rem;border:1px solid rgba(51,65,85,0.5)}
    .download-panel h2{font-size:0.9rem;font-weight:700;color:#94a3b8;margin-bottom:0.5rem;padding-bottom:0.75rem;border-bottom:1px solid rgba(51,65,85,0.4);text-transform:uppercase;letter-spacing:0.04em}
    .download-panel p{font-size:0.8rem;color:#64748b;margin-bottom:1rem}
    .dl-btns{display:flex;gap:0.75rem;flex-wrap:wrap}
    .dl-btn{display:inline-flex;align-items:center;gap:0.4rem;padding:0.6rem 1.25rem;border-radius:0.5rem;font-size:0.85rem;font-weight:600;border:none;cursor:pointer;transition:all 0.2s}
    .dl-btn:hover{transform:translateY(-1px)}
    .dl-btn:disabled{opacity:0.4;cursor:not-allowed;transform:none}
    .dl-btn-json{background:#064e3b;color:#6ee7b7;border:1px solid #10b981}
    .dl-btn-csv{background:#1e3a5f;color:#93c5fd;border:1px solid #3b82f6}
    .dl-btn-geojson{background:#312e81;color:#a5b4fc;border:1px solid #6366f1}
    .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center}
    .modal-overlay.active{display:flex}
    .modal-box{background:#1e293b;border:1px solid #334155;border-radius:0.75rem;padding:1.5rem;width:90%;max-width:360px;text-align:center}
    .modal-box h3{color:#ecfdf5;margin-bottom:0.5rem;font-size:1rem}
    .modal-box p{color:#94a3b8;font-size:0.82rem;margin-bottom:1rem}
    .modal-box input{width:100%;padding:0.6rem 0.75rem;background:#0f172a;border:1px solid #334155;border-radius:0.4rem;color:#e2e8f0;font-size:0.85rem;text-align:center;margin-bottom:0.75rem}
    .modal-box input:focus{outline:none;border-color:#10b981}
    .modal-box .modal-err{color:#ef4444;font-size:0.78rem;margin-bottom:0.5rem;display:none}
    .modal-actions{display:flex;gap:0.5rem;justify-content:center}
    .modal-actions button{padding:0.5rem 1.25rem;border-radius:0.4rem;font-size:0.82rem;font-weight:600;cursor:pointer;border:none}
    .modal-cancel{background:#334155;color:#94a3b8}
    .modal-confirm{background:#065f46;color:#ecfdf5;border:1px solid #10b981}
    .analysis-section{padding:0 2rem 1.5rem}
    .analysis-panel{background:linear-gradient(145deg,#151d2e,#1a2438);border-radius:0.75rem;padding:1.25rem;border:1px solid rgba(51,65,85,0.5)}
    .analysis-panel h2{font-size:0.9rem;font-weight:700;color:#94a3b8;margin-bottom:1rem;padding-bottom:0.75rem;border-bottom:1px solid rgba(51,65,85,0.4);text-transform:uppercase;letter-spacing:0.04em}
    .chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .chart-card{background:rgba(10,15,30,0.6);border-radius:0.6rem;padding:1rem;border:1px solid rgba(51,65,85,0.3);transition:border-color 0.3s}
    .chart-card:hover{border-color:rgba(51,65,85,0.6)}
    .chart-card h3{font-size:0.68rem;text-transform:uppercase;color:#64748b;margin-bottom:0.75rem;letter-spacing:0.08em;font-weight:700}
    .chart-body{position:relative;height:250px}
    @media(max-width:768px){
      .config-bar{padding:0.75rem 1rem}
      .cat-tabs{padding:0 1rem}
      .grid{padding:1rem}
      .map-section,.records-section,.download-section,.analysis-section{padding:0 1rem 1rem}
      #live-map{height:300px}
      .chart-grid{grid-template-columns:1fr}
    }
    footer{background:linear-gradient(180deg,#070b16 0%,#0a0f1e 100%);padding:2.5rem 2rem 2rem;color:#475569;font-size:0.78rem;border-top:1px solid rgba(16,185,129,0.2)}
    .footer-grid{display:flex;flex-wrap:wrap;gap:2.5rem;justify-content:space-between;max-width:1200px;margin:0 auto}
    .footer-col h4{color:#64748b;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:0.6rem;font-weight:700}
    .footer-col p,.footer-col a{color:#475569;line-height:1.8;font-size:0.76rem}
    .footer-col a{color:rgba(110,231,183,0.7);text-decoration:none;transition:color 0.2s}
    .footer-col a:hover{color:#6ee7b7}
    .footer-bottom{text-align:center;margin-top:2rem;padding-top:1.25rem;border-top:1px solid rgba(30,41,59,0.5);color:#334155;font-size:0.7rem}
    .footer-bottom strong{color:#475569}
    .footer-coat-of-arms{display:flex;justify-content:center;margin-bottom:1.5rem}
    .footer-coat-of-arms img{height:100px;opacity:0.45}
  </style>
</head>
<body>
  <header>
    <div class="header-row">
      <div class="logo-group">
        <img src="assets/depc-logo.png" alt="DEPC" class="header-logo">
        <span class="logo-dept-name">DEPARTMENT OF ENVIRONMENTAL PROTECTION AND CONSERVATION</span>
      </div>
      <div>
        <h1>DEPC Environmental Dashboard</h1>
        <p>Real-time field data monitoring</p>
      </div>
    </div>
  </header>

  <div class="config-bar">
    <input id="cfg-owner" type="hidden" value="welinrj">
    <input id="cfg-repo" type="hidden" value="merremia-field-data">
    <input id="cfg-token" type="hidden" value="">
    <button onclick="loadFieldData()">Load Data</button>
    <span class="status-msg" id="status-msg"></span>
  </div>

  <div class="cat-tabs" id="cat-tabs">
    <button class="cat-tab t-merremia active" onclick="switchTab('merremia')">Merremia</button>
    <button class="cat-tab t-degraded" onclick="switchTab('degraded')">Degraded Areas</button>
    <button class="cat-tab t-restoration" onclick="switchTab('restoration')">Restoration</button>
    <button class="cat-tab t-threatened" onclick="switchTab('threatened')">Threatened Species</button>
  </div>

  <div class="grid" id="summary-cards">
    <div class="card"><h3 id="s1-label">Field Records</h3><div class="value" id="s1-val">--</div><div class="sub" id="s1-sub">observations collected</div></div>
    <div class="card"><h3 id="s2-label">Total Count</h3><div class="value" id="s2-val">--</div><div class="sub" id="s2-sub">individual sightings</div></div>
    <div class="card"><h3 id="s3-label">Area Surveyed</h3><div class="value" id="s3-val">--</div><div class="sub" id="s3-sub">hectares reported</div></div>
    <div class="card"><h3 id="s4-label">Islands Covered</h3><div class="value" id="s4-val">--</div><div class="sub" id="s4-sub">with field data</div></div>
    <div class="card"><h3 id="s5-label">Latest Record</h3><div class="value" id="s5-val" style="font-size:1.1rem">--</div><div class="sub" id="s5-sub">waiting for data</div></div>
  </div>

  <div class="map-section">
    <div class="map-panel">
      <h2 id="map-title">Field Observation Map</h2>
      <div class="map-wrap">
        <div class="basemap-toggle">
          <button class="basemap-btn active" id="bm-dark" onclick="switchBasemap('dark')">Dark</button>
          <button class="basemap-btn" id="bm-streets" onclick="switchBasemap('streets')">Streets</button>
          <button class="basemap-btn" id="bm-satellite" onclick="switchBasemap('satellite')">Satellite</button>
        </div>
        <div id="live-map"></div>
      </div>
    </div>
  </div>

  <div class="analysis-section">
    <div class="analysis-panel">
      <h2 id="analysis-title">Analysis Report</h2>
      <div class="chart-grid">
        <div class="chart-card"><h3 id="chart1-title">&mdash;</h3><div class="chart-body"><canvas id="chart1"></canvas></div></div>
        <div class="chart-card"><h3 id="chart2-title">&mdash;</h3><div class="chart-body"><canvas id="chart2"></canvas></div></div>
        <div class="chart-card"><h3 id="chart3-title">&mdash;</h3><div class="chart-body"><canvas id="chart3"></canvas></div></div>
        <div class="chart-card"><h3 id="chart4-title">&mdash;</h3><div class="chart-body"><canvas id="chart4"></canvas></div></div>
      </div>
    </div>
  </div>

  <div class="records-section">
    <div class="records-panel">
      <h2 id="table-title">Recent Records</h2>
      <div class="filter-bar" id="filter-bar">
        <select id="filter-1" onchange="applyFilters()"></select>
        <select id="filter-2" onchange="applyFilters()"></select>
        <select id="filter-island" onchange="applyFilters()">
          <option value="">All Islands</option>
        </select>
      </div>
      <div id="records-table">
        <div class="empty">Click "Load Data" to see field-collected records.</div>
      </div>
    </div>
  </div>

  <div class="download-section">
    <div class="download-panel">
      <h2>Download Live Dataset</h2>
      <p>Export the current field-collected data. Password required for access.</p>
      <div class="dl-btns">
        <button class="dl-btn dl-btn-json" id="btn-dl-json" disabled onclick="requestDownload('json')">&#11015; JSON</button>
        <button class="dl-btn dl-btn-csv" id="btn-dl-csv" disabled onclick="requestDownload('csv')">&#11015; CSV</button>
        <button class="dl-btn dl-btn-geojson" id="btn-dl-geojson" disabled onclick="requestDownload('geojson')">&#11015; GeoJSON</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="dl-modal">
    <div class="modal-box">
      <h3>Enter Password</h3>
      <p>A password is required to download live datasets.</p>
      <input type="password" id="dl-password" placeholder="Enter password" onkeydown="if(event.key==='Enter')confirmDownload()">
      <div class="modal-err" id="dl-error">Incorrect password. Try again.</div>
      <div class="modal-actions">
        <button class="modal-cancel" onclick="closeDlModal()">Cancel</button>
        <button class="modal-confirm" onclick="confirmDownload()">Download</button>
      </div>
    </div>
  </div>

  <footer>
    <div class="footer-coat-of-arms">
      <img src="assets/vanuatu-coat-of-arms.png" alt="Coat of Arms of Vanuatu">
    </div>
    <div class="footer-grid">
      <div class="footer-col">
        <h4>Department of Environmental Protection &amp; Conservation</h4>
        <p>Ministry of Climate Change Adaptation, Meteorology &amp; Geo-Hazards,<br>Environment, Energy and Disaster Management</p>
      </div>
      <div class="footer-col">
        <h4>Contact</h4>
        <p>PMB 9063, Port Vila, Shefa Province, Vanuatu<br>Phone: <a href="tel:+67825302">+678 25302</a> / <a href="tel:+67833430">+678 33430</a><br>Email: <a href="mailto:depc@vanuatu.gov.vu">depc@vanuatu.gov.vu</a><br>Web: <a href="https://environment.gov.vu" target="_blank" rel="noopener">environment.gov.vu</a></p>
      </div>
      <div class="footer-col">
        <h4>Branch Office</h4>
        <p>Sanma Provincial Government Council<br>PMB 239, Luganville, Sanma Province, Vanuatu</p>
      </div>
    </div>
    <div class="footer-bottom">Prototype dashboard created by <strong>Spatial Solutions</strong> for <strong>DEPC</strong> &amp; <strong>NBSAP</strong> &mdash; Live Field Data View</div>
  </footer>

  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="merremia-connector.js"></script>
  <script>
    // ── Map ──
    var liveMap = new maplibregl.Map({
      container: 'live-map',
      style: {
        version: 8,
        sources: {
          'carto-dark': { type: 'raster', tiles: ['https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png','https://b.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png'], tileSize: 256, attribution: '&copy; OpenStreetMap &copy; CARTO' },
          'carto-voyager': { type: 'raster', tiles: ['https://a.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}@2x.png','https://b.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}@2x.png'], tileSize: 256, attribution: '&copy; OpenStreetMap &copy; CARTO' },
          'esri-satellite': { type: 'raster', tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'], tileSize: 256, attribution: '&copy; Esri', maxzoom: 19 }
        },
        layers: [
          { id: 'basemap-dark', type: 'raster', source: 'carto-dark' },
          { id: 'basemap-streets', type: 'raster', source: 'carto-voyager', layout: { visibility: 'none' } },
          { id: 'basemap-satellite', type: 'raster', source: 'esri-satellite', layout: { visibility: 'none' } }
        ]
      },
      center: [167.8, -16.5],
      zoom: 6
    });
    liveMap.addControl(new maplibregl.NavigationControl(), 'top-right');
    var mapMarkers = [];
    var activeBasemap = 'dark';

    function switchBasemap(type) {
      var layers = { dark: 'basemap-dark', streets: 'basemap-streets', satellite: 'basemap-satellite' };
      Object.keys(layers).forEach(function(k) {
        liveMap.setLayoutProperty(layers[k], 'visibility', k === type ? 'visible' : 'none');
      });
      activeBasemap = type;
      document.querySelectorAll('.basemap-btn').forEach(function(b) { b.classList.remove('active'); });
      document.getElementById('bm-' + type).classList.add('active');
    }

    // ── State ──
    var activeTab = 'merremia';
    var allRecordsData = [];
    var liveConnector = null;
    var REFRESH_INTERVAL = 5000;
    var lastDataSha = null;

    // Load saved config
    try {
      var saved = JSON.parse(localStorage.getItem('merremia_live_cfg') || '{}');
      if (saved.owner) document.getElementById('cfg-owner').value = saved.owner;
      if (saved.repo) document.getElementById('cfg-repo').value = saved.repo;
      if (saved.token) document.getElementById('cfg-token').value = saved.token;
    } catch(e) {}

    // ── Tab Switching ──
    function switchTab(cat) {
      activeTab = cat;
      document.querySelectorAll('.cat-tab').forEach(function(b) { b.classList.remove('active'); });
      document.querySelector('.cat-tab.t-' + cat).classList.add('active');
      renderForTab();
    }

    // ── Data Loading ──
    async function loadFieldData() {
      var owner = document.getElementById('cfg-owner').value.trim();
      var repo = document.getElementById('cfg-repo').value.trim();
      var token = document.getElementById('cfg-token').value.trim();
      var status = document.getElementById('status-msg');
      if (!owner) { status.textContent = 'Error loading'; status.className = 'status-msg err'; return; }
      localStorage.setItem('merremia_live_cfg', JSON.stringify({ owner: owner, repo: repo, token: token }));
      status.textContent = 'Loading...'; status.className = 'status-msg';
      if (liveConnector) liveConnector.stopAutoRefresh();
      lastDataSha = null;
      liveConnector = new MerremiaConnector({ owner: owner, repo: repo, token: token, cacheTTL: 3000 });
      liveConnector.startAutoRefresh(REFRESH_INTERVAL, function(data) {
        if (!data || !data.records || data.records.length === 0) {
          status.textContent = 'No records found yet — checking every 5s...';
          status.className = 'status-msg err';
          return;
        }
        var now = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        var currentSha = liveConnector._lastSha || '';
        if (currentSha !== lastDataSha) {
          allRecordsData = data.records;
          renderForTab();
          lastDataSha = currentSha;
        }
        enableDownloadButtons(data);
        status.textContent = data.records.length + ' records \u2014 live (' + now + ')';
        status.className = 'status-msg ok';
      });
    }

    // ── Filter records by active tab ──
    function getTabRecords() {
      return allRecordsData.filter(function(r) { return (r.category || 'merremia') === activeTab; });
    }

    // ── Master render ──
    function renderForTab() {
      var records = getTabRecords();
      renderStats(records);
      renderMap(records);
      renderCharts(records);
      renderTable(records);
    }

    // ── Stats per category ──
    function renderStats(records) {
      var islands = {};
      records.forEach(function(r) { if (r.island) islands[r.island] = true; });
      var islandCount = Object.keys(islands).length;
      var latest = records.length > 0 ? records[0] : null;
      var latestDate = latest ? new Date(latest.timestamp).toLocaleDateString('en-GB', { day:'numeric', month:'short' }) : '--';

      if (activeTab === 'merremia') {
        var totalCount = 0, totalArea = 0;
        records.forEach(function(r) { totalCount += (r.count || 1); totalArea += (r.coverageArea || 0); });
        setStats('Field Records', records.length, 'observations', 'Total Count', totalCount.toLocaleString(), 'individual sightings', 'Area Surveyed', totalArea.toLocaleString(), 'hectares', 'Islands', islandCount, 'with data', latestDate, latest ? ((latest.species||[]).join(', ') + ' at ' + (latest.island||'')) : '');
      } else if (activeTab === 'degraded') {
        var totalArea = 0, severe = 0;
        records.forEach(function(r) { totalArea += (r.estimatedArea || 0); if ((r.severity||'').toLowerCase() === 'severe') severe++; });
        setStats('Sites Assessed', records.length, 'locations', 'Total Area', totalArea.toLocaleString(), 'hectares degraded', 'Severe Sites', severe, 'need urgent action', 'Islands', islandCount, 'surveyed', latestDate, latest ? ((latest.degradationType||'') + ' at ' + (latest.island||'')) : '');
      } else if (activeTab === 'restoration') {
        var totalArea = 0, projects = {};
        records.forEach(function(r) { totalArea += (r.estimatedArea || 0); if (r.projectName) projects[r.projectName] = true; });
        setStats('Sites Monitored', records.length, 'locations', 'Total Area', totalArea.toLocaleString(), 'hectares restored', 'Projects', Object.keys(projects).length, 'active programmes', 'Islands', islandCount, 'covered', latestDate, latest ? ((latest.restorationType||'') + ' at ' + (latest.island||'')) : '');
      } else if (activeTab === 'threatened') {
        var speciesMap = {}, cr = 0;
        records.forEach(function(r) { if (r.speciesName) speciesMap[r.speciesName] = true; if ((r.iucnStatus||'') === 'Critically Endangered') cr++; });
        setStats('Species Found', Object.keys(speciesMap).length, 'unique species', 'Sightings', records.length, 'field records', 'Critical', cr, 'critically endangered', 'Islands', islandCount, 'surveyed', latestDate, latest ? ((latest.speciesName||'') + ' at ' + (latest.island||'')) : '');
      }
    }

    function setStats(l1,v1,s1,l2,v2,s2,l3,v3,s3,l4,v4,s4,v5,s5) {
      document.getElementById('s1-label').textContent = l1; document.getElementById('s1-val').textContent = v1; document.getElementById('s1-sub').textContent = s1;
      document.getElementById('s2-label').textContent = l2; document.getElementById('s2-val').textContent = v2; document.getElementById('s2-sub').textContent = s2;
      document.getElementById('s3-label').textContent = l3; document.getElementById('s3-val').textContent = v3; document.getElementById('s3-sub').textContent = s3;
      document.getElementById('s4-label').textContent = l4; document.getElementById('s4-val').textContent = v4; document.getElementById('s4-sub').textContent = s4;
      document.getElementById('s5-val').textContent = v5; document.getElementById('s5-sub').textContent = s5;
    }

    // ── Map rendering ──
    function clearMarkers() { mapMarkers.forEach(function(m) { m.remove(); }); mapMarkers = []; }

    function getMarkerColor(r) {
      var cat = r.category || 'merremia';
      if (cat === 'merremia') { var t = (r.threatLevel||'low').toLowerCase(); return t === 'high' ? '#ef4444' : t === 'moderate' ? '#f59e0b' : '#10b981'; }
      if (cat === 'degraded') { var s = (r.severity||'').toLowerCase(); return s === 'severe' ? '#ef4444' : s === 'moderate' ? '#f59e0b' : '#fbbf24'; }
      if (cat === 'restoration') { var st = (r.restorationStage||'').toLowerCase(); return st.indexOf('mature') >= 0 || st.indexOf('established') >= 0 ? '#10b981' : st.indexOf('mid') >= 0 ? '#3b82f6' : '#818cf8'; }
      if (cat === 'threatened') { var i = (r.iucnStatus||'').toLowerCase(); return i.indexOf('critical') >= 0 ? '#ef4444' : i.indexOf('endangered') >= 0 ? '#f59e0b' : i.indexOf('vulnerable') >= 0 ? '#a855f7' : '#818cf8'; }
      return '#94a3b8';
    }

    function getPhotoHTML(recordId) {
      var owner = document.getElementById('cfg-owner').value.trim();
      var repo = document.getElementById('cfg-repo').value.trim();
      var base = 'https://raw.githubusercontent.com/' + owner + '/' + repo + '/main/photos/';
      var html = '<div class="popup-photos">';
      for (var i = 0; i < 5; i++) {
        html += '<img src="' + base + recordId + '-' + i + '.jpg" onerror="this.style.display=\'none\'" onclick="showFullPhoto(this.src)">';
      }
      return html + '</div>';
    }

    function showFullPhoto(src) {
      var overlay = document.createElement('div');
      overlay.className = 'photo-overlay';
      overlay.innerHTML = '<img src="' + src + '">';
      overlay.onclick = function() { overlay.remove(); };
      document.body.appendChild(overlay);
    }

    function getPopupHTML(r) {
      return getPhotoHTML(r.id);
    }

    function renderMap(records) {
      clearMarkers();
      var mapTitles = { merremia: 'Merremia Observation Map', degraded: 'Degraded Areas Map', restoration: 'Restoration Sites Map', threatened: 'Threatened Species Map' };
      document.getElementById('map-title').textContent = mapTitles[activeTab] || 'Field Observation Map';
      var bounds = new maplibregl.LngLatBounds();
      var hasBounds = false;
      records.forEach(function(r) {
        var lat = r.gps ? r.gps.lat : r.latitude;
        var lng = r.gps ? r.gps.lng : r.longitude;
        if (!lat || !lng) return;
        var el = document.createElement('div');
        el.className = 'map-marker';
        el.style.backgroundColor = getMarkerColor(r);
        var popup = new maplibregl.Popup({ offset: 12, maxWidth: '320px', closeOnClick: false }).setHTML(getPopupHTML(r));
        var marker = new maplibregl.Marker({ element: el }).setLngLat([lng, lat]).setPopup(popup).addTo(liveMap);
        mapMarkers.push(marker);
        bounds.extend([lng, lat]);
        hasBounds = true;
      });
      if (hasBounds) {
        liveMap.fitBounds(bounds, { padding: 50, maxZoom: 14 });
        mapMarkers.forEach(function(m) { m.togglePopup(); });
      }
    }

    // ── Table rendering ──
    var tabRecords = [];

    function renderTable(records) {
      tabRecords = records;
      setupFilters(records);
      applyFilters();
    }

    function setupFilters(records) {
      var f1 = document.getElementById('filter-1');
      var f2 = document.getElementById('filter-2');
      var fi = document.getElementById('filter-island');
      var islands = {};
      records.forEach(function(r) { if (r.island) islands[r.island] = true; });

      if (activeTab === 'merremia') {
        var threats = {}, species = {};
        records.forEach(function(r) {
          var t = (r.threatLevel||'low'); threats[t.charAt(0).toUpperCase()+t.slice(1)] = true;
          var sp = Array.isArray(r.species) ? r.species : [r.species||'']; sp.forEach(function(s) { if (s) species[s] = true; });
        });
        fillSelect(f1, 'All Threats', Object.keys(threats).sort());
        fillSelect(f2, 'All Species', Object.keys(species).sort());
      } else if (activeTab === 'degraded') {
        var types = {}, sevs = {};
        records.forEach(function(r) { if (r.degradationType) types[r.degradationType] = true; if (r.severity) sevs[r.severity] = true; });
        fillSelect(f1, 'All Severities', Object.keys(sevs).sort());
        fillSelect(f2, 'All Types', Object.keys(types).sort());
      } else if (activeTab === 'restoration') {
        var types = {}, stages = {};
        records.forEach(function(r) { if (r.restorationType) types[r.restorationType] = true; if (r.restorationStage) stages[r.restorationStage] = true; });
        fillSelect(f1, 'All Stages', Object.keys(stages).sort());
        fillSelect(f2, 'All Types', Object.keys(types).sort());
      } else if (activeTab === 'threatened') {
        var statuses = {}, types = {};
        records.forEach(function(r) { if (r.iucnStatus) statuses[r.iucnStatus] = true; if (r.speciesType) types[r.speciesType] = true; });
        fillSelect(f1, 'All IUCN Status', Object.keys(statuses).sort());
        fillSelect(f2, 'All Types', Object.keys(types).sort());
      }
      fillSelect(fi, 'All Islands', Object.keys(islands).sort());
    }

    function fillSelect(el, allLabel, values) {
      var current = el.value;
      el.innerHTML = '<option value="">' + allLabel + '</option>' + values.map(function(v) { return '<option value="' + v + '">' + v + '</option>'; }).join('');
      if (current && values.indexOf(current) >= 0) el.value = current;
    }

    function applyFilters() {
      var v1 = document.getElementById('filter-1').value;
      var v2 = document.getElementById('filter-2').value;
      var vi = document.getElementById('filter-island').value;

      var filtered = tabRecords.filter(function(r) {
        if (vi && r.island !== vi) return false;
        if (activeTab === 'merremia') {
          if (v1 && (r.threatLevel||'low').toLowerCase() !== v1.toLowerCase()) return false;
          if (v2) { var sp = Array.isArray(r.species) ? r.species : [r.species||'']; if (sp.indexOf(v2) < 0) return false; }
        } else if (activeTab === 'degraded') {
          if (v1 && r.severity !== v1) return false;
          if (v2 && r.degradationType !== v2) return false;
        } else if (activeTab === 'restoration') {
          if (v1 && r.restorationStage !== v1) return false;
          if (v2 && r.restorationType !== v2) return false;
        } else if (activeTab === 'threatened') {
          if (v1 && r.iucnStatus !== v1) return false;
          if (v2 && r.speciesType !== v2) return false;
        }
        return true;
      });

      var sorted = filtered.slice().sort(function(a, b) { return new Date(b.timestamp) - new Date(a.timestamp); });
      var shown = sorted.slice(0, 50);
      var tableTitles = { merremia: 'Merremia Records', degraded: 'Degraded Area Records', restoration: 'Restoration Records', threatened: 'Threatened Species Records' };
      document.getElementById('table-title').textContent = tableTitles[activeTab] || 'Records';
      var rows = shown.map(function(r) { return buildRow(r); }).join('');
      var headers = buildHeaders();
      var notes = '';
      if (sorted.length > 50) notes += '<p style="text-align:center;color:#64748b;font-size:0.75rem;margin-top:0.5rem">Showing 50 of ' + sorted.length + '</p>';
      if (v1 || v2 || vi) notes += '<p style="text-align:center;color:#94a3b8;font-size:0.75rem;margin-top:0.25rem">' + filtered.length + ' of ' + tabRecords.length + ' records</p>';
      document.getElementById('records-table').innerHTML = '<div class="table-scroll"><table><thead><tr>' + headers + '</tr></thead><tbody>' + rows + '</tbody></table></div>' + notes;
    }

    function buildHeaders() {
      if (activeTab === 'merremia') return '<th>Date</th><th>Island</th><th>Site</th><th>Species</th><th>Count</th><th>Threat</th><th>Area (ha)</th><th>Observer</th>';
      if (activeTab === 'degraded') return '<th>Date</th><th>Island</th><th>Site</th><th>Type</th><th>Severity</th><th>Area (ha)</th><th>Land Use</th><th>Observer</th>';
      if (activeTab === 'restoration') return '<th>Date</th><th>Island</th><th>Site</th><th>Type</th><th>Stage</th><th>Area (ha)</th><th>Project</th><th>Observer</th>';
      if (activeTab === 'threatened') return '<th>Date</th><th>Island</th><th>Site</th><th>Species</th><th>IUCN</th><th>Pop.</th><th>Habitat</th><th>Observer</th>';
      return '';
    }

    function buildRow(r) {
      var d = new Date(r.timestamp).toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric' });
      if (activeTab === 'merremia') {
        var t = (r.threatLevel||'low').toLowerCase();
        var bc = t === 'high' ? 'badge-high' : t === 'moderate' ? 'badge-moderate' : 'badge-low';
        var sp = Array.isArray(r.species) ? r.species.join(', ') : (r.species || '-');
        return '<tr><td>' + d + '</td><td>' + (r.island||'-') + '</td><td>' + (r.siteName||'-') + '</td><td><em>' + sp + '</em></td><td>' + (r.count||1) + '</td><td><span class="badge ' + bc + '">' + (r.threatLevel||'Low') + '</span></td><td>' + (r.coverageArea||'-') + '</td><td>' + (r.observer||'-') + '</td></tr>';
      }
      if (activeTab === 'degraded') {
        var sv = (r.severity||'').toLowerCase();
        var bc = sv === 'severe' ? 'badge-severe' : sv === 'moderate' ? 'badge-moderate' : 'badge-mild';
        return '<tr><td>' + d + '</td><td>' + (r.island||'-') + '</td><td>' + (r.siteName||'-') + '</td><td>' + (r.degradationType||'-') + '</td><td><span class="badge ' + bc + '">' + (r.severity||'-') + '</span></td><td>' + (r.estimatedArea||'-') + '</td><td>' + (r.landUseType||'-') + '</td><td>' + (r.observer||'-') + '</td></tr>';
      }
      if (activeTab === 'restoration') {
        var st = (r.restorationStage||'').toLowerCase();
        var bc = st.indexOf('mature') >= 0 || st.indexOf('established') >= 0 ? 'badge-established' : st.indexOf('mid') >= 0 ? 'badge-mid' : 'badge-planning';
        return '<tr><td>' + d + '</td><td>' + (r.island||'-') + '</td><td>' + (r.siteName||'-') + '</td><td>' + (r.restorationType||'-') + '</td><td><span class="badge ' + bc + '">' + (r.restorationStage||'-') + '</span></td><td>' + (r.estimatedArea||'-') + '</td><td>' + (r.projectName||'-') + '</td><td>' + (r.observer||'-') + '</td></tr>';
      }
      if (activeTab === 'threatened') {
        var iu = (r.iucnStatus||'').toLowerCase();
        var bc = iu.indexOf('critical') >= 0 ? 'badge-cr' : iu.indexOf('endangered') >= 0 ? 'badge-en' : iu.indexOf('vulnerable') >= 0 ? 'badge-vu' : iu.indexOf('near') >= 0 ? 'badge-nt' : 'badge-dd';
        return '<tr><td>' + d + '</td><td>' + (r.island||'-') + '</td><td>' + (r.siteName||'-') + '</td><td><em>' + (r.speciesName||'-') + '</em></td><td><span class="badge ' + bc + '">' + (r.iucnStatus||'-') + '</span></td><td>' + (r.populationEstimate||'-') + '</td><td>' + (r.habitatType||'-') + '</td><td>' + (r.observer||'-') + '</td></tr>';
      }
      return '';
    }

    // ── Chart rendering ──
    var chart1 = null, chart2 = null, chart3 = null, chart4 = null;
    var chartPalette = ['#10b981','#3b82f6','#f59e0b','#ef4444','#a855f7','#06b6d4','#ec4899','#84cc16','#f97316','#6366f1'];

    function barOpts(horizontal) {
      var o = {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { color: 'rgba(51,65,85,0.5)' }, ticks: { color: '#94a3b8', font: { size: 10 } } },
          y: { grid: { color: 'rgba(51,65,85,0.5)' }, ticks: { color: '#94a3b8', font: { size: 10 } } }
        }
      };
      if (horizontal) o.indexAxis = 'y';
      return o;
    }
    function lineOpts() {
      return {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { color: 'rgba(51,65,85,0.5)' }, ticks: { color: '#94a3b8', font: { size: 10 } } },
          y: { grid: { color: 'rgba(51,65,85,0.5)' }, ticks: { color: '#94a3b8', font: { size: 10 } }, beginAtZero: true }
        }
      };
    }
    var doughnutOpts = {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { position: 'right', labels: { color: '#94a3b8', font: { size: 11 }, padding: 10, usePointStyle: true } } }
    };

    function destroyCharts() {
      [chart1, chart2, chart3, chart4].forEach(function(c) { if (c) c.destroy(); });
      chart1 = chart2 = chart3 = chart4 = null;
    }

    function countBy(records, key) {
      var m = {};
      records.forEach(function(r) { var k = r[key] || 'Unknown'; m[k] = (m[k] || 0) + 1; });
      return Object.entries(m).sort(function(a, b) { return b[1] - a[1]; });
    }
    function sumBy(records, groupKey, sumKey) {
      var m = {};
      records.forEach(function(r) { var k = r[groupKey] || 'Unknown'; m[k] = (m[k] || 0) + (r[sumKey] || 0); });
      return Object.entries(m).sort(function(a, b) { return b[1] - a[1]; });
    }

    function renderCharts(records) {
      destroyCharts();
      var titles = { merremia: 'Merremia Analysis Report', degraded: 'Degraded Areas Analysis Report', restoration: 'Restoration Analysis Report', threatened: 'Threatened Species Analysis Report' };
      document.getElementById('analysis-title').textContent = titles[activeTab] || 'Analysis Report';
      if (records.length === 0) return;

      if (activeTab === 'merremia') renderMerremiaCharts(records);
      else if (activeTab === 'degraded') renderDegradedCharts(records);
      else if (activeTab === 'restoration') renderRestorationCharts(records);
      else if (activeTab === 'threatened') renderThreatenedCharts(records);
    }

    function renderMerremiaCharts(records) {
      // 1: Observations by Island
      document.getElementById('chart1-title').textContent = 'Observations by Island';
      var byIsland = {};
      records.forEach(function(r) { var k = r.island || 'Unknown'; byIsland[k] = (byIsland[k] || 0) + (r.count || 1); });
      var si = Object.entries(byIsland).sort(function(a, b) { return b[1] - a[1]; });
      chart1 = new Chart(document.getElementById('chart1').getContext('2d'), {
        type: 'bar',
        data: { labels: si.map(function(e) { return e[0]; }), datasets: [{ data: si.map(function(e) { return e[1]; }), backgroundColor: '#10b981', borderRadius: 4 }] },
        options: barOpts()
      });

      // 2: Threat Breakdown
      document.getElementById('chart2-title').textContent = 'Threat Level Breakdown';
      var threats = { High: 0, Moderate: 0, Low: 0 };
      records.forEach(function(r) { var t = (r.threatLevel || 'low').toLowerCase(); if (t === 'high') threats.High++; else if (t === 'moderate') threats.Moderate++; else threats.Low++; });
      chart2 = new Chart(document.getElementById('chart2').getContext('2d'), {
        type: 'doughnut',
        data: { labels: Object.keys(threats), datasets: [{ data: Object.values(threats), backgroundColor: ['#ef4444', '#f59e0b', '#10b981'] }] },
        options: doughnutOpts
      });

      // 3: Species Distribution
      document.getElementById('chart3-title').textContent = 'Species Distribution';
      var sp = {};
      records.forEach(function(r) { var arr = Array.isArray(r.species) ? r.species : [r.species || 'Unknown']; arr.forEach(function(s) { sp[s] = (sp[s] || 0) + (r.count || 1); }); });
      var ss = Object.entries(sp).sort(function(a, b) { return b[1] - a[1]; });
      chart3 = new Chart(document.getElementById('chart3').getContext('2d'), {
        type: 'bar',
        data: { labels: ss.map(function(e) { return e[0]; }), datasets: [{ data: ss.map(function(e) { return e[1]; }), backgroundColor: chartPalette.slice(0, ss.length), borderRadius: 4 }] },
        options: barOpts(true)
      });

      // 4: Collection Timeline
      document.getElementById('chart4-title').textContent = 'Collection Timeline';
      var tl = {};
      records.forEach(function(r) { var d = new Date(r.timestamp); var k = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0'); tl[k] = (tl[k] || 0) + 1; });
      var st = Object.entries(tl).sort(function(a, b) { return a[0].localeCompare(b[0]); });
      chart4 = new Chart(document.getElementById('chart4').getContext('2d'), {
        type: 'line',
        data: { labels: st.map(function(e) { return e[0]; }), datasets: [{ data: st.map(function(e) { return e[1]; }), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', fill: true, tension: 0.3, pointBackgroundColor: '#10b981', pointRadius: 4, borderWidth: 2 }] },
        options: lineOpts()
      });
    }

    function renderDegradedCharts(records) {
      // 1: Sites by Island
      document.getElementById('chart1-title').textContent = 'Sites by Island';
      var si = countBy(records, 'island');
      chart1 = new Chart(document.getElementById('chart1').getContext('2d'), {
        type: 'bar',
        data: { labels: si.map(function(e) { return e[0]; }), datasets: [{ data: si.map(function(e) { return e[1]; }), backgroundColor: '#ef4444', borderRadius: 4 }] },
        options: barOpts()
      });

      // 2: Severity Breakdown
      document.getElementById('chart2-title').textContent = 'Severity Breakdown';
      var sv = countBy(records, 'severity');
      var sevColors = { Severe: '#ef4444', Moderate: '#f59e0b', Mild: '#fcd34d', Unknown: '#94a3b8' };
      chart2 = new Chart(document.getElementById('chart2').getContext('2d'), {
        type: 'doughnut',
        data: { labels: sv.map(function(e) { return e[0]; }), datasets: [{ data: sv.map(function(e) { return e[1]; }), backgroundColor: sv.map(function(e) { return sevColors[e[0]] || '#94a3b8'; }) }] },
        options: doughnutOpts
      });

      // 3: Degradation Type
      document.getElementById('chart3-title').textContent = 'Degradation Type';
      var dt = countBy(records, 'degradationType');
      chart3 = new Chart(document.getElementById('chart3').getContext('2d'), {
        type: 'bar',
        data: { labels: dt.map(function(e) { return e[0]; }), datasets: [{ data: dt.map(function(e) { return e[1]; }), backgroundColor: chartPalette.slice(0, dt.length), borderRadius: 4 }] },
        options: barOpts(true)
      });

      // 4: Area by Land Use
      document.getElementById('chart4-title').textContent = 'Area by Land Use (ha)';
      var lu = sumBy(records, 'landUseType', 'estimatedArea');
      chart4 = new Chart(document.getElementById('chart4').getContext('2d'), {
        type: 'bar',
        data: { labels: lu.map(function(e) { return e[0]; }), datasets: [{ data: lu.map(function(e) { return e[1]; }), backgroundColor: '#f59e0b', borderRadius: 4 }] },
        options: barOpts()
      });
    }

    function renderRestorationCharts(records) {
      // 1: Sites by Island
      document.getElementById('chart1-title').textContent = 'Sites by Island';
      var si = countBy(records, 'island');
      chart1 = new Chart(document.getElementById('chart1').getContext('2d'), {
        type: 'bar',
        data: { labels: si.map(function(e) { return e[0]; }), datasets: [{ data: si.map(function(e) { return e[1]; }), backgroundColor: '#3b82f6', borderRadius: 4 }] },
        options: barOpts()
      });

      // 2: Restoration Stage
      document.getElementById('chart2-title').textContent = 'Restoration Stage';
      var sg = countBy(records, 'restorationStage');
      chart2 = new Chart(document.getElementById('chart2').getContext('2d'), {
        type: 'doughnut',
        data: { labels: sg.map(function(e) { return e[0]; }), datasets: [{ data: sg.map(function(e) { return e[1]; }), backgroundColor: ['#818cf8', '#6366f1', '#3b82f6', '#10b981', '#064e3b', '#94a3b8'] }] },
        options: doughnutOpts
      });

      // 3: Restoration Type
      document.getElementById('chart3-title').textContent = 'Restoration Type';
      var rt = countBy(records, 'restorationType');
      chart3 = new Chart(document.getElementById('chart3').getContext('2d'), {
        type: 'bar',
        data: { labels: rt.map(function(e) { return e[0]; }), datasets: [{ data: rt.map(function(e) { return e[1]; }), backgroundColor: chartPalette.slice(0, rt.length), borderRadius: 4 }] },
        options: barOpts(true)
      });

      // 4: Area by Project
      document.getElementById('chart4-title').textContent = 'Area by Project (ha)';
      var pa = sumBy(records, 'projectName', 'estimatedArea');
      chart4 = new Chart(document.getElementById('chart4').getContext('2d'), {
        type: 'bar',
        data: { labels: pa.map(function(e) { return e[0]; }), datasets: [{ data: pa.map(function(e) { return e[1]; }), backgroundColor: '#93c5fd', borderRadius: 4 }] },
        options: barOpts()
      });
    }

    function renderThreatenedCharts(records) {
      // 1: Sightings by Island
      document.getElementById('chart1-title').textContent = 'Sightings by Island';
      var si = countBy(records, 'island');
      chart1 = new Chart(document.getElementById('chart1').getContext('2d'), {
        type: 'bar',
        data: { labels: si.map(function(e) { return e[0]; }), datasets: [{ data: si.map(function(e) { return e[1]; }), backgroundColor: '#a855f7', borderRadius: 4 }] },
        options: barOpts()
      });

      // 2: IUCN Status
      document.getElementById('chart2-title').textContent = 'IUCN Status Breakdown';
      var iu = countBy(records, 'iucnStatus');
      var iucnColors = { 'Critically Endangered': '#ef4444', 'Endangered': '#f59e0b', 'Vulnerable': '#a855f7', 'Near Threatened': '#3b82f6', 'Data Deficient': '#94a3b8', 'Unknown': '#64748b' };
      chart2 = new Chart(document.getElementById('chart2').getContext('2d'), {
        type: 'doughnut',
        data: { labels: iu.map(function(e) { return e[0]; }), datasets: [{ data: iu.map(function(e) { return e[1]; }), backgroundColor: iu.map(function(e) { return iucnColors[e[0]] || '#94a3b8'; }) }] },
        options: doughnutOpts
      });

      // 3: Species Type
      document.getElementById('chart3-title').textContent = 'Species Type Distribution';
      var tp = countBy(records, 'speciesType');
      chart3 = new Chart(document.getElementById('chart3').getContext('2d'), {
        type: 'bar',
        data: { labels: tp.map(function(e) { return e[0]; }), datasets: [{ data: tp.map(function(e) { return e[1]; }), backgroundColor: chartPalette.slice(0, tp.length), borderRadius: 4 }] },
        options: barOpts()
      });

      // 4: Habitat Distribution
      document.getElementById('chart4-title').textContent = 'Habitat Distribution';
      var hb = countBy(records, 'habitatType');
      chart4 = new Chart(document.getElementById('chart4').getContext('2d'), {
        type: 'doughnut',
        data: { labels: hb.map(function(e) { return e[0]; }), datasets: [{ data: hb.map(function(e) { return e[1]; }), backgroundColor: chartPalette.slice(0, hb.length) }] },
        options: doughnutOpts
      });
    }

    // ── Download functionality ──
    var DOWNLOAD_PASSWORD = 'M3r3mia@2025';
    var pendingFormat = null;
    var currentGeoJSON = null;

    function enableDownloadButtons(data) {
      currentGeoJSON = data.geoJSON;
      document.getElementById('btn-dl-json').disabled = false;
      document.getElementById('btn-dl-csv').disabled = false;
      document.getElementById('btn-dl-geojson').disabled = false;
    }

    function requestDownload(format) {
      if (!allRecordsData || allRecordsData.length === 0) return;
      pendingFormat = format;
      document.getElementById('dl-password').value = '';
      document.getElementById('dl-error').style.display = 'none';
      document.getElementById('dl-modal').classList.add('active');
      document.getElementById('dl-password').focus();
    }

    function closeDlModal() { document.getElementById('dl-modal').classList.remove('active'); pendingFormat = null; }

    function confirmDownload() {
      var pw = document.getElementById('dl-password').value;
      if (pw !== DOWNLOAD_PASSWORD) { document.getElementById('dl-error').style.display = 'block'; document.getElementById('dl-password').value = ''; document.getElementById('dl-password').focus(); return; }
      document.getElementById('dl-error').style.display = 'none';
      var format = pendingFormat || 'json';
      closeDlModal();
      var ts = new Date().toISOString().slice(0,10);
      var blob, filename;
      if (format === 'json') {
        blob = new Blob([JSON.stringify(allRecordsData, null, 2)], { type: 'application/json' });
        filename = 'vanuatu-field-data-' + ts + '.json';
      } else if (format === 'csv') {
        blob = new Blob([recordsToCSV(allRecordsData)], { type: 'text/csv' });
        filename = 'vanuatu-field-data-' + ts + '.csv';
      } else if (format === 'geojson') {
        blob = new Blob([JSON.stringify(currentGeoJSON, null, 2)], { type: 'application/geo+json' });
        filename = 'vanuatu-field-data-' + ts + '.geojson';
      }
      var url = URL.createObjectURL(blob); var a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    function recordsToCSV(records) {
      var headers = ['id','timestamp','category','island','siteName','observer','latitude','longitude','accuracy','notes','species','count','threatLevel','coverageArea','degradationType','severity','estimatedArea','landUseType','vegetationCover','erosionEvidence','cause','waterNearby','restorationType','restorationStage','yearsSinceStarted','projectName','survivalRate','speciesName','speciesType','iucnStatus','populationEstimate','habitatType','breedingEvidence','threatsObserved'];
      var rows = records.map(function(r) {
        return headers.map(function(h) {
          var v = r[h] != null ? String(r[h]) : '';
          if (h === 'latitude') v = r.gps ? String(r.gps.lat||'') : v;
          if (h === 'longitude') v = r.gps ? String(r.gps.lng||'') : v;
          if (h === 'accuracy') v = r.gps ? String(r.gps.accuracy||'') : v;
          if (h === 'species' && Array.isArray(r.species)) v = r.species.join('; ');
          return '"' + v.replace(/"/g, '""') + '"';
        }).join(',');
      });
      return headers.join(',') + '\n' + rows.join('\n');
    }

    document.getElementById('dl-modal').addEventListener('click', function(e) { if (e.target === this) closeDlModal(); });

    if (document.getElementById('cfg-owner').value) { setTimeout(loadFieldData, 300); }
  </script>
</body>
</html>
