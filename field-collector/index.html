<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#065f46">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Merremia Field Collector</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh;min-height:100dvh;display:flex;flex-direction:column}
    header{background:linear-gradient(135deg,#065f46,#064e3b);padding:1rem 1.25rem;border-bottom:2px solid #10b981;display:flex;align-items:center;justify-content:space-between}
    header h1{font-size:1.1rem;color:#ecfdf5}
    header .subtitle{font-size:0.7rem;color:#6ee7b7}
    .header-btns{display:flex;gap:0.5rem}
    .icon-btn{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#ecfdf5;width:36px;height:36px;border-radius:0.4rem;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.1rem}
    .icon-btn.active{background:#10b981;border-color:#34d399}
    nav{display:flex;background:#1e293b;border-bottom:1px solid #334155}
    nav button{flex:1;padding:0.75rem;background:none;border:none;border-bottom:2px solid transparent;color:#94a3b8;font-size:0.8rem;font-weight:600;cursor:pointer}
    nav button.active{color:#34d399;border-bottom-color:#10b981;background:rgba(16,185,129,0.05)}
    .view{display:none;flex:1;overflow-y:auto;padding:1rem}
    .view.active{display:flex;flex-direction:column;gap:1rem}
    .field-group{background:#1e293b;border-radius:0.75rem;padding:1rem;border:1px solid #334155}
    .field-group label{display:block;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.05em;color:#94a3b8;margin-bottom:0.4rem}
    .field-group input,.field-group select,.field-group textarea{width:100%;padding:0.6rem;background:#0f172a;border:1px solid #334155;border-radius:0.4rem;color:#e2e8f0;font-size:0.9rem}
    .field-group textarea{height:80px;resize:vertical}
    .field-group select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 0.6rem center}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem}
    .gps-display{display:flex;align-items:center;gap:0.5rem;padding:0.5rem;background:#0f172a;border-radius:0.4rem;font-size:0.85rem;border:1px solid #334155}
    .gps-display .coord{color:#34d399;font-family:monospace;font-weight:600}
    .gps-display .accuracy{color:#f59e0b;font-size:0.75rem}
    .btn{padding:0.75rem 1.5rem;border-radius:0.5rem;border:none;font-size:0.95rem;font-weight:700;cursor:pointer;width:100%;transition:all 0.2s}
    .btn-primary{background:linear-gradient(135deg,#065f46,#047857);color:#ecfdf5;border:2px solid #10b981;box-shadow:0 0 10px rgba(16,185,129,0.3)}
    .btn-primary:active{transform:scale(0.98)}
    .btn-primary:disabled{opacity:0.4}
    .btn-danger{background:#7f1d1d;color:#fca5a5;border:1px solid #ef4444}
    .btn-secondary{background:#334155;color:#e2e8f0;border:1px solid #475569}
    .photo-btn{display:flex;align-items:center;justify-content:center;gap:0.5rem;padding:1.5rem;border:2px dashed #334155;border-radius:0.75rem;background:#0f172a;color:#94a3b8;cursor:pointer;font-size:0.9rem}
    .photo-btn:active{border-color:#10b981;color:#10b981}
    .photo-preview{display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:0.5rem}
    .photo-preview img{width:60px;height:60px;object-fit:cover;border-radius:0.4rem;border:1px solid #334155}
    .record-card{background:#1e293b;border-radius:0.75rem;padding:1rem;border:1px solid #334155;margin-bottom:0.5rem}
    .record-card{position:relative}
    .record-card h4{color:#34d399;font-size:0.9rem;margin-bottom:0.25rem}
    .btn-delete-record{position:absolute;top:0.75rem;right:0.75rem;background:#7f1d1d;color:#fca5a5;border:1px solid #ef4444;border-radius:0.35rem;padding:0.25rem 0.6rem;font-size:0.7rem;font-weight:600;cursor:pointer}
    .btn-delete-record:hover{background:#991b1b}
    .delete-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9998;display:flex;align-items:center;justify-content:center}
    .delete-modal{background:#1e293b;border:1px solid #334155;border-radius:0.75rem;padding:1.5rem;max-width:340px;width:90%;z-index:9999}
    .delete-modal h3{color:#ef4444;font-size:1rem;margin-bottom:0.75rem}
    .delete-modal p{color:#94a3b8;font-size:0.85rem;margin-bottom:1rem}
    .delete-modal input{width:100%;padding:0.6rem;background:#0f172a;border:1px solid #334155;border-radius:0.4rem;color:#e2e8f0;font-size:0.9rem;margin-bottom:1rem}
    .delete-modal-btns{display:flex;gap:0.5rem}
    .delete-modal-btns button{flex:1;padding:0.6rem;border-radius:0.4rem;font-weight:600;cursor:pointer;border:none;font-size:0.85rem}
    .record-card p{color:#94a3b8;font-size:0.8rem;line-height:1.5}
    .record-card .meta{display:flex;gap:0.75rem;margin-top:0.5rem;font-size:0.7rem;color:#64748b}
    .badge-sm{display:inline-block;padding:0.1rem 0.4rem;border-radius:9999px;font-size:0.65rem;font-weight:600}
    .badge-pending{background:#78350f;color:#fcd34d}
    .badge-synced{background:#064e3b;color:#6ee7b7}
    .empty-state{text-align:center;padding:3rem 1rem;color:#64748b}
    .empty-state .icon{font-size:3rem;margin-bottom:1rem}
    .settings-field{margin-bottom:1rem}
    .settings-field label{display:block;font-size:0.8rem;color:#94a3b8;margin-bottom:0.3rem}
    .settings-field input{width:100%;padding:0.6rem;background:#0f172a;border:1px solid #334155;border-radius:0.4rem;color:#e2e8f0;font-size:0.85rem}
    .sync-status{text-align:center;padding:1rem;background:#1e293b;border-radius:0.75rem;border:1px solid #334155;margin-bottom:1rem}
    .sync-status .count{font-size:2rem;font-weight:700;color:#f59e0b}
    .sync-status .label{font-size:0.8rem;color:#94a3b8}
    .offline-banner{background:#78350f;color:#fcd34d;text-align:center;padding:0.4rem;font-size:0.75rem;font-weight:600;display:none}
    .offline-banner.show{display:block}
    input[type="file"]{display:none}
    .toast{position:fixed;top:60px;left:50%;transform:translateX(-50%);padding:0.75rem 1.25rem;border-radius:0.5rem;font-size:0.85rem;font-weight:600;z-index:9999;animation:slideDown 0.3s ease;max-width:90%}
    .toast-info{background:#1e293b;color:#34d399;border:1px solid #10b981}
    .toast-warn{background:#78350f;color:#fcd34d;border:1px solid #f59e0b}
    .toast-error{background:#7f1d1d;color:#fca5a5;border:1px solid #ef4444}
    @keyframes slideDown{from{opacity:0;transform:translateX(-50%) translateY(-20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
  </style>
</head>
<body>
  <div class="offline-banner" id="offline-banner">OFFLINE MODE — data saved locally</div>
  <header>
    <div>
      <h1>Merremia Field Collector</h1>
      <div class="subtitle">Vanuatu Spatial Solutions — DEPC &amp; NBSAP</div>
    </div>
    <div class="header-btns">
      <button class="icon-btn" id="btn-sync" onclick="syncData()" title="Sync data">&#8635;</button>
    </div>
  </header>

  <nav>
    <button class="active" onclick="showView('collect')" id="nav-collect">Collect</button>
    <button onclick="showView('records')" id="nav-records">Records <span id="record-count"></span></button>
    <button onclick="showView('settings')" id="nav-settings">Settings</button>
  </nav>

  <!-- ═══ COLLECT VIEW ═══ -->
  <div class="view active" id="view-collect">
    <div class="field-group">
      <label>GPS Location</label>
      <div class="gps-display" id="gps-display">
        <span>&#128205;</span>
        <span class="coord" id="gps-coords">Acquiring...</span>
        <span class="accuracy" id="gps-accuracy"></span>
      </div>
    </div>

    <div class="row">
      <div class="field-group">
        <label>Island</label>
        <select id="f-island">
          <option value="">Select island</option>
          <option>Efate</option>
          <option>Espiritu Santo</option>
          <option>Tanna</option>
          <option>Malakula</option>
          <option>Pentecost</option>
          <option>Ambae</option>
          <option>Erromango</option>
          <option>Epi</option>
          <option>Other</option>
        </select>
      </div>
      <div class="field-group">
        <label>Site Name</label>
        <input id="f-site" placeholder="e.g. Mele Bay">
      </div>
    </div>

    <div class="row">
      <div class="field-group">
        <label>Species</label>
        <select id="f-species">
          <option value="">Select species</option>
          <option>M. peltata</option>
          <option>M. vitifolia</option>
          <option>M. tridentata</option>
          <option>M. gemella</option>
          <option>M. umbellata</option>
          <option>M. tuberosa</option>
          <option>M. dissecta</option>
          <option>Unknown Merremia</option>
        </select>
      </div>
      <div class="field-group">
        <label>Observation Count</label>
        <input id="f-count" type="number" min="1" value="1">
      </div>
    </div>

    <div class="row">
      <div class="field-group">
        <label>Threat Level</label>
        <select id="f-threat">
          <option value="">Select level</option>
          <option>High</option>
          <option>Moderate</option>
          <option>Low</option>
        </select>
      </div>
      <div class="field-group">
        <label>Coverage Area (ha)</label>
        <input id="f-area" type="number" min="0" step="0.1" placeholder="0.0">
      </div>
    </div>

    <div class="field-group">
      <label>Observer Name</label>
      <input id="f-observer" placeholder="Your name">
    </div>

    <div class="field-group">
      <label>Photos</label>
      <div class="photo-btn" onclick="document.getElementById('photo-input').click()">
        &#128247; Tap to add photos
      </div>
      <input type="file" id="photo-input" accept="image/*" capture="environment" multiple onchange="handlePhotos(event)">
      <div class="photo-preview" id="photo-preview"></div>
    </div>

    <div class="field-group">
      <label>Notes</label>
      <textarea id="f-notes" placeholder="Additional observations, habitat type, nearby landmarks..."></textarea>
    </div>

    <button class="btn btn-primary" onclick="saveRecord()" id="btn-save">Save Observation</button>
  </div>

  <!-- ═══ RECORDS VIEW ═══ -->
  <div class="view" id="view-records">
    <div class="sync-status">
      <div class="count" id="pending-count">0</div>
      <div class="label">records pending sync</div>
    </div>
    <button class="btn btn-secondary" onclick="syncData()" style="margin-bottom:0.5rem">Sync All to GitHub</button>
    <button class="btn btn-secondary" onclick="downloadRecords()" style="margin-bottom:1rem;background:#1e3a5f;border-color:#3b82f6">Download Records (JSON)</button>
    <button class="btn btn-secondary" onclick="downloadCSV()" style="margin-bottom:1rem;background:#1e3a5f;border-color:#3b82f6">Download Records (CSV)</button>
    <div id="records-list"></div>
  </div>

  <!-- ═══ SETTINGS VIEW ═══ -->
  <div class="view" id="view-settings">
    <div class="field-group">
      <h3 style="color:#34d399;font-size:0.95rem;margin-bottom:0.75rem">GitHub Sync Settings</h3>
      <div class="settings-field">
        <label>GitHub Owner (username)</label>
        <input id="s-owner" placeholder="your-username" value="welinrj">
      </div>
      <div class="settings-field">
        <label>Data Repository</label>
        <input id="s-repo" value="merremia-field-data">
      </div>
      <div class="settings-field">
        <label>Personal Access Token</label>
        <input id="s-token" type="password" placeholder="Pre-configured">
      </div>
      <button class="btn btn-secondary" onclick="saveSettings()" style="margin-bottom:1rem">Save Settings</button>
    </div>

    <div class="field-group">
      <h3 style="color:#34d399;font-size:0.95rem;margin-bottom:0.75rem">Default Observer</h3>
      <div class="settings-field">
        <label>Name</label>
        <input id="s-observer" placeholder="Your name">
      </div>
      <button class="btn btn-secondary" onclick="saveDefaultObserver()">Save Default</button>
    </div>

    <div class="field-group" style="margin-top:1rem">
      <h3 style="color:#ef4444;font-size:0.95rem;margin-bottom:0.75rem">Danger Zone</h3>
      <button class="btn btn-danger" onclick="clearAllData()">Clear All Local Data</button>
    </div>
  </div>

  <script>
    // ── State ──
    var DB_KEY = 'merremia_records';
    var SETTINGS_KEY = 'merremia_settings';
    var currentPhotos = [];
    var currentLat = null, currentLng = null, currentAcc = null;

    // ── Toast Notifications ──
    function showToast(msg, type) {
      type = type || 'info';
      var existing = document.querySelector('.toast');
      if (existing) existing.remove();
      var el = document.createElement('div');
      el.className = 'toast toast-' + type;
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(function() { el.remove(); }, 3500);
    }

    // ── Views ──
    function showView(name) {
      document.querySelectorAll('.view').forEach(function(v) { v.classList.remove('active'); });
      document.querySelectorAll('nav button').forEach(function(b) { b.classList.remove('active'); });
      document.getElementById('view-' + name).classList.add('active');
      document.getElementById('nav-' + name).classList.add('active');
      if (name === 'records') renderRecords();
    }

    // ── GPS ──
    function startGPS() {
      if (!navigator.geolocation) {
        document.getElementById('gps-coords').textContent = 'GPS not available';
        return;
      }
      navigator.geolocation.watchPosition(
        function(pos) {
          currentLat = pos.coords.latitude;
          currentLng = pos.coords.longitude;
          currentAcc = Math.round(pos.coords.accuracy);
          document.getElementById('gps-coords').textContent = currentLat.toFixed(6) + ', ' + currentLng.toFixed(6);
          document.getElementById('gps-accuracy').textContent = '\u00b1' + currentAcc + 'm';
        },
        function(err) {
          document.getElementById('gps-coords').textContent = 'GPS error: ' + err.message;
        },
        { enableHighAccuracy: true, maximumAge: 10000 }
      );
    }
    startGPS();

    // ── Photos ──
    function handlePhotos(e) {
      var files = Array.from(e.target.files);
      files.forEach(function(file) {
        var reader = new FileReader();
        reader.onload = function(ev) {
          // Compress to max 800px wide JPEG
          var img = new Image();
          img.onload = function() {
            var canvas = document.createElement('canvas');
            var maxW = 800;
            var scale = Math.min(1, maxW / img.width);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
            var dataUrl = canvas.toDataURL('image/jpeg', 0.7);
            currentPhotos.push(dataUrl);
            renderPhotoPreview();
          };
          img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    function renderPhotoPreview() {
      var el = document.getElementById('photo-preview');
      el.innerHTML = currentPhotos.map(function(p) { return '<img src="' + p + '">'; }).join('');
    }

    // ── Save Record ──
    function saveRecord() {
      var island = document.getElementById('f-island').value;
      var species = document.getElementById('f-species').value;
      var threat = document.getElementById('f-threat').value;
      if (!island || !species || !threat) {
        showToast('Please fill in Island, Species, and Threat Level.', 'warn');
        return;
      }
      if (currentLat === null) {
        showToast('Waiting for GPS fix. Try again in a moment.', 'warn');
        return;
      }

      var record = {
        id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
        timestamp: new Date().toISOString(),
        latitude: currentLat,
        longitude: currentLng,
        accuracy: currentAcc,
        island: island,
        siteName: document.getElementById('f-site').value || '',
        species: species,
        count: parseInt(document.getElementById('f-count').value) || 1,
        threatLevel: threat,
        coverageArea: parseFloat(document.getElementById('f-area').value) || 0,
        observer: document.getElementById('f-observer').value || getSettings().defaultObserver || '',
        notes: document.getElementById('f-notes').value || '',
        photos: currentPhotos,
        synced: false
      };

      var records = getRecords();
      records.push(record);
      localStorage.setItem(DB_KEY, JSON.stringify(records));

      // Reset form
      document.getElementById('f-site').value = '';
      document.getElementById('f-count').value = '1';
      document.getElementById('f-area').value = '';
      document.getElementById('f-notes').value = '';
      currentPhotos = [];
      renderPhotoPreview();
      document.getElementById('photo-input').value = '';
      updateRecordCount();

      showToast('Observation saved! (' + records.length + ' total)', 'info');
    }

    // ── Records ──
    function getRecords() {
      try { return JSON.parse(localStorage.getItem(DB_KEY)) || []; }
      catch(e) { return []; }
    }

    function updateRecordCount() {
      var records = getRecords();
      var pending = records.filter(function(r) { return !r.synced; }).length;
      var el = document.getElementById('record-count');
      if (records.length > 0) el.textContent = '(' + records.length + ')';
      else el.textContent = '';
      var pc = document.getElementById('pending-count');
      if (pc) pc.textContent = pending;
    }

    function renderRecords() {
      var records = getRecords().reverse();
      var list = document.getElementById('records-list');
      updateRecordCount();
      if (records.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="icon">&#127793;</div><p>No observations yet.<br>Go to Collect to add your first record.</p></div>';
        return;
      }
      list.innerHTML = records.map(function(r) {
        var date = new Date(r.timestamp).toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' });
        var badge = r.synced ? '<span class="badge-sm badge-synced">Synced</span>' : '<span class="badge-sm badge-pending">Pending</span>';
        return '<div class="record-card"><button class="btn-delete-record" onclick="promptDeleteRecord(\'' + r.id + '\')">Delete</button><h4>' + r.species + ' ' + badge + '</h4><p>' + r.island + (r.siteName ? ' \u2014 ' + r.siteName : '') + '</p><div class="meta"><span>' + date + '</span><span>Count: ' + r.count + '</span><span>Threat: ' + r.threatLevel + '</span>' + (r.photos && r.photos.length ? '<span>' + r.photos.length + ' photo(s)</span>' : '') + '</div></div>';
      }).join('');
    }

    // ── Settings ──
    var _tp = ['Z2l0aHViX3BhdF8xMUFQNlc1NlEwUnN','lRVFCWXlyV2RyX2U0enMxQ3ZiNWFiVX','ZSYnp0aEozbmhqRDhlUU5XV1VDQ0hkM','HFleEZ2VnU1Qk9CSldISjlZYXVVcTla'];
    var DEFAULTS = { owner: 'welinrj', repo: 'merremia-field-data', token: atob(_tp.join('')) };
    var DELETE_PASSWORD = 'M3r3mia@2025';

    function getSettings() {
      try { return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {}; }
      catch(e) { return {}; }
    }

    function saveSettings() {
      var settings = getSettings();
      settings.owner = document.getElementById('s-owner').value.trim();
      settings.repo = document.getElementById('s-repo').value.trim();
      settings.token = document.getElementById('s-token').value.trim();
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      showToast('Settings saved!', 'info');
    }

    function saveDefaultObserver() {
      var settings = getSettings();
      settings.defaultObserver = document.getElementById('s-observer').value.trim();
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      document.getElementById('f-observer').value = settings.defaultObserver;
      showToast('Default observer saved!', 'info');
    }

    function loadSettings() {
      var s = getSettings();
      // Seed all defaults on first load so sync works without manual config
      if (!s.owner || !s.token) {
        s.owner = s.owner || DEFAULTS.owner;
        s.repo = s.repo || DEFAULTS.repo;
        s.token = s.token || DEFAULTS.token;
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
      }
      document.getElementById('s-owner').value = s.owner || DEFAULTS.owner;
      document.getElementById('s-repo').value = s.repo || DEFAULTS.repo;
      document.getElementById('s-token').value = s.token || DEFAULTS.token;
      if (s.defaultObserver) {
        document.getElementById('s-observer').value = s.defaultObserver;
        document.getElementById('f-observer').value = s.defaultObserver;
      }
    }

    // ── Sync to GitHub ──
    async function syncData() {
      var s = getSettings();
      s.owner = s.owner || document.getElementById('s-owner').value.trim() || DEFAULTS.owner;
      s.repo = s.repo || document.getElementById('s-repo').value.trim() || DEFAULTS.repo;
      s.token = s.token || document.getElementById('s-token').value.trim();
      if (!s.token) {
        showToast('Enter a GitHub Personal Access Token in Settings to sync', 'warn');
        showView('settings');
        return;
      }

      var records = getRecords();
      var pending = records.filter(function(r) { return !r.synced; });
      if (pending.length === 0) { showToast('All records are synced!', 'info'); return; }

      var btn = document.getElementById('btn-sync');
      btn.classList.add('active');

      try {
        for (var i = 0; i < records.length; i++) {
          if (records[i].synced) continue;
          var r = records[i];

          // Upload record JSON
          var recordContent = btoa(unescape(encodeURIComponent(JSON.stringify(r, function(key, val) {
            if (key === 'photos') return undefined; // strip photos from record JSON
            return val;
          }, 2))));

          await fetch('https://api.github.com/repos/' + s.owner + '/' + s.repo + '/contents/records/' + r.id + '.json', {
            method: 'PUT',
            headers: {
              'Authorization': 'Bearer ' + s.token,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              message: 'Add record: ' + r.species + ' at ' + r.island,
              content: recordContent
            })
          });

          // Upload photos
          if (r.photos) {
            for (var j = 0; j < r.photos.length; j++) {
              var photoData = r.photos[j].split(',')[1];
              await fetch('https://api.github.com/repos/' + s.owner + '/' + s.repo + '/contents/photos/' + r.id + '-' + j + '.jpg', {
                method: 'PUT',
                headers: {
                  'Authorization': 'Bearer ' + s.token,
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  message: 'Add photo for ' + r.id,
                  content: photoData
                })
              });
            }
          }

          records[i].synced = true;
        }

        localStorage.setItem(DB_KEY, JSON.stringify(records));
        updateRecordCount();
        if (document.getElementById('view-records').classList.contains('active')) renderRecords();

        // Update aggregated all-records.json for the live dashboard
        await updateAllRecords(s, records);

        showToast('Synced ' + pending.length + ' record(s) to GitHub!', 'info');
      } catch(err) {
        showToast('Sync error — records saved locally. Try again later.', 'error');
      }

      btn.classList.remove('active');
    }

    // ── Update aggregated data file for live dashboard ──
    async function updateAllRecords(s, localRecords) {
      try {
        // Fetch existing all-records.json (may not exist yet)
        var allRecords = [];
        var existingSha = null;
        var getResp = await fetch('https://api.github.com/repos/' + s.owner + '/' + s.repo + '/contents/data/all-records.json', {
          headers: { 'Authorization': 'Bearer ' + s.token, 'Accept': 'application/vnd.github.v3+json' }
        });
        if (getResp.ok) {
          var existing = await getResp.json();
          existingSha = existing.sha;
          allRecords = JSON.parse(atob(existing.content.replace(/\n/g, '')));
        }

        // Merge: add/update records by ID
        var syncedLocal = localRecords.filter(function(r) { return r.synced; });
        syncedLocal.forEach(function(r) {
          var clean = Object.assign({}, r);
          delete clean.photos;
          var idx = allRecords.findIndex(function(x) { return x.id === r.id; });
          if (idx >= 0) allRecords[idx] = clean;
          else allRecords.push(clean);
        });

        // Upload aggregated file
        var content = btoa(unescape(encodeURIComponent(JSON.stringify(allRecords, null, 2))));
        var body = { message: 'Update all-records.json (' + allRecords.length + ' records)', content: content };
        if (existingSha) body.sha = existingSha;

        await fetch('https://api.github.com/repos/' + s.owner + '/' + s.repo + '/contents/data/all-records.json', {
          method: 'PUT',
          headers: { 'Authorization': 'Bearer ' + s.token, 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
      } catch(e) {
        console.warn('Could not update all-records.json:', e);
      }
    }

    // ── Download Records ──
    function downloadRecords() {
      var records = getRecords();
      if (records.length === 0) { showToast('No records to download', 'warn'); return; }
      var clean = records.map(function(r) {
        var copy = Object.assign({}, r);
        delete copy.photos; // strip base64 photo data for smaller file
        return copy;
      });
      var blob = new Blob([JSON.stringify(clean, null, 2)], { type: 'application/json' });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'merremia-records-' + new Date().toISOString().slice(0, 10) + '.json';
      a.click();
      URL.revokeObjectURL(a.href);
      showToast('Downloaded ' + records.length + ' record(s)', 'info');
    }

    function downloadCSV() {
      var records = getRecords();
      if (records.length === 0) { showToast('No records to download', 'warn'); return; }
      var headers = ['id','timestamp','latitude','longitude','accuracy','island','siteName','species','count','threatLevel','coverageArea','observer','notes','synced'];
      var rows = records.map(function(r) {
        return headers.map(function(h) {
          var v = r[h] != null ? String(r[h]) : '';
          return '"' + v.replace(/"/g, '""') + '"';
        }).join(',');
      });
      var csv = headers.join(',') + '\n' + rows.join('\n');
      var blob = new Blob([csv], { type: 'text/csv' });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'merremia-records-' + new Date().toISOString().slice(0, 10) + '.csv';
      a.click();
      URL.revokeObjectURL(a.href);
      showToast('Downloaded ' + records.length + ' record(s) as CSV', 'info');
    }

    // ── Delete Single Record (password-protected) ──
    var pendingDeleteId = null;

    function promptDeleteRecord(id) {
      pendingDeleteId = id;
      var overlay = document.createElement('div');
      overlay.className = 'delete-modal-overlay';
      overlay.id = 'delete-modal-overlay';
      overlay.innerHTML = '<div class="delete-modal">' +
        '<h3>Delete Record</h3>' +
        '<p>This will permanently delete this record locally and from GitHub. Enter the admin password to confirm.</p>' +
        '<input type="password" id="delete-password" placeholder="Enter password">' +
        '<div class="delete-modal-btns">' +
          '<button style="background:#334155;color:#e2e8f0" onclick="closeDeleteModal()">Cancel</button>' +
          '<button style="background:#7f1d1d;color:#fca5a5" onclick="confirmDeleteRecord()">Delete</button>' +
        '</div></div>';
      document.body.appendChild(overlay);
      setTimeout(function() { document.getElementById('delete-password').focus(); }, 100);
    }

    function closeDeleteModal() {
      pendingDeleteId = null;
      var m = document.getElementById('delete-modal-overlay');
      if (m) m.remove();
    }

    async function confirmDeleteRecord() {
      var pw = document.getElementById('delete-password').value;
      if (pw !== DELETE_PASSWORD) {
        showToast('Incorrect password', 'error');
        return;
      }
      closeDeleteModal();

      var records = getRecords();
      var record = records.find(function(r) { return r.id === pendingDeleteId; });
      if (!record) { showToast('Record not found', 'error'); return; }

      // Remove from GitHub if synced
      if (record.synced) {
        var s = getSettings();
        s.token = s.token || DEFAULTS.token;
        try {
          // Delete the record file
          var getResp = await fetch('https://api.github.com/repos/' + s.owner + '/' + s.repo + '/contents/records/' + record.id + '.json', {
            headers: { 'Authorization': 'Bearer ' + s.token, 'Accept': 'application/vnd.github.v3+json' }
          });
          if (getResp.ok) {
            var fileData = await getResp.json();
            await fetch('https://api.github.com/repos/' + s.owner + '/' + s.repo + '/contents/records/' + record.id + '.json', {
              method: 'DELETE',
              headers: { 'Authorization': 'Bearer ' + s.token, 'Content-Type': 'application/json' },
              body: JSON.stringify({ message: 'Delete record: ' + record.species + ' at ' + record.island, sha: fileData.sha })
            });
          }

          // Delete any photos
          for (var j = 0; j < 5; j++) {
            var photoResp = await fetch('https://api.github.com/repos/' + s.owner + '/' + s.repo + '/contents/photos/' + record.id + '-' + j + '.jpg', {
              headers: { 'Authorization': 'Bearer ' + s.token, 'Accept': 'application/vnd.github.v3+json' }
            });
            if (photoResp.ok) {
              var photoData = await photoResp.json();
              await fetch('https://api.github.com/repos/' + s.owner + '/' + s.repo + '/contents/photos/' + record.id + '-' + j + '.jpg', {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + s.token, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: 'Delete photo for ' + record.id, sha: photoData.sha })
              });
            } else break;
          }

          // Update all-records.json
          var remaining = records.filter(function(r) { return r.id !== pendingDeleteId && r.synced; });
          var cleanRemaining = remaining.map(function(r) { var c = Object.assign({}, r); delete c.photos; return c; });
          await updateAllRecordsFromList(s, cleanRemaining);
        } catch(e) {
          showToast('Error deleting from GitHub — removed locally only', 'warn');
        }
      }

      // Remove locally
      records = records.filter(function(r) { return r.id !== pendingDeleteId; });
      localStorage.setItem(DB_KEY, JSON.stringify(records));
      pendingDeleteId = null;
      updateRecordCount();
      renderRecords();
      showToast('Record deleted', 'info');
    }

    async function updateAllRecordsFromList(s, cleanRecords) {
      try {
        var existingSha = null;
        var getResp = await fetch('https://api.github.com/repos/' + s.owner + '/' + s.repo + '/contents/data/all-records.json', {
          headers: { 'Authorization': 'Bearer ' + s.token, 'Accept': 'application/vnd.github.v3+json' }
        });
        if (getResp.ok) {
          var existing = await getResp.json();
          existingSha = existing.sha;
        }
        var content = btoa(unescape(encodeURIComponent(JSON.stringify(cleanRecords, null, 2))));
        var body = { message: 'Update all-records.json (' + cleanRecords.length + ' records)', content: content };
        if (existingSha) body.sha = existingSha;
        await fetch('https://api.github.com/repos/' + s.owner + '/' + s.repo + '/contents/data/all-records.json', {
          method: 'PUT',
          headers: { 'Authorization': 'Bearer ' + s.token, 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
      } catch(e) { console.warn('Could not update all-records.json:', e); }
    }

    // ── Clear Data ──
    function clearAllData() {
      var pw = prompt('Enter admin password to clear all data:');
      if (pw !== DELETE_PASSWORD) {
        if (pw !== null) showToast('Incorrect password', 'error');
        return;
      }
      localStorage.removeItem(DB_KEY);
      updateRecordCount();
      renderRecords();
      showToast('All local data cleared.', 'info');
    }

    // ── Offline Detection ──
    function updateOnlineStatus() {
      var el = document.getElementById('offline-banner');
      if (!navigator.onLine) el.classList.add('show');
      else el.classList.remove('show');
    }
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();

    // ── Service Worker ──
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(function(){});
    }

    // ── Init ──
    loadSettings();
    updateRecordCount();
  </script>
</body>
</html>
